<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="icon" type="image/png" href="https://uploads.onecompiler.io/43u4wb3ft/4452q4hvx/KomikoAIolog%20(1).jpg">
    <title>FOXANIME - Xem Anime Miễn Phí</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const RELOAD_INTERVAL = 15000;
        function checkTailwindLoadAndShowFallback() {
            let isTailwindLoaded = false;
            try {
                const testEl = document.createElement('div');
                testEl.className = 'opacity-100'; 
                testEl.style.display = 'none';
                document.body.appendChild(testEl);
                const computedStyle = window.getComputedStyle(testEl);
                isTailwindLoaded = computedStyle.opacity === '1'; 
                document.body.removeChild(testEl);
            } catch (e) {console.error("Lỗi khi kiểm tra Tailwind:", e);}
            if (!isTailwindLoaded) {
                const overlay = document.getElementById('cdn-failure-overlay');
                if (overlay) overlay.style.display = 'flex';
                const mainApp = document.getElementById('app');
                if (mainApp) mainApp.style.display = 'none'; 
                const header = document.querySelector('header');
                if (header) header.style.display = 'none'; 
                console.warn(`[CDN ERROR] Tailwind failed to load. Initiating self-healing reload loop in ${RELOAD_INTERVAL/1000}s.`);
                setTimeout(() => {location.reload();}, RELOAD_INTERVAL);
            }
        }
        window.addEventListener('load', () => {setTimeout(checkTailwindLoadAndShowFallback, 300);});
    </script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="module">
        // === FIREBASE IMPORTS AND SETUP ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, Timestamp, serverTimestamp, writeBatch, increment, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const FIREBASE_DEFAULT_CONFIG = {"apiKey": "AIzaSyDvI4bfJXh08biyFORz6X2xwBc19TERWEc", "authDomain": "foxanime-e77d4.firebaseapp.com","projectId": "foxanime-e77d4", "storageBucket": "foxanime-e77d4.firebasestorage.app", "messagingSenderId": "1025177423292", "appId": "1:1025177423292:web:14c200fbc905e79b3c6fb9"};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        const finalConfig = firebaseConfigFromCanvas?.projectId ? firebaseConfigFromCanvas : FIREBASE_DEFAULT_CONFIG;
        let app, db, auth;
        let userId = null; let userEmail = null; let dataCollectionPath, userLikesCollectionPath, userRoleCollectionPath; 
        let isAuthInitialised = false; let globalMovieCache = []; let unsubscribeCommentsListener = null; 
        let currentUserLikeDocIds = {}; let setupError = null; let isGlobalCacheLoaded = false; 
        let resolveResumeModal; let unsubscribeMovieListener = null; let currentUserReviewCache = null; 
        let unsubscribeReviewListener = null; let unsubscribePublicReviewsListener = null; 
        const COMMENT_LIMIT = 20; const COMMENT_DISPLAY_LIMIT = 10; const REVIEW_DISPLAY_LIMIT = 10;
        
        const getEl = (selector) => document.querySelector(selector);
        const getAllEl = (selector) => document.querySelectorAll(selector);

        const updatePaths = (currentUserId) => {
            if (!appId && appId !== '') {console.error("FATAL: appId is not defined. Path creation failed.");setupError = new Error("Lỗi Cấu hình: appId không hợp lệ.");return;}
            const safeUserId = currentUserId || 'guest';
            dataCollectionPath = `artifacts/${appId}/public/data/movies`; 
            userLikesCollectionPath = `artifacts/${appId}/users/${safeUserId}/likes`;
            userRoleCollectionPath = `artifacts/${appId}/users`; 
        };
        updatePaths(null);
        
        const isGoogleAuth = (userFromCallback = null) => {
             const user = userFromCallback || auth?.currentUser; 
             return user && user.providerData.some(p => p.providerId === 'google.com');
        };
        const BANNED_WORDS = ["đụ", "cặc", "lồn", "buồi", "địt", "mẹ mày", "đm", "dcm", "cc", "chó chết", "súc vật", "phản động", "kích war", "xuyên tạc", "tự tử", "chết đi", "đánh nhau", "chia rẽ", "phá hoại", "vô học", "thằng ngu", "con điên", "chửi", "bố láo", "cút", "biến", "đồ khốn", "khốn nạn", "sản", "ngu xuẩn", "óc chó", "thiếu văn minh", "fuck", "shit"];
        
        const isCommentProfane = (content) => {
            const normalizedContent = content.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, 'd').replace(/Đ/g, 'd').replace(/[^a-z0-9\s]/g, ""); 
            for (const word of BANNED_WORDS) {
                const normalizedBannedWord = word.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, 'd').replace(/Đ/g, 'd');
                if (normalizedContent.includes(normalizedBannedWord.replace(/\s+/g, '')) || content.toLowerCase().includes(word.toLowerCase())) return true;
            }
            return false;
        };

        const createSlug = (text) => {
            if (!text) return '';
            return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, 'd').replace(/Đ/g, 'D').replace(/[^a-z0-9\s-]/g, "").trim().replace(/\s+/g, '-').replace(/-+/g, '-'); 
        };

        const formatCommentDate = (dateObj) => {
            if (!dateObj) return 'Vừa xong';
            let date;
            if (typeof dateObj.toDate === 'function') date = dateObj.toDate(); 
            else if (dateObj instanceof Date) date = dateObj;
            else if (typeof dateObj === 'number') date = new Date(dateObj);
            else if (typeof dateObj === 'string') date = new Date(dateObj);
            else return 'Không xác định';
            if (isNaN(date.getTime())) return 'Lỗi ngày tháng';
            return date.toLocaleString('vi-VN');
        };
        
        window.showResumeModal = (movieTitle, time) => {
            const modal = getEl('#resume-modal');
            const minutes = Math.floor(time / 60);
            const seconds = Math.floor(time % 60);
            getEl('#resume-modal-text').textContent = `Bạn đã xem "${movieTitle}" đến ${minutes} phút ${seconds} giây. Bạn có muốn xem tiếp không?`;
            modal.classList.remove('hidden'); modal.classList.add('flex');
            return new Promise(resolve => { resolveResumeModal = resolve; });
        };
        window.hideResumeModal = () => {
            const modal = getEl('#resume-modal');
            modal.classList.add('hidden'); modal.classList.remove('flex'); resolveResumeModal = null;
        };
        
        const saveWatchTime = (episodeId, time) => {
            if (episodeId && time >= 5 && (Date.now() - parseInt(localStorage.getItem(`_lastSave_${episodeId}`) || '0') > 30000)) {
                localStorage.setItem(`_watchTime_${episodeId}`, time);
                localStorage.setItem(`_lastSave_${episodeId}`, Date.now());
            }
        };
        
        const deleteOldestComments = async (movieId, comments) => {
            if (comments.length > COMMENT_LIMIT) {
                comments.sort((a, b) => {
                     const timeA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                     const timeB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                     return timeA - timeB;
                });
                const commentsToDelete = comments.slice(0, comments.length - COMMENT_LIMIT);
                const batch = writeBatch(db);
                const commentsColRef = collection(db, dataCollectionPath, movieId, 'comments');
                commentsToDelete.forEach(comment => {batch.delete(doc(commentsColRef, comment.id));});
                try {
                    await batch.commit();
                    console.log(`Đã xóa ${commentsToDelete.length} bình luận cũ nhất cho phim ${movieId}.`);
                } catch (e) {console.error("Lỗi khi xóa bình luận cũ:", e);}
            }
        };

        const setupCommentsListener = (movieId) => {
            if (unsubscribeCommentsListener) { unsubscribeCommentsListener(); unsubscribeCommentsListener = null; }
            const commentsColRef = collection(db, dataCollectionPath, movieId, 'comments');
            const commentsQuery = query(commentsColRef); 
            unsubscribeCommentsListener = onSnapshot(commentsQuery, (snapshot) => {
                const updatedComments = [];
                snapshot.forEach(doc => {updatedComments.push({ id: doc.id, ...doc.data() });});
                updatedComments.sort((a, b) => {
                    const timeA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const timeB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return timeB - timeA;
                });
                deleteOldestComments(movieId, updatedComments); 
                const displayedComments = updatedComments.slice(0, COMMENT_DISPLAY_LIMIT);
                const commentsListElement = getEl('#comments-list');
                const commentCountElement = getEl('#comment-count-display');
                if (commentCountElement) commentCountElement.textContent = updatedComments.length;
                if (commentsListElement) {
                    commentsListElement.innerHTML = `
                        <div class="max-h-96 overflow-y-auto comments-scroll-area">
                            ${displayedComments.length > 0
                                ? displayedComments.map(CommentTemplate).join('')
                                : '<p class="text-gray-500 text-center">Chưa có bình luận nào. Hãy là người đầu tiên!</p>'
                            }
                            ${updatedComments.length > COMMENT_DISPLAY_LIMIT ? `<p class="text-gray-500 text-center pt-2 text-sm italic">...Đã ẩn ${updatedComments.length - COMMENT_DISPLAY_LIMIT} bình luận cũ hơn để tối ưu hiệu suất.</p>` : ''}
                        </div>
                    `;
                }
            }, (error) => {
                console.error("Lỗi listener bình luận:", error);
                const commentsListElement = getEl('#comments-list');
                if (commentsListElement) {commentsListElement.innerHTML = '<p class="text-red-400 text-center">Lỗi tải bình luận. Vui lòng kiểm tra kết nối/quyền.</p>';}
            });
        };

        const incrementViewCount = async (movieId) => {
            const viewedKey = `viewed_${movieId}`;
            if (!sessionStorage.getItem(viewedKey)) {
                try {
                    if (db && dataCollectionPath) { 
                         const movieDocRef = doc(db, dataCollectionPath, movieId);
                         await updateDoc(movieDocRef, { viewCount: increment(1) });
                         sessionStorage.setItem(viewedKey, 'true');
                    }
                } catch (e) { console.error("Lỗi khi tăng lượt xem:", e); }
            }
        };

        const getYoutubeEmbedUrl = (url) => {
            const OFFICIAL_ORIGIN = 'https://foxanime.vercel.app'; 
            try {
                const urlObj = new URL(url);
                const videoId = urlObj.searchParams.get('v') || (urlObj.hostname === 'youtu.be' ? urlObj.pathname.substring(1) : null);
                if (videoId) { return `https://www.youtube.com/embed/${videoId}?rel=0&enablejsapi=1&origin=${OFFICIAL_ORIGIN}&modestbranding=1&autoplay=1`; }
            } catch (e) {}
            return null;
        };
        
        const getGoogleDriveEmbedUrl = (url) => {
             try {
                const urlObj = new URL(url);
                let fileId = '';
                if (urlObj.pathname.startsWith('/file/d/')) { fileId = urlObj.pathname.split('/')[3]; } 
                else if (urlObj.pathname.startsWith('/uc')) { fileId = urlObj.searchParams.get('id'); }
                if (fileId) { return `https://drive.google.com/file/d/${fileId}/preview`; }
            } catch (e) {}
            return null; 
        };
        
        const getStreamEmbedUrl = (url) => {
             try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('streamc.xyz')) {
                    let finalUrl = url.includes('?') ? `${url}&autoplay=1&auto=1&allowautoplay=1` : `${url}?autoplay=1&auto=1&allowautoplay=1`;
                    return finalUrl; 
                }
            } catch (e) {}
            return null; 
        };

        const getVideoPlayer = (videoUrl, posterUrl) => {
            const youtubeEmbedUrl = getYoutubeEmbedUrl(videoUrl);
            const googleDriveEmbedUrl = getGoogleDriveEmbedUrl(videoUrl);
            const streamEmbedUrl = getStreamEmbedUrl(videoUrl);
            let html = ''; let isHtml5Video = false; let finalSrc = ''; let isYoutube = false; let isStreamEmbed = false; 

            if (youtubeEmbedUrl) {
                 finalSrc = youtubeEmbedUrl; isYoutube = true;
            } else if (googleDriveEmbedUrl) {
                finalSrc = googleDriveEmbedUrl;
            } else if (streamEmbedUrl) {
                 finalSrc = streamEmbedUrl; isStreamEmbed = true; 
            } else {
                 html = `<video id="video-player-element" controls class="w-full h-full" src="${videoUrl}" poster="${posterUrl}" playsinline disablepictureinpicture controlsList="nodownload nofullscreen">Trình duyệt của bạn không hỗ trợ thẻ video.</video>`;
                 isHtml5Video = true;
            }
            
            if (finalSrc) {
                 const srcAttr = isStreamEmbed ? '' : `src="${finalSrc}"`; 
                 const dataSrcAttr = isStreamEmbed ? `data-stream-src="${finalSrc}"` : '';
                 const sandboxAttr = isStreamEmbed ? `sandbox="allow-scripts allow-same-origin allow-popups"` : `allow="autoplay; fullscreen"`; 
                 const allowAttr = isStreamEmbed ? `allow="autoplay"` : `allow="autoplay; fullscreen"`;

                 html = `<iframe id="video-player-iframe" class="w-full h-full" ${srcAttr} title="Video player" frameborder="0" ${allowAttr} allowfullscreen disablepictureinpicture ${isYoutube ? 'data-is-youtube="true"' : ''} ${dataSrcAttr} ${isStreamEmbed ? sandboxAttr : ''}></iframe>`;
            }
            return {html, isHtml5Video};
        };

        const handlePlayVideo = (e) => {
            e.preventDefault();
            const overlay = getEl('#video-overlay');
            if (!overlay) return;
            overlay.classList.add('fade-out');
            const videoElement = getEl('#video-player-element');
            const iframeElement = getEl('#video-player-iframe');
            
            if (videoElement) {
                videoElement.play().catch(e => console.error("Lỗi tự động phát video HTML5:", e));
            } else if (iframeElement) {
                const streamSrc = iframeElement.dataset.streamSrc;
                if (streamSrc && !iframeElement.src) {
                     iframeElement.src = streamSrc;
                     console.log("[STREAMC] Kích hoạt tải video bằng user gesture.");
                }
                const frameSrc = iframeElement.src;
                if (frameSrc.includes('youtube.com/embed')) {
                    setTimeout(() => {
                        const message = JSON.stringify({'event': 'command', 'func': 'playVideo'});
                        try {iframeElement.contentWindow.postMessage(message, '*');} catch (e) {console.error("Lỗi gửi postMessage tới YouTube:", e);}
                    }, 100);
                }
            }
            setTimeout(() => { overlay.remove(); }, 500); 
        };

        const handleGoogleLogin = async () => {
            if (!auth) return;
            const errorElement = getEl('#auth-error');
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithPopup(auth, new GoogleAuthProvider()); 
                window.location.hash = '#home'; 
            } catch (error) {
                console.error("Lỗi đăng nhập Google:", error);
                if (errorElement) errorElement.textContent = `Lỗi Google: ${error.message}`;
            }
        };

        const handleLogout = (e) => { 
             e.preventDefault();
             if (!auth) return;
            signOut(auth).catch(error => console.error("Lỗi đăng xuất:", error));
        };
        
        const fetchUserLikes = async (shouldRerender = false) => { 
            if (!auth?.currentUser || !db) { currentUserLikeDocIds = {}; return; } 
            try {
                const q = query(collection(db, userLikesCollectionPath)); 
                onSnapshot(q, (snapshot) => {
                    const likes = {};
                    snapshot.forEach(doc => { likes[doc.data().movieId] = doc.id; });
                    currentUserLikeDocIds = likes;
                    const hash = window.location.hash;
                    if (shouldRerender || hash.startsWith('#library') || hash.startsWith('#phim')) router(false); 
                }, (error) => { console.error("Lỗi khi theo dõi danh sách likes:", error); });
            } catch (e) { console.error("Lỗi khi tải danh sách likes:", e); }
        };
        
        const handleLike = async (e) => { 
             if (!db || !auth?.currentUser) { window.location.hash = '#login'; return; } 
             const button = e.currentTarget;
             const movieId = button.dataset.movieId;
            button.disabled = true;
            const isLiked = !!currentUserLikeDocIds[movieId];
            const movieDocRef = doc(db, dataCollectionPath, movieId);
            try {
                const batch = writeBatch(db);
                const userLikesColRef = collection(db, `artifacts/${appId}/users/${userId}/likes`);
                let newLikeDocRef = null;

                if (isLiked) {
                    const likeDocId = currentUserLikeDocIds[movieId];
                    if (!likeDocId) throw new Error("Không tìm thấy Like ID trong cache.");
                    batch.delete(doc(userLikesColRef, likeDocId));
                    batch.update(movieDocRef, { likeCount: increment(-1) });
                } else {
                    newLikeDocRef = doc(userLikesColRef);
                    batch.set(newLikeDocRef, { movieId: movieId, userId: auth.currentUser.uid, createdAt: serverTimestamp() });
                    batch.update(movieDocRef, { likeCount: increment(1) });
                }
                await batch.commit();
                if (isLiked) {delete currentUserLikeDocIds[movieId];} else {currentUserLikeDocIds[movieId] = newLikeDocRef.id;}
            } catch (e) {
                console.error("[LIKE ERROR] Thao tác Firebase thất bại:", e);
            } finally {
                button.disabled = false;
            }
        };

        const handleCommentSubmit = async (e) => { 
             e.preventDefault();
             
             const user = auth.currentUser;
             // VULNERABILITY FIX: Kiểm tra rõ ràng người dùng phải là Google Auth và không ẩn danh
             if (!db || !user || user.isAnonymous || !isGoogleAuth(user)) { 
                 console.error("Người dùng chưa đăng nhập hợp lệ (chỉ chấp nhận Google Auth) để bình luận."); 
                 window.location.hash = '#login'; 
                 return; 
             }

            const input = getEl('#comment-input');
            const errorEl = getEl('#comment-error');
            const content = input.value.trim();

            errorEl.classList.add('hidden');
            if (!content) return;
            
            if (isCommentProfane(content)) {
                errorEl.textContent = "Nội dung bình luận chứa từ ngữ thô tục/kích war. Vui lòng chỉnh sửa.";
                errorEl.classList.remove('hidden'); return; 
            }

            const [path, slugIdParam] = window.location.hash.substring(1).split('/');
            const movieIdMatch = slugIdParam?.match(/-([a-zA-Z0-9]+)$/);
            const movieId = movieIdMatch ? movieIdMatch[1] : null; 
            if (!movieId) return;
            
            const commentsColRef = collection(db, dataCollectionPath, movieId, 'comments'); 

            try {
                await addDoc(commentsColRef, {
                    content: content,
                    userId: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0], 
                    photoURL: user.photoURL, 
                    createdAt: serverTimestamp()
                });
                input.value = '';
            } catch (e) {
                console.error("Lỗi khi gửi bình luận:", e);
                errorEl.textContent = "Lỗi khi gửi bình luận. Vui lòng kiểm tra Rules hoặc đăng nhập lại.";
                errorEl.classList.remove('hidden');
            }
        };
        
        const globalCommentSubmitHandler = (e) => {
            if (e.target && e.target.id === 'comment-form') { handleCommentSubmit(e); }
        };

        const ensureUserProfile = async (user) => {
            if (!user.uid || !user.email) return;
            const userDocRef = doc(db, userRoleCollectionPath, user.uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    await setDoc(userDocRef, {
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL,
                        role: 'user',
                        createdAt: serverTimestamp()
                    }, { merge: true });
                }
            } catch (e) { console.error("Lỗi tạo user profile lần đầu:", e); }
        };
        
        // --- NEW: HANDLE PROFILE UPDATE ---
        const handleProfileUpdate = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || !db || user.isAnonymous || !isGoogleAuth(user)) { 
                getEl('#profile-error').textContent = "Bạn cần đăng nhập bằng Google để cập nhật hồ sơ.";
                getEl('#profile-error').classList.remove('hidden');
                return;
            }

            const newName = getEl('#profile-name-input').value.trim();
            const errorEl = getEl('#profile-error');
            errorEl.classList.add('hidden');

            if (!newName || newName.length < 3) {
                errorEl.textContent = "Tên hiển thị phải dài ít nhất 3 ký tự.";
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                // 1. Update Firebase Auth Profile
                await updateProfile(user, { displayName: newName });
                
                // 2. Update Firestore User Profile (for role/display consistency)
                const userDocRef = doc(db, userRoleCollectionPath, user.uid);
                await updateDoc(userDocRef, { displayName: newName, updatedAt: serverTimestamp() });

                getEl('#profile-success').textContent = "Cập nhật hồ sơ thành công!";
                getEl('#profile-success').classList.remove('hidden');
                getEl('#profile-success').classList.add('bg-lime-900/50');
                
                // Force UI update
                updateAuthStateUI(auth.currentUser);
                setTimeout(() => { getEl('#profile-success').classList.add('hidden'); getEl('#profile-success').classList.remove('bg-lime-900/50'); }, 3000);

            } catch (e) {
                console.error("Lỗi khi cập nhật hồ sơ:", e);
                errorEl.textContent = `Lỗi cập nhật: ${e.message}`;
                errorEl.classList.remove('hidden');
            }
        };
        
        const handleReviewSubmit = async (e) => {
            e.preventDefault();
            const form = e.currentTarget;
            const movieId = form.dataset.movieId;
            const user = auth.currentUser;
            const rating = parseInt(getEl('input[name="rating"]:checked')?.value);
            const content = getEl('#review-content')?.value.trim() || '';
            const reviewErrorEl = getEl('#review-error');

            reviewErrorEl.classList.add('hidden');
            if (!rating) {reviewErrorEl.textContent = "Vui lòng chọn số sao đánh giá.";reviewErrorEl.classList.remove('hidden');return;}
            if (!db || !user || user.isAnonymous || !isGoogleAuth(user)) {reviewErrorEl.textContent = "Bạn cần Đăng nhập bằng Google để đánh giá.";reviewErrorEl.classList.remove('hidden');return;}
            
            const movieDocRef = doc(db, dataCollectionPath, movieId);
            const reviewDocRef = doc(db, dataCollectionPath, movieId, 'reviews', user.uid);
            
            try {
                const batch = writeBatch(db);
                let oldRating = 0; let isUpdate = !!currentUserReviewCache;
                if (isUpdate) oldRating = currentUserReviewCache.rating || 0;
                const ratingDifference = rating - oldRating;

                if (isUpdate) {
                    batch.update(reviewDocRef, {rating: rating, content: content, updatedAt: serverTimestamp()});
                } else {
                    batch.set(reviewDocRef, {
                        userId: user.uid, rating: rating, content: content,
                        displayName: user.displayName || user.email.split('@')[0], photoURL: user.photoURL, 
                        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                    });
                }

                if (isUpdate) {
                    batch.update(movieDocRef, {reviewTotal: increment(ratingDifference)});
                } else {
                    batch.update(movieDocRef, {reviewTotal: increment(rating), reviewCount: increment(1)});
                }
                
                await batch.commit();
            } catch (e) {
                console.error("[REVIEW ERROR] Lỗi khi gửi đánh giá:", e);
                reviewErrorEl.textContent = "Lỗi hệ thống khi gửi đánh giá. Vui lòng thử lại.";
                reviewErrorEl.classList.remove('hidden');
            }
        };

        const renderPublicReviewItem = (review) => {
            const displayName = review.displayName || 'Ẩn danh';
            const photoURL = review.photoURL || `https://placehold.co/40x40/374151/e2e8f0?text=${displayName.charAt(0).toUpperCase()}`;
            const rating = review.rating || 0;
            const dateStr = formatCommentDate(review.updatedAt || review.createdAt);
            
            return `
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-3">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center space-x-3">
                            <img src="${photoURL}" alt="Avatar" class="w-10 h-10 rounded-full object-cover" loading="lazy" onerror="this.src='https://placehold.co/40x40/374151/e2e8f0'">
                            <div>
                                <p class="text-white font-bold text-sm">${displayName}</p>
                                <div class="flex text-yellow-400 text-xs">
                                    ${renderStars(rating)}
                                </div>
                            </div>
                        </div>
                        <span class="text-xs text-gray-500">${dateStr}</span>
                    </div>
                    ${review.content ? `<p class="text-gray-300 text-sm mt-3 border-t border-gray-700 pt-2">${review.content}</p>` : ''}
                </div>
            `;
        };

        const setupPublicReviewsListener = (movieId) => {
            if (unsubscribePublicReviewsListener) { unsubscribePublicReviewsListener(); unsubscribePublicReviewsListener = null; }
            const reviewsColRef = collection(db, dataCollectionPath, movieId, 'reviews');
            const q = query(reviewsColRef, orderBy('updatedAt', 'desc'), limit(COMMENT_LIMIT)); 
            
            unsubscribePublicReviewsListener = onSnapshot(q, (snapshot) => {
                const publicReviewsContainer = getEl('#public-reviews-list');
                if (!publicReviewsContainer) return;
                const reviews = [];
                snapshot.forEach(doc => {reviews.push({ id: doc.id, ...doc.data() });});
                const displayedReviews = reviews.slice(0, REVIEW_DISPLAY_LIMIT); 

                if (reviews.length > 0) {
                    publicReviewsContainer.innerHTML = `
                        <h4 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">Đánh giá gần đây (${reviews.length})</h4>
                        <div class="max-h-96 overflow-y-auto review-scroll-area space-y-3">
                            ${displayedReviews.map(renderPublicReviewItem).join('')}
                             ${reviews.length > REVIEW_DISPLAY_LIMIT ? `<p class="text-gray-500 text-center pt-2 text-sm italic">...Đã ẩn ${reviews.length - REVIEW_DISPLAY_LIMIT} đánh giá cũ hơn để tối ưu hiệu suất.</p>` : ''}
                        </div>
                    `;
                } else {
                    publicReviewsContainer.innerHTML = `<p class="text-gray-500 text-sm italic">Chưa có đánh giá nào. Hãy là người đầu tiên!</p>`;
                }
            }, (error) => {
                 console.error("Lỗi tải danh sách đánh giá:", error);
                 if (error.code !== 'failed-precondition') {
                     const publicReviewsContainer = getEl('#public-reviews-list');
                     if(publicReviewsContainer) publicReviewsContainer.innerHTML = `<p class="text-gray-500 text-sm">Không thể tải đánh giá lúc này.</p>`;
                 }
            });
        };

        const setupUserReviewListener = (movieId) => {
            if (unsubscribeReviewListener) { unsubscribeReviewListener(); unsubscribeReviewListener = null; }
            if (!auth?.currentUser || auth.currentUser.isAnonymous) return;
            
            const user = auth.currentUser;
            const reviewDocRef = doc(db, dataCollectionPath, movieId, 'reviews', user.uid);
            
            unsubscribeReviewListener = onSnapshot(reviewDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserReviewCache = { id: docSnap.id, ...docSnap.data() };
                } else {
                    currentUserReviewCache = null;
                }
                const movie = globalMovieCache.find(m => m.id === movieId);
                if (movie) {setupReviewSection(movie, currentUserReviewCache);}
            }, (error) => {
                console.error("Lỗi listener review người dùng:", error);
                currentUserReviewCache = null;
                const movie = globalMovieCache.find(m => m.id === movieId);
                if (movie) setupReviewSection(movie, null); 
            });
        };
        
        const renderStars = (rating) => {
            const score = parseFloat(rating) || 0;
            const fullStars = Math.floor(score);
            const halfStar = score % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            
            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) starsHtml += `<ion-icon name="star" class="text-yellow-400"></ion-icon>`;
            if (halfStar === 1) starsHtml += `<ion-icon name="star-half" class="text-yellow-400"></ion-icon>`;
            for (let i = 0; i < emptyStars; i++) starsHtml += `<ion-icon name="star-outline" class="text-gray-500"></ion-icon>`;
            return starsHtml;
        };

        // --- HÀM TẠO NỘI DUNG ĐÁNH GIÁ NHỎ (SUBTLE RATING) ---
        const renderSubtleRatingHtml = (movie) => {
            const reviewCount = movie.reviewCount || 0;
            const reviewTotal = movie.reviewTotal || 0;
            const averageRating = reviewCount > 0 ? (reviewTotal / reviewCount) : 0;
            
            const ratingDisplay = averageRating.toFixed(1);

            if (reviewCount === 0) {
                 // Giữ nguyên hiển thị nếu chưa có đánh giá
                 return `<div class="absolute top-2 left-2 z-10 bg-black/70 rounded-full px-2 py-1 shadow-md text-gray-400 text-xs">--/5</div>`;
            }

            return `
                <div class="absolute top-2 left-2 z-10 bg-black/70 rounded-full px-2 py-1 shadow-md flex items-center space-x-1">
                    <ion-icon name="star" class="text-yellow-400 text-xs"></ion-icon>
                    <span class="text-white text-xs font-bold">${ratingDisplay}</span>
                    <!-- Bỏ phần hiển thị số lượt đánh giá để gọn hơn -->
                </div>
            `;
        };
        
        const renderFormStars = (currentRating) => {
            let html = '';
            for (let i = 5; i >= 1; i--) {
                html += `<input type="radio" id="rating-${i}" name="rating" value="${i}" class="hidden peer" ${currentRating === i ? 'checked' : ''}>
                    <label for="rating-${i}" class="cursor-pointer text-4xl text-gray-600 peer-hover:text-yellow-400 hover:text-yellow-400 transition-colors duration-200">
                        <ion-icon name="${currentRating >= i ? 'star' : 'star-outline'}" class="rating-star-icon" data-rating="${i}"></ion-icon>
                    </label>`;
            }
            return `<div id="rating-input-area" class="flex flex-row-reverse justify-end space-x-1 space-x-reverse">${html}</div>`;
        };
        
        const setupReviewSection = (movie, userReview) => {
            const formContainer = getEl('#user-review-form-container');
            if (!formContainer) return;
            const isCommentAllowed = !!auth?.currentUser && !auth.currentUser.isAnonymous && isGoogleAuth(auth.currentUser);
            const user = auth?.currentUser;

            if (userReview) {
                formContainer.innerHTML = `
                    <div class="p-6 bg-gray-700 rounded-lg shadow-inner border border-lime-500/50">
                        <h3 class="text-xl font-bold text-lime-400 mb-4">${userReview.rating} Sao - Đánh giá của bạn</h3>
                        <p class="text-sm text-gray-400 mb-4">Đánh giá gần nhất vào: ${formatCommentDate(userReview.updatedAt || userReview.createdAt)}</p>
                        <form id="review-form" data-movie-id="${movie.id}">
                            ${renderFormStars(userReview.rating)}
                            <textarea id="review-content" class="w-full h-24 px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-lime-500 my-4" placeholder="Chia sẻ thêm cảm nhận của bạn (tùy chọn)...">${userReview.content || ''}</textarea>
                            <p id="review-error" class="text-red-400 text-sm mb-2 hidden"></p>
                            <button type="submit" class="bg-lime-500 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-lime-600 transition-colors">Cập nhật Đánh giá</button>
                        </form>
                    </div>
                `;
            } else if (isCommentAllowed) {
                formContainer.innerHTML = `
                    <div class="p-6 bg-gray-800 rounded-lg shadow-xl">
                        <h3 class="text-2xl font-bold text-white mb-4">Đánh Giá Của Bạn</h3>
                        <p class="text-gray-400 mb-4">Hãy chia sẻ cảm nhận của bạn về bộ phim này:</p>
                        <form id="review-form" data-movie-id="${movie.id}">
                            ${renderFormStars(0)}
                            <textarea id="review-content" class="w-full h-24 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-lime-500 my-4" placeholder="Chia sẻ thêm cảm nhận của bạn (tùy chọn)..."></textarea>
                            <p id="review-error" class="text-red-400 text-sm mb-2 hidden"></p>
                            <button type="submit" class="bg-lime-500 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-lime-600 transition-colors">Gửi Đánh giá</button>
                        </form>
                    </div>
                `;
            } else {
                formContainer.innerHTML = `
                    <div class="p-6 bg-gray-800 rounded-lg shadow-xl text-center">
                        <h3 class="text-2xl font-bold text-white mb-4">Đánh Giá</h3>
                        <p class="text-gray-400">Bạn cần <a href="#login" class="text-lime-400 hover:underline font-medium">Đăng Nhập bằng Google</a> để gửi đánh giá phim.</p>
                    </div>
                `;
            }
            getEl('#review-form')?.addEventListener('submit', handleReviewSubmit);
            const ratingArea = getEl('#rating-input-area');
            if (ratingArea) {
                ratingArea.addEventListener('click', (e) => {
                    const target = e.target.closest('label');
                    if (target) {
                        const rating = parseInt(target.getAttribute('for').replace('rating-', ''));
                        const allLabels = ratingArea.querySelectorAll('label');
                        allLabels.forEach(label => {
                            const labelRating = parseInt(label.getAttribute('for').replace('rating-', ''));
                            const icon = label.querySelector('ion-icon');
                            if (icon) icon.setAttribute('name', labelRating <= rating ? 'star' : 'star-outline');
                        });
                    }
                });
            }
        };

        const MovieCardTemplate = (movie) => {
            const infoUrl = `#phim/${createSlug(movie.title)}-${movie.id}`; 
            const statusText = movie.status || 'N/A';
            const epCount = movie.episodes ? movie.episodes.length : 0;
            const genres = movie.genre ? movie.genre.split(',').map(g => g.trim()).join(', ') : '';
            
            // --- Sử dụng hàm rating subtle đã được revert ---
            const ratingHtml = renderSubtleRatingHtml(movie); 
            
            return `
                <a href="${infoUrl}" class="group block relative overflow-hidden rounded-lg shadow-lg bg-gray-800 transition-transform duration-300 ease-in-out hover:-translate-y-2">
                    <div class="absolute top-2 right-2 z-10 flex flex-col space-y-1 items-end">
                        <span class="inline-block bg-black/70 text-lime-400 text-xs font-bold px-2 py-1 rounded-md uppercase">
                            ${statusText === 'sap-chieu' ? 'Sắp chiếu' : (statusText === 'dang-chieu' ? 'Đang Chiếu' : 'Full')}
                        </span>
                        <span class="inline-block bg-black/70 text-white text-xs font-bold px-2 py-1 rounded-md">HD</span>
                        <span class="inline-block bg-black/70 text-white text-xs font-bold px-2 py-1 rounded-md">
                            ${epCount > 0 ? `Tập ${epCount}` : 'Chưa có tập'}
                        </span>
                    </div>
                    ${ratingHtml}
                    <div class="absolute inset-0 z-10">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col items-center justify-center p-4">
                            <p class="text-lime-400 text-lg font-bold mb-2 text-center">XEM NGAY</p>
                            <div class="flex items-center text-sm text-gray-300">
                                <ion-icon name="eye-outline" class="mr-1"></ion-icon> ${(movie.viewCount || 0).toLocaleString('vi-VN')}
                                <ion-icon name="thumbs-up-outline" class="ml-3 mr-1"></ion-icon> ${(movie.likeCount || 0).toLocaleString('vi-VN')}
                            </div>
                        </div>
                    </div>
                    <img src="${movie.posterUrl}" alt="${movie.title}" loading="lazy" class="w-full h-64 object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.src='https://placehold.co/400x600/1a202c/e2e8f0?text=${movie.title.replace(/\s/g, '+')}'">
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-white truncate group-hover:text-lime-400 transition-colors z-20 relative">${movie.title}</h3>
                        <p class="text-sm text-gray-400">${genres}</p>
                    </div>
                </a>
            `;
        };
        
        const SearchPageTemplate = (movieList, title) => `
            <section>
                <h2 class="text-3xl font-bold text-white mb-6">${title}</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-4">
                    ${movieList.length > 0 ? movieList.map(MovieCardTemplate).join('') : '<p class="text-gray-400 col-span-full">Không tìm thấy bộ anime nào phù hợp.</p>'}
                </div>
            </section>
        `;

        const HeroSectionTemplate = (movie) => {
            if (!movie) return '';
            const movieSlug = createSlug(movie.title);
            const infoUrl = `#phim/${movieSlug}-${movie.id}`; 
            const imageUrl = movie.bannerUrl || movie.posterUrl; 
            const genres = movie.genre ? movie.genre.split(',').slice(0, 2).map(genre => `<span class="bg-gray-700/80 backdrop-blur-sm text-gray-300 text-xs font-medium px-3 py-1 rounded-full">${genre.trim()}</span>`).join('') : '';
            return `
                <section class="relative h-[65vh] md:h-[80vh] rounded-xl overflow-hidden mb-12 -mt-8 md:-mt-12 -mx-4 md:-mx-12">
                    <img src="${imageUrl}" alt="${movie.title} backdrop" class="w-full h-full object-cover opacity-70" loading="lazy" onerror="this.src='https://placehold.co/1200x600/1a202c/e2e8f0?text=Hero'">
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/80 to-transparent"></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-gray-900 via-gray-900/50 to-transparent"></div>
                    
                    <div class="absolute bottom-0 left-0 p-6 md:p-12 max-w-2xl text-white">
                        <span class="inline-block bg-lime-500 text-gray-900 text-sm font-bold px-3 py-1 rounded-md uppercase mb-4">Mới Cập Nhật</span>
                        <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-2 leading-tight">${movie.title}</h1>
                        ${movie.titleOriginal ? `<h4 class="text-xl md:text-2xl font-semibold text-gray-400 mb-2">${movie.titleOriginal}</h4>` : ''}
                        <p class="text-gray-300 text-lg mb-6 line-clamp-3">${movie.summary || 'Không có tóm tắt.'}</p>
                        <div class="flex items-center space-x-4">
                            <a href="${infoUrl}" class="inline-flex items-center justify-center px-8 py-3 bg-lime-500 text-gray-900 text-lg font-bold rounded-lg shadow-lg hover:bg-lime-600 transition-colors">
                                <ion-icon name="information-circle-outline" class="text-2xl mr-2"></ion-icon>
                                Xem Thông Tin
                            </a>
                            <div class="flex space-x-2">${genres}</div>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-0 right-0 p-6 md:p-12 z-10 hidden md:block">
                         <div class="flex space-x-2 md:space-x-4 text-sm text-gray-400">
                             <a href="#" class="hover:text-lime-400 border-b-2 border-lime-400 text-white pb-1">Tất cả</a>
                             <a href="#season/mua-he-2024" class="hover:text-lime-400">Mùa Hè 2024</a>
                             <a href="#top/thang" class="hover:text-lime-400">Top Tháng</a>
                         </div>
                    </div>
                </section>
            `;
        };

        const MovieSectionTemplate = (title, movieList, xemThemLink = "#") => {
            if (movieList.length === 0) return '';
            return `
                <section class="mb-12">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-white uppercase">${title}</h2>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-x-2 gap-y-4 md:gap-4">
                        ${movieList.map(MovieCardTemplate).join('')}
                    </div>
                    <div class="text-center mt-8">
                        <a href="${xemThemLink}" class="bg-gray-700 text-gray-300 font-medium px-6 py-3 rounded-lg hover:bg-lime-500 hover:text-gray-900 transition-colors">XEM THÊM</a>
                    </div>
                </section>
            `;
        };

        const AuthPageTemplate = () => {
            return `
                <div class="min-h-[70vh] flex items-center justify-center">
                    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
                        <h2 class="text-3xl font-bold text-white text-center mb-6">Đăng Nhập</h2>
                        <p class="text-gray-400 text-center mb-8">Sử dụng tài khoản Google để bình luận và lưu phim yêu thích.</p>
                        <div class="space-y-4">
                            <button id="google-login-btn" class="w-full bg-white text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center">
                                <ion-icon name="logo-google" class="text-xl mr-3 text-red-500"></ion-icon>
                                Đăng nhập với Google
                            </button>
                        </div>
                        <p id="auth-error" class="text-red-400 text-sm text-center mt-6"></p>
                    </div>
                </div>
            `;
        };

        const CommentTemplate = (comment) => {
            const displayName = comment.displayName || comment.email || 'Người dùng ẩn danh'; 
            const photoURL = comment.photoURL || `https://placehold.co/40x40/374151/e2e8f0?text=${displayName.charAt(0).toUpperCase()}`; 
            return `
            <div class="flex space-x-3 mb-4">
                <div class="flex-shrink-0">
                    <img class="w-10 h-10 rounded-full object-cover" src="${photoURL}" alt="Avatar" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/40x40/374151/e2e8f0?text=${displayName.charAt(0).toUpperCase()}';">
                </div>
                <div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-white text-sm">${displayName}</p>
                        <p class="text-gray-300 text-sm">${comment.content}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${formatCommentDate(comment.createdAt)}</p>
                </div>
            </div>
            `;
        };
        
        const renderProfilePage = (user) => {
            const displayName = user.displayName || user.email.split('@')[0];
            const photoURL = user.photoURL || `https://placehold.co/128x128/a3e635/111827?text=${displayName.charAt(0).toUpperCase()}`;
            const email = user.email || 'Không có';
            const provider = isGoogleAuth(user) ? 'Google' : 'Admin Custom Token';

            return `
                <div class="min-h-[70vh] flex items-center justify-center">
                    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-lg">
                        <h2 class="text-3xl font-bold text-white text-center mb-8">Hồ Sơ Cá Nhân</h2>
                        
                        <div class="flex flex-col items-center mb-8">
                            <img src="${photoURL}" alt="Avatar" class="w-32 h-32 rounded-full object-cover mb-4 border-4 border-lime-500" onerror="this.onerror=null;this.src='https://placehold.co/128x128/a3e635/111827?text=${displayName.charAt(0).toUpperCase()}'">
                            <p class="text-xl font-bold text-white">${displayName}</p>
                            <p class="text-gray-400 text-sm">${email}</p>
                            <p class="text-gray-500 text-xs mt-1">Đăng nhập qua: ${provider}</p>
                        </div>

                        <form id="profile-update-form" class="space-y-4">
                            <div class="space-y-1">
                                <label for="profile-name-input" class="block text-sm font-medium text-gray-300">Tên Hiển Thị Mới</label>
                                <input type="text" id="profile-name-input" value="${displayName}" required minlength="3"
                                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-lime-500">
                            </div>

                            <div id="profile-success" class="p-3 rounded-lg text-sm text-lime-300 hidden transition-all"></div>
                            <p id="profile-error" class="text-red-400 text-sm hidden"></p>
                            
                            <button type="submit" class="w-full bg-lime-500 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-lime-600 transition-colors">
                                Cập Nhật
                            </button>
                        </form>

                    </div>
                </div>
            `;
        };
        
        const InfoPageTemplate = (movie, episodes, isLiked) => {
            const firstEpisode = episodes.length > 0 ? episodes[0] : null;
            const movieSlug = createSlug(movie.title);
            const firstEpUrl = firstEpisode ? `#phim/${movieSlug}-${movie.id}/tap-${firstEpisode.episodeNumber}-${firstEpisode.id}.html` : '#';
            const imageUrl = movie.bannerUrl || movie.posterUrl; 
            
            const reviewCount = movie.reviewCount || 0;
            const reviewTotal = movie.reviewTotal || 0;
            const averageRating = reviewCount > 0 ? (reviewTotal / reviewCount) : 0;
            const requiresSignInLink = !!auth?.currentUser && auth.currentUser.isAnonymous;

            return `
                <section class="text-white">
                    <div class="relative rounded-lg overflow-hidden h-64 md:h-96 -mt-8 md:-mt-12 -mx-4 md:-mx-12">
                        <img src="${imageUrl}" alt="${movie.title} backdrop" class="w-full h-full object-cover opacity-70" loading="lazy" onerror="this.src='https://placehold.co/1200x400/1a202c/e2e8f0?text=Backdrop'">
                        <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/80 to-transparent"></div>
                        <div class="absolute inset-0 bg-gradient-to-r from-gray-900 via-gray-900/50 to-transparent"></div>
                    </div>
                    <div class="container mx-auto px-4 relative -mt-32 md:-mt-48 pb-12">
                        <div class="md:flex md:space-x-8">
                            <div class="flex-shrink-0 w-48 md:w-64 mx-auto md:mx-0 md:mt-4">
                                <a href="${firstEpUrl}" class="group block relative rounded-lg shadow-2xl overflow-hidden">
                                    <div class="absolute inset-0 z-10 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                        <ion-icon name="play-circle-outline" class="text-7xl text-white opacity-90"></ion-icon>
                                    </div>
                                    <img src="${movie.posterUrl}" alt="${movie.title} poster" class="w-full rounded-lg transition-transform duration-300 group-hover:scale-110" loading="lazy" onerror="this.src='https://placehold.co/400x600/1a202c/e2e8f0?text=${movie.title.replace(/\s/g, '+')}'">
                                </a>
                            </div>
                            <div class="flex-1 mt-6 md:mt-4 text-center md:text-left">
                                <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-0">${movie.title}</h1>
                                ${movie.titleOriginal ? `<h4 class="text-2xl md:text-3xl font-semibold text-gray-400 mb-2">${movie.titleOriginal}</h4>` : ''}
                                
                                <div class="flex flex-wrap justify-center md:justify-start items-center space-x-4 text-gray-400 mb-4">
                                    <div class="flex items-center space-x-1"><ion-icon name="eye-outline" class="text-xl"></ion-icon><span id="view-count">${(movie.viewCount || 0).toLocaleString('vi-VN')} Lượt xem</span></div>
                                    <div class="flex items-center space-x-1"><ion-icon name="thumbs-up-outline" class="text-xl"></ion-icon><span id="like-count">${(movie.likeCount || 0).toLocaleString('vi-VN')} Lượt thích</span></div>
                                </div>
                                
                                <div class="flex justify-center md:justify-start items-center space-x-2 text-yellow-400 mb-4">
                                    <span class="text-3xl font-bold">${averageRating.toFixed(1)}</span>
                                    <div class="flex text-2xl">${renderStars(averageRating)}</div>
                                    <span class="text-gray-400 text-sm ml-2">(${reviewCount.toLocaleString('vi-VN')} Đánh giá)</span>
                                </div>
                                
                                <div class="flex justify-center md:justify-start space-x-2 mb-4">
                                    ${movie.genre ? movie.genre.split(',').map(genre => `<span class="bg-gray-700 text-gray-300 text-xs font-medium px-3 py-1 rounded-full">${genre.trim()}</span>`).join('') : ''}
                                </div>
                                <p class="text-gray-300 text-lg mb-6">${movie.summary || 'Không có tóm tắt.'}</p>
                                <div class="flex flex-col space-y-4 md:flex-row md:space-x-4 md:space-y-0">
                                    <a href="${firstEpUrl}" class="inline-flex items-center justify-center px-6 py-3 bg-lime-500 text-gray-900 text-lg font-bold rounded-lg shadow-lg hover:bg-lime-600 transition-colors w-full md:w-auto">
                                        <ion-icon name="play-circle-outline" class="text-2xl mr-2"></ion-icon>Xem Phim
                                    </a>
                                    
                                    <button id="like-button" data-movie-id="${movie.id}" class="
                                        inline-flex items-center justify-center px-6 py-3 rounded-lg shadow-lg transition-colors w-full md:w-auto
                                        ${isLiked ? 'bg-lime-600 text-white font-bold' : 'bg-gray-700 text-gray-300 font-medium hover:bg-gray-600'}
                                    ">
                                        <ion-icon name="${isLiked ? 'thumbs-up' : 'thumbs-up-outline'}" class="text-2xl mr-2"></ion-icon>
                                        <span id="like-button-text">${isLiked ? 'Đã thích' : 'Thích'}</span>
                                    </button>
                                    
                                    ${requiresSignInLink ? `
                                        <a href="#login" class="inline-flex items-center justify-center px-6 py-3 bg-gray-700 text-gray-400 font-medium rounded-lg shadow-lg hover:bg-gray-600 transition-colors w-full md:w-auto">
                                            <ion-icon name="log-in-outline" class="text-2xl mr-2"></ion-icon>Đăng nhập để giữ Likes
                                        </a>
                                    ` : ''}
                                    <span class="inline-block bg-gray-600 text-white text-sm font-bold px-4 py-2 rounded-full uppercase self-center w-full md:w-auto text-center md:text-left">${movie.status || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-12">
                            <div id="user-review-form-container"></div> 
                            <div id="public-reviews-list" class="mt-8"></div> 
                        </div>
                        
                        <div class="mt-12 bg-gray-800 rounded-lg shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-white mb-6">Danh Sách Tập</h2>
                            ${episodes.length > 0
                                ? `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 episode-list-grid">
                                    ${episodes.map(ep => `
                                        <a href="#phim/${movieSlug}-${movie.id}/tap-${ep.episodeNumber}-${ep.id}.html" 
                                            class="block bg-gray-700 text-white text-center font-medium py-3 px-4 rounded-lg hover:bg-lime-500 hover:text-gray-900 transition-colors duration-200">
                                            Tập ${ep.episodeNumber}
                                        </a>
                                    `).join('')}
                                </div>`
                                : `<p class="text-gray-400">${movie.status === 'sap-chieu' ? 'Phim sắp chiếu, chưa có tập.' : 'Chưa có tập phim nào cho bộ này.'}</p>`
                            }
                        </div>
                    </div>
                </section>
            `;
        };
        
        const WatchPageTemplate = (movie, episode, comments, allEpisodes, currentEpNumber, nextEpisodeLink) => {
            const { html: videoPlayerHtml } = getVideoPlayer(episode.videoUrl, movie.posterUrl);
            const movieSlug = createSlug(movie.title);
            const user = auth?.currentUser;
            const canComment = !!user && !user.isAnonymous && isGoogleAuth(user);
            const displayedComments = comments.slice(0, COMMENT_DISPLAY_LIMIT);
            
            const previousEpisode = allEpisodes.find(ep => ep.episodeNumber === currentEpNumber - 1);
            let previousEpisodeLink = null;
            if (previousEpisode) {
                const prevEpId = previousEpisode.id;
                previousEpisodeLink = `#phim/${movieSlug}-${movie.id}/tap-${previousEpisode.episodeNumber}-${prevEpId}.html`;
            }
            
            const previousButton = previousEpisodeLink ? `
                <a href="${previousEpisodeLink}" class="inline-flex items-center justify-center px-4 py-2 bg-gray-700 text-gray-300 text-sm font-medium rounded-lg hover:bg-gray-600 transition-colors flex-grow md:flex-grow-0 md:w-auto">
                    <ion-icon name="arrow-back-circle-outline" class="text-xl mr-2"></ion-icon> Tập ${currentEpNumber - 1}
                </a>
            ` : `
                <button disabled class="inline-flex items-center justify-center px-4 py-2 bg-gray-800 text-gray-500 text-sm font-medium rounded-lg cursor-not-allowed flex-grow md:flex-grow-0 md:w-auto opacity-50">
                    <ion-icon name="arrow-back-circle-outline" class="text-xl mr-2"></ion-icon> Tập Trước
                </button>
            `;
            
            const nextButton = nextEpisodeLink ? `
                <a href="${nextEpisodeLink}" class="bg-lime-500 text-gray-900 text-sm font-bold px-4 py-2 rounded-lg hover:bg-lime-600 transition-colors flex items-center justify-center flex-grow md:flex-grow-0 md:w-auto ml-2">
                    Tập ${currentEpNumber + 1} <ion-icon name="arrow-forward-circle" class="text-xl ml-2"></ion-icon>
                </a>
            ` : `
                 <button disabled class="bg-red-800 text-red-200 text-sm font-medium px-4 py-2 rounded-lg flex items-center justify-center flex-grow md:flex-grow-0 md:w-auto ml-2 opacity-50">
                    Tập Cuối <ion-icon name="lock-closed" class="text-xl ml-2"></ion-icon>
                </button>
            `;


            return `
                <section class="text-white">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div id="video-player-container" class="relative w-full aspect-video rounded-xl overflow-hidden shadow-2xl bg-black">
                                ${videoPlayerHtml}
                                <div id="video-overlay" 
                                    class="overlay-style absolute inset-0 flex items-center justify-center p-4 z-10" 
                                    style="background-image: url('https://uploads.onecompiler.io/43u4wb3ft/43u4y39cc/bannerphim.jpeg'); 
                                        background-size: cover; background-position: center; background-color: rgba(0, 0, 0, 0.4); background-blend-mode: darken;">
                                    <div class="text-center p-4 sm:p-8 rounded-xl max-w-xs sm:max-w-md mx-auto">
                                        <button id="play-video-button" 
                                            class="play-button-overlay text-gray-900 font-extrabold text-xl sm:text-2xl px-10 py-5 sm:py-6 rounded-full flex items-center justify-center space-x-3 transform transition-all duration-300 shadow-xl hover:scale-105">
                                            <ion-icon name="play-circle" class="text-3xl sm:text-4xl"></ion-icon>
                                            <span>XEM PHIM</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 p-4 bg-gray-800 rounded-lg shadow-lg border-l-4 border-lime-500">
                                <h1 class="text-3xl font-extrabold text-white mb-1">${movie.title}</h1>
                                ${movie.titleOriginal ? `<h4 class="text-lg font-semibold text-gray-400 mb-2">${movie.titleOriginal}</h4>` : ''}
                                <h2 class="text-xl font-bold text-lime-400">Tập ${currentEpNumber}: ${episode.title || 'Đang cập nhật'}</h2>
                                <p class="text-gray-400 text-sm mt-2">${movie.genre}</p>
                                <div class="flex flex-col space-y-3 mt-4 pt-3 border-t border-gray-700">
                                    <div class="flex flex-wrap items-center justify-start space-x-3">
                                        ${previousButton}
                                        ${nextButton}
                                    </div>
                                    <a href="#phim/${movieSlug}-${movie.id}" class="bg-gray-700 text-gray-300 text-sm font-medium px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center md:w-1/2 lg:w-1/3">
                                        <ion-icon name="information-circle-outline" class="mr-1"></ion-icon> Thông tin Phim
                                    </a>
                                </div>
                            </div>
                            
                            <div class="mt-8 p-6 bg-gray-800 rounded-lg shadow-lg">
                                <h3 class="text-2xl font-bold text-white mb-4">Bình Luận (<span id="comment-count-display">${comments.length}</span>)</h3>
                                ${canComment ? `
                                    <form id="comment-form" class="mb-6">
                                        <textarea id="comment-input" class="w-full h-20 p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-lime-500" placeholder="Viết bình luận của bạn tại đây..." required></textarea>
                                        <p id="comment-error" class="text-red-400 text-sm mb-2 hidden"></p>
                                        <button type="submit" class="bg-lime-500 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-lime-600 transition-colors">Gửi Bình Luận</button>
                                    </form>
                                ` : `
                                    <div class="p-4 bg-gray-700 rounded-lg text-center mb-6">
                                        <p class="text-gray-300">Bạn cần <a href="#login" class="text-lime-400 hover:underline font-medium">Đăng Nhập bằng Google</a> để bình luận.</p>
                                    </div>
                                `}
                                
                                <div id="comments-list">
                                    <div class="max-h-96 overflow-y-auto comments-scroll-area">
                                        ${displayedComments.length > 0
                                            ? displayedComments.map(CommentTemplate).join('')
                                            : '<p class="text-gray-500 text-center">Chưa có bình luận nào. Hãy là người đầu tiên!</p>'
                                        }
                                        ${comments.length > COMMENT_DISPLAY_LIMIT ? `<p class="text-gray-500 text-center pt-2 text-sm italic">...Đã ẩn ${comments.length - COMMENT_DISPLAY_LIMIT} bình luận cũ hơn để tối ưu hiệu suất.</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-1">
                            <div class="bg-gray-800 p-6 rounded-lg shadow-xl sticky top-[100px]">
                                <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Danh Sách Tập (${movie.episodes.length} Tập)</h3>
                                
                                <div class="space-y-2 max-h-[80vh] overflow-y-auto schedule-scroll-area">
                                    ${allEpisodes.map(ep => {
                                        const epLink = `#phim/${movieSlug}-${movie.id}/tap-${ep.episodeNumber}-${ep.id}.html`;
                                        const isActive = ep.episodeNumber === currentEpNumber;
                                        return `
                                            <a href="${epLink}" 
                                                class="block py-2 px-3 rounded-lg text-sm font-medium transition-colors duration-200 
                                                ${isActive 
                                                    ? 'bg-lime-500 text-gray-900 font-bold shadow-md hover:bg-lime-600' 
                                                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white'
                                                }">
                                                Tập ${ep.episodeNumber} - ${ep.title || 'Đang cập nhật'}
                                            </a>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
        };

        const renderInfoPage = async (movieId) => { 
             if (!db) { showLoading(); return; }
             if (unsubscribeMovieListener) { unsubscribeMovieListener(); unsubscribeMovieListener = null; }
             if (unsubscribeReviewListener) { unsubscribeReviewListener(); unsubscribeReviewListener = null; }
             if (unsubscribePublicReviewsListener) { unsubscribePublicReviewsListener(); unsubscribePublicReviewsListener = null; }
            
            const movieDocRef = doc(db, dataCollectionPath, movieId);
            let hasRenderedFullPage = false;
            
            unsubscribeMovieListener = onSnapshot(movieDocRef, (movieDocSnap) => {
                if (!movieDocSnap.exists()) { 
                    showError("Không tìm thấy bộ phim này.");
                    return; 
                }
                
                const updatedMovieData = { id: movieDocSnap.id, ...movieDocSnap.data() };
                const isLiked = !!currentUserLikeDocIds[movieId]; 
                
                if (!hasRenderedFullPage) {
                    const episodesList = updatedMovieData.episodes || [];
                    const episodesWithId = episodesList.map((ep, index) => ({ 
                        ...ep, 
                        id: `${movieId}_${ep.episodeNumber}_${index}` 
                    }));
                    
                    const movieSlug = createSlug(updatedMovieData.title);
                    const firstEpUrl = `#phim/${movieSlug}-${updatedMovieData.id}/tap-${episodesWithId[0]?.episodeNumber}-${episodesWithId[0]?.id}.html`;
                    
                    const resumeTime = localStorage.getItem(`_watchTime_${episodesWithId[0]?.id}`);
                    const hasWatchTime = resumeTime && parseInt(resumeTime) > 0;
                    
                    getEl('#app').innerHTML = InfoPageTemplate(updatedMovieData, episodesWithId, isLiked);

                    if (hasWatchTime) {
                         window.showResumeModal(updatedMovieData.title, parseInt(resumeTime)).then(shouldResume => {
                            let finalUrl = firstEpUrl;
                            if (shouldResume) {
                                finalUrl += `?time=${resumeTime}`;
                            } else {
                                localStorage.removeItem(`_watchTime_${episodesWithId[0]?.id}`);
                            }
                            window.location.hash = finalUrl;
                        });
                    }
                    
                    getEl('#like-button')?.addEventListener('click', handleLike);
                    setupPublicReviewsListener(movieId);
                    
                    if (auth?.currentUser && !auth.currentUser.isAnonymous && isGoogleAuth(auth.currentUser)) {
                        setupUserReviewListener(movieId);
                    } else {
                        setupReviewSection(updatedMovieData, null);
                    }
                    
                    hasRenderedFullPage = true;
                } 
                
                incrementViewCount(movieId);
                
                const likeCountEl = getEl('#like-count');
                const viewCountEl = getEl('#view-count');
                const avgRatingContainer = getEl('.text-yellow-400.mb-4');
                
                if (viewCountEl) viewCountEl.textContent = (updatedMovieData.viewCount || 0).toLocaleString('vi-VN') + " Lượt xem";
                if (likeCountEl) likeCountEl.textContent = (updatedMovieData.likeCount || 0).toLocaleString('vi-VN') + " Lượt thích";
                
                if (avgRatingContainer) {
                    const reviewCount = updatedMovieData.reviewCount || 0;
                    const reviewTotal = updatedMovieData.reviewTotal || 0;
                    const averageRating = reviewCount > 0 ? (reviewTotal / reviewCount) : 0;
                    
                    avgRatingContainer.innerHTML = `
                        <span class="text-3xl font-bold">${averageRating.toFixed(1)}</span>
                        <div class="flex text-2xl">${renderStars(averageRating)}</div>
                        <span class="text-gray-400 text-sm ml-2">(${reviewCount.toLocaleString('vi-VN')} Đánh giá)</span>
                    `;
                }
                
                const button = getEl('#like-button');
                const likeButtonText = getEl('#like-button-text');
                const likeButtonIcon = button?.querySelector('ion-icon');
                
                if(button) {
                    button.classList.toggle('bg-lime-600', isLiked);
                    button.classList.toggle('text-white', isLiked);
                    button.classList.toggle('font-bold', isLiked);
                    button.classList.toggle('bg-gray-700', !isLiked);
                    button.classList.toggle('text-gray-300', !isLiked);
                    button.classList.toggle('font-medium', !isLiked);
                    if (likeButtonText) likeButtonText.textContent = isLiked ? 'Đã thích' : 'Thích';
                    if (likeButtonIcon) likeButtonIcon.setAttribute('name', isLiked ? 'thumbs-up' : 'thumbs-up-outline');
                }
                
            }, (error) => {
                console.error("Lỗi listener phim:", error);
                showError("Lỗi khi tải dữ liệu phim thời gian thực.", error.message);
            });
        };

        const renderWatchPage = async (movieId, episodeUniqueId) => { 
             if (!db) { showLoading(); return; }
            if (unsubscribeCommentsListener) { unsubscribeCommentsListener(); unsubscribeCommentsListener = null; }
            if (unsubscribeMovieListener) { unsubscribeMovieListener(); unsubscribeMovieListener = null; }
            if (unsubscribeReviewListener) { unsubscribeReviewListener(); unsubscribeReviewListener = null; }
            if (unsubscribePublicReviewsListener) { unsubscribePublicReviewsListener(); unsubscribePublicReviewsListener = null; }
            
            try {
                let movieData = globalMovieCache.find(a => a.id === movieId);
                if (!movieData) {
                    const movieDocSnap = await getDoc(doc(db, dataCollectionPath, movieId));
                    if (movieDocSnap.exists()) { 
                        movieData = { id: movieDocSnap.id, ...movieDocSnap.data() }; 
                    } else { showError("Không tìm thấy bộ phim này."); return; }
                }
                
                const episodesList = movieData.episodes || [];
                const episodeMatch = episodeUniqueId.match(/_(\d+)_(\d+)$/);
                const episodeNumber = episodeMatch ? parseInt(episodeMatch[1]) : NaN;
                
                if (isNaN(episodeNumber)) { showError("Lỗi: Không tìm thấy số tập phim."); return; }

                const episodeData = episodesList.find(ep => ep.episodeNumber === episodeNumber);
                if (!episodeData) { showError("Không tìm thấy tập phim này trong mảng."); return; }
                
                const commentsColRef = collection(db, dataCollectionPath, movieId, 'comments');
                let commentsList = [];
                let commentsSnapshot;
                try {
                    commentsSnapshot = await getDocs(query(commentsColRef));
                    commentsSnapshot.forEach(doc => commentsList.push({ id: doc.id, ...doc.data() }));
                    commentsList.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    commentsList = commentsList.slice(0, COMMENT_LIMIT);
                } catch (e) { console.error("Lỗi khi tải bình luận:", e); }

                const nextEpisode = episodesList.find(ep => ep.episodeNumber === episodeNumber + 1);
                let nextEpisodeLink = null;
                if (nextEpisode) {
                    const nextEpId = `${movieId}_${nextEpisode.episodeNumber}_${episodesList.indexOf(nextEpisode)}`;
                    nextEpisodeLink = `#phim/${createSlug(movieData.title)}-${movieId}/tap-${nextEpisode.episodeNumber}-${nextEpId}.html`;
                }

                const allEpisodesWithId = episodesList.map((ep, index) => ({ ...ep, id: `${movieId}_${ep.episodeNumber}_${index}` }));

                getEl('#app').innerHTML = WatchPageTemplate(movieData, episodeData, commentsList, allEpisodesWithId, episodeNumber, nextEpisodeLink);
                
                const videoElement = getEl('#video-player-element');
                
                const urlParams = new URLSearchParams(window.location.hash.split('?')[1]);
                const startTime = parseInt(urlParams.get('time') || localStorage.getItem(`_watchTime_${episodeUniqueId}`) || '0');

                if (videoElement && startTime > 0) {
                    videoElement.currentTime = startTime;
                }
                
                if (videoElement) {
                    videoElement.addEventListener('timeupdate', () => {saveWatchTime(episodeUniqueId, videoElement.currentTime);});
                    videoElement.addEventListener('ended', () => {localStorage.removeItem(`_watchTime_${episodeUniqueId}`);});
                }

                getEl('#play-video-button')?.addEventListener('click', handlePlayVideo);
                
                if (commentsSnapshot) getEl('#comment-count-display').textContent = commentsSnapshot.size;

                setupCommentsListener(movieId);

            } catch (e) { showError("Lỗi khi tải trang xem phim.", e.message); }
        };

        const renderScheduleMovieCard = (movie) => {
            const infoUrl = `#phim/${createSlug(movie.title)}-${movie.id}`;
            const episodeCount = movie.episodes ? movie.episodes.length : 0;
            const totalEpisodes = movie.totalEpisodes || '??';

            return `
                <a href="${infoUrl}" class="group block bg-gray-800 p-2 rounded-lg flex items-center space-x-3 transition duration-200 hover:bg-gray-700">
                    <img src="${movie.posterUrl}" alt="${movie.title}" class="w-10 h-14 object-cover rounded flex-shrink-0" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/40x56/1f2937/d1d5db?text=...'">
                    <div class="flex-grow overflow-hidden">
                        <p class="text-white font-semibold text-sm truncate group-hover:text-lime-400">${movie.title}</p>
                        <p class="text-gray-400 text-xs">${episodeCount} / ${totalEpisodes} tập</p>
                    </div>
                </a>
            `;
        };
        
        const SchedulePageTemplate = (moviesByDay) => {
            const daysOfWeek = ["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7", "Chủ Nhật"];
            
            return `
                <section>
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-3">LỊCH CHIẾU ANIME TRONG TUẦN</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        ${daysOfWeek.map(day => `
                            <div class="bg-gray-800 p-4 rounded-lg shadow-xl min-h-[300px]">
                                <h3 class="text-xl font-extrabold text-lime-400 mb-4 text-center border-b border-gray-700 pb-2">${day}</h3>
                                <div class="space-y-3 max-h-[70vh] overflow-y-auto schedule-scroll-area">
                                    ${(moviesByDay[day] && moviesByDay[day].length > 0)
                                        ? moviesByDay[day].map(renderScheduleMovieCard).join('')
                                        : '<p class="text-gray-500 text-sm italic text-center py-4">Không có phim chiếu.</p>'
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${(moviesByDay["Không có"] && moviesByDay["Không có"].length > 0) ? `
                        <div class="mt-12">
                            <h3 class="text-2xl font-bold text-gray-400 mb-4">PHIM CHƯA GÁN LỊCH HOẶC SẮP CHIẾU</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                ${(moviesByDay["Không có"]).map(MovieCardTemplate).join('')}
                            </div>
                        </div>
                    ` : ''}
                </section>
            `;
        };

        const renderSchedulePage = () => { 
            const moviesByDay = { "Thứ 2": [], "Thứ 3": [], "Thứ 4": [], "Thứ 5": [], "Thứ 6": [], "Thứ 7": [], "Chủ Nhật": [], "Không có": [] };
            const airingMovies = globalMovieCache.filter(m => m.status === 'dang-chieu' || m.status === 'sap-chieu');
            airingMovies.forEach(movie => {
                const day = movie.airingDay || "Không có";
                moviesByDay.hasOwnProperty(day) ? moviesByDay[day].push(movie) : moviesByDay["Không có"].push(movie); 
            });
            getEl('#app').innerHTML = SchedulePageTemplate(moviesByDay);
        };

        const showError = (message, details = '') => {
            console.error(message, details);
            const appEl = getEl('#app');
            if (appEl) {
                appEl.innerHTML = `
                    <div class="bg-red-900 border border-red-700 text-red-200 p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-bold mb-3">Đã xảy ra lỗi hệ thống</h3>
                        <p class="text-lg mb-2">${message}</p>
                        ${details ? `<pre class="bg-gray-800 p-3 rounded-md text-sm text-red-300 overflow-auto">${details}</pre>` : ''}
                        <button onclick="window.location.hash = '#home'" class="mt-4 px-4 py-2 bg-lime-500 text-gray-900 font-bold rounded-lg hover:bg-lime-600 transition-colors">Về Trang Chủ</button>
                    </div>
                `;
            }
        };

        const showLoading = () => {
            const appEl = getEl('#app');
            if (appEl) {
                appEl.innerHTML = `
                    <div class="flex justify-center items-center h-[50vh]">
                        <svg class="animate-spin h-10 w-10 text-lime-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                `;
            }
        };
        
        const renderPage = (pageType, param) => {
            if (setupError) {showError(setupError.message, setupError.stack || '');return;}
            if (!db || !isGlobalCacheLoaded) {showLoading();return;}

            const cache = globalMovieCache; let results = []; let title = '';
            const HOME_PAGE_LIMIT = 12;

            switch (pageType) {
                case '#home':
                    const moiCapNhatList = cache.filter(a => a.status === 'dang-chieu').slice(0, HOME_PAGE_LIMIT);
                    const sapChieuList = cache.filter(a => a.status === 'sap-chieu').slice(0, HOME_PAGE_LIMIT);
                    const deCuList = cache.filter(a => a.status === 'tron-bo').slice(0, HOME_PAGE_LIMIT);
                    const heroMovie = moiCapNhatList.length > 0 ? moiCapNhatList[0] : (cache.length > 0 ? cache[0] : null);
                    getEl('#app').innerHTML = HeroSectionTemplate(heroMovie) + MovieSectionTemplate('Mới Cập Nhật', moiCapNhatList, '#genre/dang-chieu') + MovieSectionTemplate('Sắp Chiếu', sapChieuList, '#genre/sap-chieu') + MovieSectionTemplate('Đề Cử', deCuList, '#genre/tron-bo');
                    return;
                case '#login':
                    getEl('#app').innerHTML = AuthPageTemplate();
                    getEl('#google-login-btn')?.addEventListener('click', handleGoogleLogin);
                    return;
                case '#profile':
                    const user = auth?.currentUser;
                    if (!user || user.isAnonymous || !isGoogleAuth(user)) {
                        getEl('#app').innerHTML = `<div class="text-center text-gray-400"><h2 class="text-3xl font-bold text-white mb-6">Hồ Sơ</h2><p>Bạn cần <a href="#login" class="text-lime-400 hover:underline">Đăng Nhập bằng Google</a> để xem hồ sơ cá nhân.</p></div>`;
                        return;
                    }
                    getEl('#app').innerHTML = renderProfilePage(user);
                    getEl('#profile-update-form')?.addEventListener('submit', handleProfileUpdate);
                    return;
                case '#search':
                    title = `Kết quả tìm kiếm cho: "${param}"`;
                    const lowerCaseTerm = param.toLowerCase();
                    results = cache.filter(m => m.title.toLowerCase().includes(lowerCaseTerm) || (m.titleOriginal && m.titleOriginal.toLowerCase().includes(lowerCaseTerm)));
                    break;
                case '#genre':
                    const filter = param.toLowerCase();
                    title = `Thể loại: ${param.replace(/-/g, ' ')}`;
                    results = cache.filter(m => (m.formatType && m.formatType.toLowerCase() === filter) || (m.status && m.status.toLowerCase() === filter) || (m.genre && m.genre.toLowerCase().includes(filter.replace(/-/g, ' '))));
                    break;
                case '#top':
                    title = `Top ${param ? param.replace(/-/g, ' ') : 'Anime'} (Sắp xếp theo Lượt xem)`;
                    results = [...cache].sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
                    break;
                case '#season':
                    title = `Anime ${param ? decodeURIComponent(param).replace(/-/g, ' ') : 'Mùa (Mới nhất)'}`;
                    results = cache.filter(m => m.season && m.season.toLowerCase() === param.toLowerCase());
                    break;
                case '#library':
                    if (!auth?.currentUser || auth.currentUser.isAnonymous) {
                        getEl('#app').innerHTML = `<div class="text-center text-gray-400"><h2 class="text-3xl font-bold text-white mb-6">Thư Viện</h2><p>Bạn cần <a href="#login" class="text-lime-400 hover:underline">Đăng Nhập bằng Google</a> để xem thư viện cá nhân.</p></div>`;
                        return;
                    }
                    title = "Thư Viện (Phim đã thích)";
                    const likedMovieIds = Object.keys(currentUserLikeDocIds);
                    results = cache.filter(m => likedMovieIds.includes(m.id));
                    break;
                case '#schedule':
                    return renderSchedulePage();
                default:
                    window.location.hash = '#home';
                    return;
            }
            getEl('#app').innerHTML = SearchPageTemplate(results, title);
        };
        
        const router = (shouldUpdateHash = true) => {
            if (setupError) {showError(setupError.message, setupError.stack || '');return;}
            if (!isAuthInitialised) return;

            const activeHash = window.location.hash || '#home';
            const pathSegments = activeHash.substring(1).split('/');
            const primaryHash = '#' + pathSegments[0];
            
            getAllEl('.nav-active, .mobile-nav-active').forEach(el => el.classList.remove('nav-active', 'mobile-nav-active'));
            
            const navMap = { '#home': '#home', '#login': '#login', '#library': '#library', '#schedule': '#schedule', '#profile': '#profile' };
            const groupMap = { '#phim': '#home', '#search': '#home', '#genre': '#genre', '#top': '#top', '#season': '#season' };
            const targetHash = navMap[primaryHash] || groupMap[primaryHash];
            
            if (targetHash) {
                const selector = `.nav-link[href="${targetHash}"], .nav-link[data-hash-group="${targetHash}"], .mobile-nav-link[href="${targetHash}"], .mobile-nav-link[data-hash-group="${targetHash}"]`;
                getAllEl(selector).forEach(el => el.classList.add(el.classList.contains('nav-link') ? 'nav-active' : 'mobile-nav-active'));
            }

            if (primaryHash !== '#phim') {
                if (unsubscribeMovieListener) { unsubscribeMovieListener(); unsubscribeMovieListener = null; }
                if (unsubscribeReviewListener) { unsubscribeReviewListener(); unsubscribeReviewListener = null; }
                if (unsubscribePublicReviewsListener) { unsubscribePublicReviewsListener(); unsubscribePublicReviewsListener = null; }
            }
            
            if (primaryHash !== '#phim' && unsubscribeCommentsListener) { unsubscribeCommentsListener(); unsubscribeCommentsListener = null; }

            if (primaryHash === '#phim' && pathSegments.length >= 2) {
                const movieIdMatch = pathSegments[1].match(/-([a-zA-Z0-9]+)$/);
                const mId = movieIdMatch ? movieIdMatch[1] : null; 
                if (!mId) return showError("Lỗi URL.", "Không tìm thấy ID phim hợp lệ.");
                
                if (pathSegments.length === 2) {
                    renderInfoPage(mId);
                } else if (pathSegments.length === 3 && pathSegments[2].endsWith('.html')) {
                    const episodeMatch = pathSegments[2].match(/-([a-zA-Z0-9_]+)\.html$/); 
                    const episodeUniqueId = episodeMatch ? episodeMatch[1] : null;
                    if (episodeUniqueId) renderWatchPage(mId, episodeUniqueId);
                }
                return;
            }
            
            renderPage(primaryHash, pathSegments[1]);
        };
        
        const setupFirebase = async () => {
            if (!finalConfig.projectId) { setupError = new Error("Lỗi Cấu hình: 'projectId' không được cung cấp."); router(); return; }
            
            try {
                app = initializeApp(finalConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Lỗi đăng nhập bằng Custom Token:", e));
                } 

                onAuthStateChanged(auth, async (user) => {
                    let needsRerender = false;
                    
                    if (user) {
                        const oldUserId = userId;
                        userId = user.uid;
                        updatePaths(userId);

                        if (user.isAnonymous) {
                            userEmail = null; 
                            updateAuthStateUI(user);
                        } else if (isGoogleAuth(user)) {
                            userEmail = user.email;
                            await ensureUserProfile(user); 
                            updateAuthStateUI(user);
                        } else {
                            userEmail = user.email || 'Admin User'; 
                            updateAuthStateUI(user);
                        }
                        
                        if (oldUserId !== userId) {
                            await fetchUserLikes(true); 
                            needsRerender = true;
                        }

                    } else { 
                        if (userId !== null) {
                            userId = null; userEmail = null; updatePaths(null); currentUserLikeDocIds = {}; needsRerender = true;
                        }
                        updateAuthStateUI(null);
                    }
                    
                    if(!isAuthInitialised) {
                         isAuthInitialised = true;
                         loadInitialMovieCache(); 
                    } else if(needsRerender) {
                        router();
                    }
                });

                if (!auth.currentUser) {
                    try {
                        signInAnonymously(auth).catch(e => console.error("Lỗi đăng nhập ẩn danh:", e)); 
                    } catch (e) {
                        console.error("Lỗi đăng nhập ẩn danh:", e);
                        updatePaths(null); 
                    }
                }

            } catch (error) {
                console.error("Lỗi nghiêm trọng khi khởi tạo Firebase SDK:", error);
                setupError = new Error("Lỗi Khởi tạo Firebase SDK. Chi tiết: " + error.message);
                router();
            }
        };

        const loadInitialMovieCache = () => {
             if (!db || isGlobalCacheLoaded) return;
             
             try {
                const q = query(collection(db, dataCollectionPath));
                
                onSnapshot(q, (snapshot) => {
                    const movieList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    movieList.sort((a, b) => {
                        const timeA = b.lastEpisodeUpdate?.toMillis() || b.createdAt?.toMillis() || 0;
                        const timeB = a.lastEpisodeUpdate?.toMillis() || a.createdAt?.toMillis() || 0;
                        return timeA - timeB; 
                    });
                    
                    globalMovieCache = movieList;
                    const wasCacheLoaded = isGlobalCacheLoaded;
                    isGlobalCacheLoaded = true;
                    
                    if (!wasCacheLoaded || window.location.hash.startsWith('#home') || window.location.hash === '' || window.location.hash.startsWith('#schedule')) {
                        router(false);
                    }
                }, (error) => {
                    console.error("Lỗi khi tải danh sách phim (onSnapshot):", error);
                    isGlobalCacheLoaded = true;
                    showError("Lỗi tải dữ liệu phim.", error.message);
                });
             } catch (e) {
                 console.error("Lỗi nghiêm trọng khi gọi collection() (Kiểm tra dataCollectionPath):", e);
                 setupError = e;
                 router();
             }
        };
        
        const updateAuthStateUI = (user) => {
            const authButtonDesktop = getEl('#auth-button-desktop');
            const authButtonMobile = getEl('#auth-button-mobile');
            if (!authButtonDesktop || !authButtonMobile) return;

            if (!user || user.isAnonymous) {
                authButtonDesktop.innerHTML = `<a href="#login" class="text-gray-900 bg-lime-500 hover:bg-lime-600 px-4 py-2 rounded-md text-sm font-medium transition-colors">Đăng Nhập</a>`;
                authButtonMobile.innerHTML = `<a href="#login" class="block w-full text-center text-gray-900 bg-lime-500 hover:bg-lime-600 px-4 py-2 rounded-md text-sm font-medium transition-colors">Đăng Nhập</a>`;
                return;
            }

            if (isGoogleAuth(user)) {
                const displayName = user.displayName || user.email.split('@')[0];
                const photoURL = user.photoURL || `https://placehold.co/32x32/a3e635/111827?text=${displayName.charAt(0).toUpperCase()}`;

                authButtonDesktop.innerHTML = `
                    <div class="user-profile-dropdown">
                        <button id="profile-avatar-btn" class="flex items-center p-1 rounded-full bg-gray-700 hover:ring-2 hover:ring-lime-500 transition-shadow">
                            <img src="${photoURL}" alt="Avatar" class="w-10 h-10 rounded-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/40x40/a3e635/111827?text=${displayName.charAt(0).toUpperCase()}'">
                        </button>
                        <div id="user-dropdown-menu" class="user-dropdown-content">
                            <div class="p-4 border-b border-gray-600">
                                <p class="text-white font-bold">${displayName}</p>
                                <p class="text-gray-400 text-sm truncate">${user.email}</p>
                            </div>
                            <a href="#profile" id="profile-link-desktop" class="w-full text-left flex items-center px-4 py-2 text-lime-400 hover:bg-gray-700 hover:text-lime-300 transition-colors">
                                <ion-icon name="person-circle-outline" class="text-xl mr-2"></ion-icon>
                                Hồ Sơ
                            </a>
                            <button id="logout-button-desktop" class="w-full text-left flex items-center px-4 py-2 text-red-400 hover:bg-gray-700 hover:text-red-300 transition-colors">
                                <ion-icon name="log-out-outline" class="text-xl mr-2"></ion-icon>
                                Đăng Xuất
                            </button>
                        </div>
                    </div>
                `;
                
                authButtonMobile.innerHTML = `
                        <div class="flex items-center mb-3">
                            <img src="${photoURL}" alt="Avatar" class="w-10 h-10 rounded-full mr-3 object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/40x40/a3e635/111827?text=${displayName.charAt(0).toUpperCase()}'">
                            <p class="text-sm font-medium text-gray-300 truncate">Xin chào, <span class="text-lime-400">${displayName}</span></p>
                        </div>
                        <a href="#profile" class="block w-full text-center text-gray-900 bg-lime-500 hover:bg-lime-600 px-4 py-2 rounded-md text-sm font-medium transition-colors mb-3">
                            Hồ Sơ
                        </a>
                        <button id="logout-button-mobile" class="block w-full text-center text-gray-300 hover:text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md text-sm font-medium transition-colors">Đăng Xuất</button>`;
                
                getEl('#profile-avatar-btn')?.addEventListener('click', function() {getEl('#user-dropdown-menu')?.classList.toggle('active');});
                getEl('#logout-button-desktop')?.addEventListener('click', handleLogout);
                getEl('#logout-button-mobile')?.addEventListener('click', (e) => {handleLogout(e);getEl('#mobile-menu')?.classList.add('hidden');});
                getEl('#profile-link-desktop')?.addEventListener('click', () => {getEl('#user-dropdown-menu')?.classList.remove('active');});
            }
        };
        
        // === APP BOOTSTRAP ===
        
        window.addEventListener('hashchange', router);

        document.addEventListener('DOMContentLoaded', async () => {
            await setupFirebase();
            getEl('#resume-modal-yes')?.addEventListener('click', () => { window.hideResumeModal(); resolveResumeModal(true); });
            getEl('#resume-modal-no')?.addEventListener('click', () => { window.hideResumeModal(); resolveResumeModal(false); });
            getEl('#mobile-menu-button')?.addEventListener('click', () => getEl('#mobile-menu')?.classList.toggle('hidden'));
            
            getEl('#search-form-desktop')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const searchTerm = getEl('#search-input-desktop').value.trim();
                if (searchTerm) window.location.hash = `#search/${encodeURIComponent(searchTerm)}`;
            });
            getEl('#search-form-mobile')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const searchTerm = getEl('#search-input-mobile').value.trim();
                if (searchTerm) window.location.hash = `#search/${encodeURIComponent(searchTerm)}`;
                getEl('#mobile-menu')?.classList.add('hidden');
            });
            
            getAllEl('.mobile-dropdown-toggle').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = e.currentTarget.nextElementSibling;
                    target.classList.toggle('hidden');
                    target.classList.toggle('grid');
                    e.currentTarget.querySelector('.dropdown-icon')?.classList.toggle('rotate-180');
                });
            });
            
            getAllEl('#mobile-menu a').forEach(link => {
                link.addEventListener('click', function() {
                     if (!this.classList.contains('mobile-dropdown-toggle')) {getEl('#mobile-menu')?.classList.add('hidden');}
                });
            });
            
             document.body.addEventListener('submit', globalCommentSubmitHandler);
            
             document.addEventListener('click', function(e) {
                const userDropdown = getEl('.user-profile-dropdown');
                const userDropdownMenu = getEl('#user-dropdown-menu');
                if (userDropdown && userDropdownMenu && !userDropdown.contains(e.target)) {
                    userDropdownMenu.classList.remove('active');
                }
             });
        });
    </script>
    
    <style>
        /* Tùy chỉnh thanh cuộn cho webkit (Chrome, Safari) */
        ::-webkit-scrollbar {width: 12px;background-color: #1a202c;}
        ::-webkit-scrollbar-thumb {background-color: #a3e635;border-radius: 6px;border: 3px solid #1a202c;}
        ::-webkit-scrollbar-thumb:hover {background-color: #84cc16;}
        .comments-scroll-area, .schedule-scroll-area, .review-scroll-area {scrollbar-width: thin;scrollbar-color: #a3e635 #1a202c;}
        body {font-family: 'Inter', sans-serif;background-color: #111827;}
        #app {transition: opacity 0.3s ease-in-out;}
        .dropdown { position: relative; }
        .dropdown-content {display: none;position: absolute;top: 100%;left: 0;background-color: #374151;box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);z-index: 10;border-radius: 0 0 0.5rem 0.5rem;}
        .dropdown-content.mega-menu-3-cols-scroll {grid-template-columns: repeat(3, 1fr);gap: 0.5rem 1rem;padding: 1.5rem;min-width: 600px;max-height: 400px;overflow-y: auto;}
        .dropdown-content.mega-menu-3-cols-season {grid-template-columns: repeat(3, 1fr);gap: 1rem 1.5rem;padding: 1rem 1.5rem;min-width: 550px;max-height: 400px;overflow-y: auto;}
        @media (max-width: 768px) {.dropdown-content.mega-menu-3-cols-scroll, .dropdown-content.mega-menu-3-cols-season {min-width: unset;width: 100vw;left: -1rem;}}
        .dropdown:hover .dropdown-content { display: grid; }
        .dropdown-content a {color: #d1d5db;padding: 0.5rem 0;display: block;white-space: nowrap;}
        .dropdown-content.mega-menu-1-col {min-width: 250px;grid-template-columns: repeat(1, 1fr);padding: 1rem;gap: 0;}
        .dropdown-content.mega-menu-1-col a:hover { background-color: #4b5563; }
        .nav-link.nav-active {color: #a3e635;position: relative;}
        .nav-link.nav-active::after {content: '';position: absolute;bottom: -2px;left: 0;width: 100%;height: 4px;background-color: #a3e635;border-radius: 2px;}
        .mobile-nav-link.mobile-nav-active {background-color: #374151;color: #a3e635;font-weight: 700;}
        .dropdown-icon { transition: transform 0.2s ease-in-out; }
        #like-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .line-clamp-3 {overflow: hidden;display: -webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp: 3;}
        .user-profile-dropdown {position: relative;display: inline-block;cursor: pointer;align-self: center; }
        .user-dropdown-content {display: none;position: absolute;right: 0;top: 100%;margin-top: 0.75rem;background-color: #1f2937;min-width: 250px;box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);z-index: 100;border-radius: 0.5rem;border: 1px solid #374151;opacity: 0;transform: translateY(-10px);transition: opacity 0.2s ease-out, transform 0.2s ease-out;pointer-events: none;}
        .user-dropdown-content.active {display: block;opacity: 1;transform: translateY(0);pointer-events: auto;}
        .header-right-desktop {display: flex;align-items: center;height: 100%;}
        #search-form-desktop {flex-grow: 1;max-width: 600px;margin-right: 0.5rem;display: flex;align-items: center;}
        #search-input-desktop {width: 100%;padding-top: 0.5rem;padding-bottom: 0.5rem;}
        .h-20 .container > div {padding-top: 10px;padding-bottom: 10px;}
        .nav-link.header-nav-link {flex-shrink: 0;padding-top: 0;padding-bottom: 0;height: 100%;display: flex;align-items: center;}
        .overlay-style {transition: opacity 0.5s ease-in-out;cursor: pointer;}
        .overlay-style.fade-out {opacity: 0;pointer-events: none;}
        #video-player-container > * {width: 100%;height: 100%;}
        .play-button-overlay {background-color: rgba(163, 230, 53, 0.5);border: none;transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;animation: pulse-button-new 3s infinite;}
        .play-button-overlay:hover {background-color: rgba(163, 230, 53, 1);animation: none;transform: scale(1.05);}
        @keyframes pulse-button-new {0% { box-shadow: 0 0 0 0 rgba(163, 230, 53, 0.3); }50% { box-shadow: 0 0 0 10px rgba(163, 230, 53, 0); }100% { box-shadow: 0 0 0 0 rgba(163, 230, 53, 0.3); }}
        #mobile-menu {position: fixed;top: 80px;left: 0;right: 0;bottom: 0;background-color: #1f2937;overflow-y: auto;padding: 1rem;z-index: 40;}
        .mobile-dropdown-content {display: grid;grid-template-columns: repeat(2, 1fr);gap: 0.5rem;padding: 0.5rem 0;}
        @media (min-width: 640px) {.mobile-dropdown-content {grid-template-columns: repeat(3, 1fr);}}
        .mobile-dropdown-content a {background-color: #374151;border-radius: 0.375rem;font-weight: 400;padding: 0.5rem 0.75rem;}
        #cdn-failure-overlay {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: #111827;color: #f3f4f6;display: none;flex-direction: column;align-items: center;justify-content: center;text-align: center;z-index: 10000;padding: 20px;font-family: 'Inter', sans-serif, Arial;margin: 0;}
        .error-container {width: 100%;max-width: 750px;margin: 0 auto;padding: 20px;box-sizing: border-box;background: #1f2937;border-radius: 12px;box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);}
        .error-content-grid {display: grid;grid-template-columns: 1fr;gap: 20px;padding-bottom: 20px;}
        @media (min-width: 600px) {.error-content-grid {grid-template-columns: 2fr 1fr;}}
        .error-header {text-align: center;padding-bottom: 15px;border-bottom: 1px solid #374151;margin-bottom: 20px;grid-column: 1 / -1;}
        .error-header h1 {color: #f59e0b;font-size: 1.8rem;font-weight: 800;margin: 0;}
        .error-header p {font-size: 1rem;color: #9ca3af;margin-top: 5px;}
        .error-card {background: #374151;padding: 15px;border-radius: 8px;margin-bottom: 15px;box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);text-align: left;}
        .error-card h3 {color: #a3e635;font-size: 1.1rem;font-weight: 600;margin-top: 0;margin-bottom: 10px;border-bottom: 2px solid #a3e635;padding-bottom: 5px;}
        .error-card ul {list-style: none;padding: 0;margin: 0;}
        .error-card ul li {font-size: 0.95rem;color: #d1d5db;margin-bottom: 5px;position: relative;padding-left: 15px;}
        .error-card ul li::before {content: "•";color: #f59e0b;font-weight: bold;display: inline-block;width: 1em;margin-left: -1em;}
        .action-card {text-align: center;padding-top: 5px;grid-column: 1 / -1;}
        .action-link {display: inline-block;background-color: #a3e635;color: #111827;padding: 10px 20px;border-radius: 8px;text-decoration: none;font-weight: bold;transition: background-color 0.3s ease;box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);font-size: 1rem;}
        .action-link:hover {background-color: #84cc16;}
        .right-column {display: flex;flex-direction: column;align-items: center;justify-content: flex-start;gap: 15px;padding: 10px;background: #1f2937;border-radius: 8px;border: 1px dashed #374151;}
        @media (max-width: 599px) {.right-column {display: none;}}
        .komiko-logo {width: 100px;height: 100px;border-radius: 50%;margin: 0 auto;border: 3px solid #a3e635;}
        .apology-text {color: #f59e0b;font-size: 1.1rem;font-weight: 600;margin-top: 20px;grid-column: 1 / -1;}
        .contact-info {display: flex;align-items: center;justify-content: center;margin-top: 15px;}
        .contact-info a {color: #a3e635;text-decoration: none;font-size: 0.95rem;display: flex;align-items: center;transition: color 0.3s;}
        .contact-info a:hover {color: #84cc16;text-decoration: underline;}
        #rating-input-area .rating-star-icon {transition: color 0.2s;cursor: pointer;}
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div id="cdn-failure-overlay">
        <div class="error-container">
            <div class="error-header">
                <h1>Lỗi Hệ Thống FOXANIME 5xx!</h1>
                <p>Máy chủ đang gặp sự cố và không thể tải dữ liệu yêu cầu.</p>
            </div>
            <div class="error-content-grid">
                <div class="left-column">
                    <div class="error-card">
                        <h3>Chi tiết Sự cố</h3>
                        <p style="font-size:0.95rem; color:#d1d5db; margin-bottom: 10px;">**CDN/Network Failure**</p>
                        <p style="font-size:0.9rem; color:#9ca3af; margin:0;">Trang web không thể tải được các tài nguyên bên ngoài (CSS, fonts, icons) cần thiết để hiển thị giao diện chính.</p>
                    </div>
                    <div class="error-card" style="margin-bottom: 0;">
                        <h3>Nguyên nhân có thể</h3>
                        <ul>
                            <li>Lỗi mạng của Quý khách</li>
                            <li>Sự cố nhà cung cấp dịch vụ (ví dụ: Cloudflare CDN)</li>
                            <li>Lỗi kết nối từ máy chủ FOXANIME</li>
                            <li>Vấn đề bảo trì không báo trước</li>
                        </ul>
                    </div>
                </div>
                <div class="right-column">
                    <img src="https://uploads.onecompiler.io/43u4wb3ft/4452bnsfd/KomikoAI.jpg" alt="KomikoAI Logo" class="komiko-logo" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/d1d5db?text=KOMIKO'">
                    <div class="error-card" style="margin-bottom: 0; width: 100%; text-align: center;">
                        <h3>Khôi phục Tự động</h3>
                        <p style="font-size:0.95rem; color:#d1d5db; margin-bottom: 10px;">Hệ thống sẽ thử lại tự động sau 15 giây.</p>
                        <a href="javascript:location.reload()" class="action-link" style="font-size: 0.9rem; padding: 8px 15px;">Tải lại trang ngay</a>
                    </div>
                    <div class="contact-info" style="margin-top: 0;">
                         <a href="mailto:haistrem6792@gmail.com">
                            <ion-icon name="mail-outline" style="font-size: 1.2rem; margin-right: 5px;"></ion-icon>
                            Liên hệ ngay
                        </a>
                    </div>
                </div>
            </div>
            <p class="apology-text">Thành thật xin lỗi vì sự bất tiện này!</p>
        </div>
    </div>

<div id="browser-warning-modal" class="fixed inset-0 bg-black/80 items-center justify-center z-[9999] backdrop-blur-sm font-sans" style="display: none;">
        <div class="relative p-8 rounded-xl w-full max-w-lg mx-4 text-center bg-gray-800 border-2 border-red-500 shadow-[0_0_30px_rgba(239,68,68,0.6)]">
            
            <!-- Logo Chính (Hiệu ứng khung vàng) -->
            <img src="https://uploads.onecompiler.io/43u4wb3ft/445etdc2s/KomikoAI%20(1)c%E1%BA%A3nhbao.jpg" 
                 alt="Cảnh báo Komiko AI" 
                 class="mx-auto mb-6 w-40 h-40 object-cover rounded-full border-4 border-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.6)]" 
                 onerror="this.onerror=null;this.src='https://placehold.co/160x160/f59e0b/111827?text=Warning';" />
            
            <h3 class="text-3xl font-extrabold text-white mb-4"> ⚠️CHÚ Ý QUAN TRỌNG!⚠️</h3>
            <p class="text-xl text-yellow-400 mb-6 font-semibold">
                Bạn đang dùng Edge và gặp lỗi video?
            </p>
            
            <p class="text-gray-300 mb-6 text-lg">
                Để có trải nghiệm xem phim mượt mà và ổn định nhất FoxAnime khuyến nghị:
            </p>
            
            <div class="flex justify-center items-center space-x-6 mb-2 text-white">
                 <div class="text-center">
                    <img src="https://static.vecteezy.com/system/resources/previews/022/484/505/original/google-chrome-icon-logo-symbol-free-png.png" 
                         alt="Chrome" class="w-12 h-12 object-contain mx-auto rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/48x48/4285F4/ffffff?text=C'" />
                    <p class="text-sm font-semibold mt-1">Chrome</p>
                 </div>
                 <div class="text-center">
                    <img src="https://images-eds-ssl.xboxlive.com/image?url=4rt9.lXDC4H_93laV1_eHHFT949fUipzkiFOBH3fAiZZUCdYojwUyX2aTonS1aIwMrx6NUIsHfUHSLzjGJFxxtj3WMWEcdizFJ_lWFKualPWxv8XgjhnjQcY4q6p8oU2bIsTOD2JpDRIDQ2oI6DDRNllQJi9sB9jOaxLSd5Fix8-&format=source" 
                         alt="Cốc Cốc" class="w-12 h-12 object-contain mx-auto rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/48x48/009688/ffffff?text=CC'">
                    <p class="text-sm font-semibold mt-1">Cốc Cốc</p>
                 </div>
                 <div class="text-center">
                    <img src="https://th.bing.com/th/id/OSAAS.CAEDCF679CE094D1FA12A2EFD5427542?w=72&h=72&c=17&rs=1&o=6&dpr=1.3&pid=TechQna" 
                         alt="Firefox" class="w-12 h-12 object-contain mx-auto rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/48x48/FF7100/ffffff?text=F'" />
                    <p class="text-sm font-semibold mt-1">Firefox</p>
                 </div>
            </div>

            <p class="text-sm text-gray-500 mb-6 italic">và còn nhiều trình duyệt khác</p>

            <!-- Lời xin lỗi chủ nhân yêu cầu đây ạ -->
            <p class="text-gray-300 mb-6 italic">
                FoxAnime chân thành xin lỗi vì sự bất tiện này!😓
            </p>
            
            <button onclick="closeWarningModal()" 
                    class="bg-lime-500 hover:bg-lime-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition-colors text-lg shadow-xl cursor-pointer">
                TÔI ĐÃ HIỂU (Đóng)
            </button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var isEdge = /Edg/.test(navigator.userAgent);
            var hasClosed = sessionStorage.getItem('hideEdgeWarning') === 'true';

            if (isEdge && !hasClosed) {
                document.getElementById('browser-warning-modal').style.display = 'flex';
            }
        });

        function closeWarningModal() {
            document.getElementById('browser-warning-modal').style.display = 'none';
            sessionStorage.setItem('hideEdgeWarning', 'true');
        }
    </script>


    <div id="resume-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-sm mx-4 shadow-2xl text-center border border-lime-400">
            <h3 class="text-xl font-bold text-lime-400 mb-4">Xem Tiếp Phim</h3>
            <p id="resume-modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="resume-modal-yes" class="bg-lime-500 hover:bg-lime-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition-colors">Xem tiếp</button>
                <button id="resume-modal-no" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Xem từ đầu</button>
            </div>
        </div>
    </div>

    <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center h-full space-x-8">
                    <a href="#home" class="flex-shrink-0 flex items-center space-x-2 h-full">
                        <img src="https://uploads.onecompiler.io/43u4wb3ft/4452q4hvx/KomikoAIolog%20(1).jpg" alt="FOXANIME Logo" class="w-14 h-14 object-contain">
                        <span class="text-4xl font-extrabold text-white">FOX<span class="text-lime-500">ANIME</span></span>
                    </a>
                </div>

                <div class="hidden lg:flex items-center space-x-4 header-right-desktop h-full">
                    <form id="search-form-desktop" class="relative flex-grow flex items-center">
                        <input id="search-input-desktop" type="text" placeholder="Tìm kiếm anime..." 
                            class="bg-gray-700 text-white px-4 py-2 rounded-full w-full focus:outline-none focus:ring-2 focus:ring-lime-500 focus:bg-gray-600 transition-all" autocomplete="off">
                        <button type="submit" class="absolute right-0 top-0 h-full px-3 text-gray-400 hover:text-lime-400 flex items-center justify-center">
                            <ion-icon name="search-outline"></ion-icon>
                        </button>
                    </form>
                    
                    <div id="auth-button-desktop" class="flex items-center h-full flex-shrink-0">
                        <a href="#login" class="text-gray-900 bg-lime-500 hover:bg-lime-600 px-4 py-2 rounded-md text-sm font-medium transition-colors">Đăng Nhập</a>
                    </div>
                </div>

                <div class="lg:hidden flex items-center">
                    <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-lime-500" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Mở menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>

            <nav class="hidden lg:flex py-3 border-t border-gray-700/50">
                <div class="flex space-x-6 items-center">
                    <a href="#home" class="nav-link text-gray-300 hover:text-lime-400 text-sm font-medium uppercase tracking-wider transition-colors">Trang Chủ</a>
                    
                    <div class="dropdown">
                        <a href="#genre" data-hash-group="#genre" class="nav-link flex items-center text-gray-300 hover:text-lime-400 text-sm font-medium uppercase tracking-wider transition-colors">
                            Dạng Anime
                            <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </a>
                        <div class="dropdown-content mega-menu-1-col">
                            <a href="#genre/tv-series">TV/Series</a>
                            <a href="#genre/movie-ova">Movie/OVA</a>
                            <a href="#genre/hh-trung-quoc">HH Trung Quốc</a>
                            <a href="#genre/anime-tron-bo">Anime Trọn Bộ</a>
                        </div>
                    </div>

                    <div class="dropdown">
                        <a href="#top" data-hash-group="#top" class="nav-link flex items-center text-gray-300 hover:text-lime-400 text-sm font-medium uppercase tracking-wider transition-colors">
                            Top Anime
                            <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </a>
                        <div class="dropdown-content mega-menu-1-col">
                            <a href="#top/ngay">Top Ngày</a>
                            <a href="#top/tuan">Top Tuần</a>
                            <a href="#top/thang">Top Tháng</a>
                            <a href="#top/nam">Top Năm</a>
                        </div>
                    </div>
                    
                    <div class="dropdown">
                        <a href="#genre" data-hash-group="#genre" class="nav-link flex items-center text-gray-300 hover:text-lime-400 text-sm font-medium uppercase tracking-wider transition-colors">
                            Thể Loại
                            <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </a>
                        <div class="dropdown-content mega-menu-3-cols-scroll">
                            <div class="col-span-full mb-2 border-b border-gray-600 pb-1">
                                <span class="text-lime-400 font-bold text-xs uppercase block mb-1">Phổ Biến</span>
                                <div class="grid grid-cols-3 gap-x-4">
                                    <a href="#genre/action" class="font-bold text-lime-300 hover:text-lime-500">Action</a>
                                    <a href="#genre/romance" class="font-bold text-lime-300 hover:text-lime-500">Romance</a>
                                    <a href="#genre/comedy" class="font-bold text-lime-300 hover:text-lime-500">Comedy</a>
                                </div>
                            </div>
                            <a href="#genre/adventure">Adventure</a>
                            <a href="#genre/boys-love">Boys Love</a>
                            <a href="#genre/cartoon">Cartoon</a>
                            <a href="#genre/dementia">Dementia</a>
                            <a href="#genre/demons">Demons</a>
                            <a href="#genre/drama">Drama</a>
                            <a href="#genre/ecchi">Ecchi</a>
                            <a href="#genre/demons">Ecchi</a>
                            <a href="#genre/fantasy">Fantasy</a>
                            <a href="#genre/game">Game</a>
                            <a href="#genre/harem">Harem</a>
                            <a href="#genre/historical">Historical</a>
                            <a href="#genre/horror">Horror</a>
                            <a href="#genre/josei">Josei</a>
                            <a href="#genre/kids">Kids</a>
                            <a href="#genre/live-action">Live Action</a>
                            <a href="#genre/magic">Magic</a>
                            <a href="#genre/martial-arts">Martial Arts</a>
                            <a href="#genre/mecha">Mecha</a>
                            <a href="#genre/military">Military</a>
                            <a href="#genre/music">Music</a>
                            <a href="#genre/mystery">Mystery</a>
                            <a href="#genre/parody">Parody</a>
                            <a href="#genre/police">Police</a>
                            <a href="#genre/psychological">Psychological</a>
                            <a href="#genre/samurai">Samurai</a>
                            <a href="#genre/school">School</a>
                            <a href="#genre/sci-fi">Sci-Fi</a>
                            <a href="#genre/seinen">Seinen</a>
                            <a href="#genre/shoujo">Shoujo</a>
                            <a href="#genre/shoujo-ai">Shoujo Ai</a>
                            <a href="#genre/shounen">Shounen</a>
                            <a href="#genre/shounen-ai" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Shounen Ai</a>
                            <a href="#genre/slice-of-life" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Slice of Life</a>
                            <a href="#genre/space" class="text-gray-300 hover:text-lime-400">Space</a>
                            <a href="#genre/sports" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Sports</a>
                            <a href="#genre/super-power" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Super Power</a>
                            <a href="#genre/supernatural" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Supernatural</a>
                            <a href="#genre/suspense" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Suspense</a>
                            <a href="#genre/thriller" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Thriller</a>
                            <a href="#genre/tokusatsu" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Tokusatsu</a>
                            <a href="#genre/vampire" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Vampire</a>
                            <a href="#genre/yaoi" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Yaoi</a>
                            <a href="#genre/yuri" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Yuri</a>
                        </div>
                    </div>

                    <div class="dropdown">
                         <a href="#season" data-hash-group="#season" class="nav-link flex items-center text-gray-300 hover:text-lime-400 text-sm font-medium uppercase tracking-wider transition-colors">
                            Season
                            <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </a>
                        <div class="dropdown-content mega-menu-3-cols-season">
                            
                            <div>
                                <span class="text-lime-400 font-bold text-sm uppercase block mb-1 border-b border-gray-600 pb-1">Năm 2026</span>
                                <a href="#season/mua-xuan-2026" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Xuân</a>
                                <a href="#season/mua-he-2026" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Hè</a>
                                <a href="#season/mua-thu-2026" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Thu</a>
                                <a href="#season/mua-dong-2026" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Đông</a>
                            </div>

                            <div>
                                <span class="text-lime-400 font-bold text-sm uppercase block mb-1 border-b border-gray-600 pb-1">Năm 2025</span>
                                <a href="#season/mua-xuan-2025" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Xuân</a>
                                <a href="#season/mua-he-2025" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Hè</a>
                                <a href="#season/mua-thu-2025" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Thu</a>
                                <a href="#season/mua-dong-2025" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Đông</a>
                            </div>
                            
                            <div>
                                <span class="text-lime-400 font-bold text-sm uppercase block mb-1 border-b border-gray-600 pb-1">Năm 2024</span>
                                <a href="#season/mua-xuan-2024" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Xuân</a>
                                <a href="#season/mua-he-2024" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Hè</a>
                                <a href="#season/mua-thu-2024" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Thu</a>
                                <a href="#season/mua-dong-2024" class="hover:bg-gray-600 rounded-md block px-1 py-1">Mùa Đông</a>
                            </div>
                            
                        </div>
                    </div>
                    
                    <a href="#library" class="nav-link text-gray-300 hover:text-lime-400 text-sm font-medium uppercase tracking-wider transition-colors">Thư Viện</a>
                    <a href="#schedule" class="nav-link text-gray-300 hover:text-lime-400 text-sm font-medium uppercase tracking-wider transition-colors">Lịch Chiếu</a>
                </div>
            </nav>
        </div>

        <div class="lg:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#home" class="mobile-nav-link text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Trang Chủ</a>
                
                <div>
                    <button class="mobile-nav-link mobile-dropdown-toggle w-full flex justify-between items-center text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-base font-medium" data-hash-group="#genre">
                        <span>Dạng Anime</span>
                        <svg class="dropdown-icon w-5 h-5 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="mobile-dropdown-content pl-4 mt-1 space-y-1 hidden">
                        <a href="#genre/tv-series" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">TV/Series</a>
                        <a href="#genre/movie-ova" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Movie/OVA</a>
                        <a href="#genre/hh-trung-quoc" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">HH Trung Quốc</a>
                        <a href="#genre/anime-tron-bo" class="block text-gray-400 hover:bg-gray-600 hover:text-white px-3 py-2 rounded-md text-sm">Anime Trọn Bộ</a>
                    </div>
                </div>
                
                 <div>
                    <button class="mobile-nav-link mobile-dropdown-toggle w-full flex justify-between items-center text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-base font-medium" data-hash-group="#season">
                        <span>Season</span>
                        <svg class="dropdown-icon w-5 h-5 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="mobile-dropdown-content pl-4 mt-1 hidden grid-cols-2">
                        
                        <div class="col-span-full pt-1 pb-1 border-b border-gray-700">
                             <span class="text-lime-400 font-bold text-xs uppercase block">Năm 2026</span>
                             <a href="#season/mua-xuan-2026" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Xuân 2026</a>
                             <a href="#season/mua-he-2026" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Hè 2026</a>
                             <a href="#season/mua-thu-2026" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Thu 2026</a>
                             <a href="#season/mua-dong-2026" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Đông 2026</a>
                        </div>
                        <div class="col-span-full pt-1 pb-1 border-b border-gray-700">
                             <span class="text-lime-400 font-bold text-xs uppercase block">Năm 2025</span>
                             <a href="#season/mua-xuan-2025" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Xuân 2025</a>
                             <a href="#season/mua-he-2025" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Hè 2025</a>
                             <a href="#season/mua-thu-2025" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Thu 2025</a>
                             <a href="#season/mua-dong-2025" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Đông 2025</a>
                        </div>
                        <div class="col-span-full pt-1 pb-1 border-b border-gray-700">
                             <span class="text-lime-400 font-bold text-xs uppercase block">Năm 2024</span>
                             <a href="#season/mua-xuan-2024" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Xuân 2024</a>
                             <a href="#season/mua-he-2024" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Hè 2024</a>
                             <a href="#season/mua-thu-2024" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Thu 2024</a>
                             <a href="#season/mua-dong-2024" class="block text-gray-400 hover:bg-gray-600 hover:text-white py-1 text-sm">Đông 2024</a>
                        </div>
                    </div>
                </div>

                <a href="#library" class="mobile-nav-link text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Thư Viện</a>
                <a href="#schedule" class="mobile-nav-link text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Lịch Chiếu</a>
            </div>
            <div class="px-5 pb-3">
                <form id="search-form-mobile">
                    <input id="search-input-mobile" type="text" placeholder="Tìm kiếm anime..." class="bg-gray-700 text-white px-4 py-2 rounded-full w-full focus:outline-none focus:ring-2 focus:ring-lime-500 focus:bg-gray-600 transition-all" autocomplete="off">
                </form>
            </div>
            <div id="auth-button-mobile" class="px-5 pb-5 pt-3 border-t border-gray-700">
                <a href="#login" class="block w-full text-center text-gray-900 bg-lime-500 hover:bg-lime-600 px-4 py-2 rounded-md text-sm font-medium transition-colors">Đăng Nhập</a>
            </div>
        </div>
    </header>

    <main id="app" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 min-h-screen">
        <div class="flex justify-center items-center h-[50vh]">
            <svg class="animate-spin h-10 w-10 text-lime-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </main>

    <!-- Footer -->
    <footer class="relative bg-gray-800 pt-16 pb-8 border-t border-gray-700 mt-12 overflow-hidden">
        <!-- Hiệu ứng nền trang trí (Background Glow) -->
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-full h-1 bg-gradient-to-r from-transparent via-lime-500 to-transparent opacity-50"></div>
        <div class="absolute -top-24 left-1/4 w-96 h-96 bg-lime-500/10 rounded-full blur-3xl pointer-events-none"></div>
        <div class="absolute -bottom-24 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl pointer-events-none"></div>

        <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            
            <!-- PHẦN 1: LOGO & NEWSLETTER -->
            <div class="flex flex-col lg:flex-row justify-between items-center mb-12 gap-8">
                <!-- Logo -->
                <div class="flex items-center space-x-4 group cursor-pointer">
                    <div class="relative">
                        <div class="absolute inset-0 bg-lime-400 blur opacity-20 group-hover:opacity-40 transition-opacity duration-300 rounded-lg"></div>
                        <img src="https://uploads.onecompiler.io/43u4wb3ft/4452q4hvx/KomikoAIolog%20(1).jpg" 
                             alt="FOXANIME Logo" 
                             class="w-16 h-16 object-contain rounded-lg shadow-xl relative z-10">
                    </div>
                    <div>
                        <span class="text-4xl font-extrabold text-white tracking-wide block leading-none">
                            FOX<span class="text-lime-500">ANIME</span>
                        </span>
                        <span class="text-sm text-gray-400 tracking-wider">Thế giới Anime trong tầm tay</span>
                    </div>
                </div>

                <!-- Newsletter -->
                <div class="w-full max-w-md bg-gray-700/30 p-1.5 rounded-full border border-gray-600 flex items-center focus-within:border-lime-500/70 focus-within:ring-2 focus-within:ring-lime-500/20 transition-all">
                    <input type="email" placeholder="Nhập email để nhận Anime mới..." class="bg-transparent border-none outline-none text-white px-4 py-2 w-full placeholder-gray-500 text-sm">
                    <button class="bg-lime-500 hover:bg-lime-400 text-gray-900 font-bold py-2 px-6 rounded-full transition-colors duration-300 whitespace-nowrap text-sm">
                        Đăng ký
                    </button>
                </div>
            </div>

            <!-- PHẦN DONATE (MỚI THÊM) -->
            <div class="mb-12 p-6 rounded-2xl bg-gradient-to-r from-lime-500/20 to-purple-500/20 border border-lime-500/30 relative overflow-hidden group">
                <div class="absolute inset-0 bg-[url('https://uploads.onecompiler.io/43u4wb3ft/445btd8v7/KomikoAI%20donate(1).jpg')] bg-cover bg-center opacity-10 group-hover:opacity-20 transition-opacity duration-500 mix-blend-overlay"></div>
                <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <img src="https://uploads.onecompiler.io/43u4wb3ft/445btd8v7/KomikoAI%20donate(1).jpg" 
                             alt="DONATE Logo" 
                             class="w-20 h-20 object-cover rounded-full shadow-lg ring-4 ring-lime-500/50 animate-pulse">
                        <div>
                            <h3 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-lime-400 to-white">DONATE NGAY TẠI ĐÂY!</h3>
                            <p class="text-gray-300 text-sm mt-1">Ủng hộ FoxAnime để chúng mình có thêm động lực phát triển nhé! ♡</p>
                        </div>
                    </div>
                    <a href="donate.html" class="px-8 py-3 bg-gradient-to-r from-lime-500 to-lime-600 hover:from-lime-600 hover:to-lime-700 text-white font-bold rounded-full shadow-lg shadow-lime-500/30 transform hover:scale-105 transition-all duration-300 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                        </svg>
                        Ủng hộ ngay
                    </a>
                </div>
            </div>

            <!-- PHẦN 2: CÁC NHÓM CỘNG ĐỒNG (GRID) -->
            <div class="mb-4 text-sm font-semibold text-gray-400 uppercase tracking-wider text-center lg:text-left">Tham Gia Cộng đồng của chúng tôi</div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
                
                <!-- FoxAnime - Fandom -->
                <a href="https://www.facebook.com/share/g/17PEyLkhgp/" target="_blank" class="group flex items-center p-3 rounded-xl bg-gray-700/40 border border-gray-600/50 hover:bg-gray-700 hover:border-lime-500/50 transition-all duration-300">
                    <img src="https://th.bing.com/th/id/ODF.FFsV6sq1f2tH6MPAliUvzw?w=32&h=32&qlt=90&pcl=fffffa&o=6&pid=1.2" alt="Fandom" class="w-10 h-10 rounded-full mr-3 ring-2 ring-transparent group-hover:ring-lime-400 transition-all">
                    <div>
                        <div class="font-bold text-gray-200 group-hover:text-lime-400 text-sm">FoxAnime Fandom</div>
                        <div class="text-xs text-gray-400">Group Facebook</div>
                    </div>
                </a>

                <!-- FoxStudioLive -->
                <a href="https://youtube.com/@foxstudio7556?si=4-JPjZZcvCJrUdKX" target="_blank" class="group flex items-center p-3 rounded-xl bg-gray-700/40 border border-gray-600/50 hover:bg-gray-700 hover:border-lime-500/50 transition-all duration-300">
                    <img src="https://th.bing.com/th/id/ODF.MrzzDTMlZsq_k5DWWmv7Hw?w=32&h=32&qlt=90&pcl=fffffc&o=6&pid=1.2" alt="Live" class="w-10 h-10 rounded-full mr-3 ring-2 ring-transparent group-hover:ring-lime-400 transition-all">
                    <div>
                        <div class="font-bold text-gray-200 group-hover:text-lime-400 text-sm">FoxStudioLive</div>
                        <div class="text-xs text-gray-400">Kênh YouTube</div>
                    </div>
                </a>

                <!-- Discord -->
                <a href="https://discord.gg/89UxfT4V" target="_blank" class="group flex items-center p-3 rounded-xl bg-gray-700/40 border border-gray-600/50 hover:bg-gray-700 hover:border-lime-500/50 transition-all duration-300">
                    <img src="https://th.bing.com/th/id/ODF.xXp47-dBXlzjKRnoX3v0kQ?w=32&h=32&qlt=90&pcl=fffffa&o=6&pid=1.2" alt="Discord" class="w-10 h-10 rounded-full mr-3 ring-2 ring-transparent group-hover:ring-lime-400 transition-all">
                    <div>
                        <div class="font-bold text-gray-200 group-hover:text-lime-400 text-sm">Discord Server</div>
                        <div class="text-xs text-gray-400">Tham gia ngay!</div>
                    </div>
                </a>

                <!-- Liên hệ -->
                <a href="mailto:haistrem6792@gmail.com" class="group flex items-center p-3 rounded-xl bg-gray-700/40 border border-gray-600/50 hover:bg-gray-700 hover:border-lime-500/50 transition-all duration-300">
                    <img src="https://th.bing.com/th/id/ODF.bm0RV3rptAC68RsyIbn_wQ?w=32&h=32&qlt=90&pcl=fffffc&o=6&pid=1.2" alt="Contact" class="w-10 h-10 rounded-full mr-3 ring-2 ring-transparent group-hover:ring-lime-400 transition-all">
                    <div>
                        <div class="font-bold text-gray-200 group-hover:text-lime-400 text-sm">Liên hệ Quảng Cáo</div>
                        <div class="text-xs text-gray-400 truncate w-32">foxstudio299@...</div>
                    </div>
                </a>
            </div>

            <!-- PHẦN 3: BOTTOM FOOTER (Socials & Copyright) -->
            <div class="border-t border-gray-700 pt-8 flex flex-col md:flex-row justify-between items-center gap-6">
                
                <!-- Social Icons (Đã thay bằng SVG trực tiếp để đảm bảo hiển thị) -->
                <div class="flex space-x-4">
                    <!-- Facebook -->
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 hover:bg-blue-600 hover:text-white transition-all transform hover:-translate-y-1">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                    </a>
                    
                    <!-- Instagram -->
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 hover:bg-pink-500 hover:text-white transition-all transform hover:-translate-y-1">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                    </a>
                    
                    <!-- YouTube -->
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 hover:bg-red-600 hover:text-white transition-all transform hover:-translate-y-1">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                        </svg>
                    </a>
                    
                    <!-- TikTok -->
                    <a href="#" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 hover:bg-black hover:text-white border border-transparent hover:border-gray-600 transition-all transform hover:-translate-y-1">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93v6.16c0 3.13-2.47 5.67-5.59 5.67h-.1c-2.91-.18-5.32-2.48-5.53-5.38-.2-2.73 1.69-5.18 4.34-5.63.13-.02.26-.03.39-.03v4.19c-.33 0-.66.07-.97.2-.67.29-1.07 1-1.07 1.77 0 1.09.89 1.98 1.98 1.98 1.09 0 1.98-.89 1.98-1.98v-15.03z"/>
                        </svg>
                    </a>
                </div>

                <!-- Copyright & Legal -->
                <div class="text-center md:text-right">
                    <div class="text-gray-500 text-sm mb-2">
                        <a href="#" class="hover:text-lime-400 transition-colors">Điều khoản sử dụng</a>
                        <span class="mx-2">•</span>
                        <a href="#" class="hover:text-lime-400 transition-colors">Chính sách bảo mật</a>
                        <span class="mx-2">•</span>
                        <a href="#" class="hover:text-lime-400 transition-colors">DMCA</a>
                    </div>
                    <p class="text-gray-400 text-sm">
                        &copy; 2025. Bản quyền thuộc về <span class="text-lime-400 font-bold">Foxstudio.co.Ltd</span>.
                    </p>
                </div>
            </div>
        </div>
    </footer>

</body>
</html>