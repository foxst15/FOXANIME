<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://uploads.onecompiler.io/43u4wb3ft/4452q4hvx/KomikoAIolog%20(1).jpg">
    <title>ADMIN NII-CHAN FOXANIME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        const RELOAD_INTERVAL = 15000;

        function checkTailwindLoadAndShowFallback() {
            let isTailwindLoaded = false;
            try {
                const testEl = document.createElement('div');
                testEl.className = 'opacity-100'; 
                testEl.style.display = 'none';
                document.body.appendChild(testEl);
                
                const computedStyle = window.getComputedStyle(testEl);
                isTailwindLoaded = computedStyle.opacity === '1'; 
                document.body.removeChild(testEl);
            } catch (e) {
                 console.error("Lỗi khi kiểm tra Tailwind:", e);
            }

            if (!isTailwindLoaded) {
                const overlay = document.getElementById('cdn-failure-overlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                }
                const mainAdminView = document.getElementById('admin-main-view');
                const authPage = document.getElementById('auth-page');
                const loadingOverlay = document.getElementById('loading-overlay');
                
                if (mainAdminView) mainAdminView.style.display = 'none'; 
                if (authPage) authPage.style.display = 'none';
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                
                setTimeout(() => {
                    location.reload();
                }, RELOAD_INTERVAL);
            }
        }
        
        window.addEventListener('load', () => {
            setTimeout(checkTailwindLoadAndShowFallback, 300); 
        });
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a0f3d;
            color: #e0e7ff;
            min-height: 100vh;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2f1d56; }
        ::-webkit-scrollbar-thumb { background: #00ffaa; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00cc88; }
        
        .neon-glow {
            text-shadow: 0 0 5px #00ffaa, 0 0 10px #00ffaa;
        }
        .panel-border {
            border: 2px solid #5d3f9e;
            box-shadow: 0 0 10px rgba(93, 63, 158, 0.5), 0 0 20px rgba(0, 255, 170, 0.1);
        }
        .anime-button {
            transition: all 0.2s ease-in-out;
            transform: scale(1);
            position: relative;
        }
        .anime-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.7);
        }
        .anime-button:active {
             transform: scale(0.95);
        }
        /* MOVIE CARD STYLES MODIFIED FOR ADMIN BADGE */
        .movie-card-anime {
            transition: all 0.3s ease-in-out;
            border-left: 5px solid transparent;
            position: relative; /* Cho phép định vị tuyệt đối con */
            overflow: hidden;
        }
        .movie-card-anime:hover {
            transform: translateX(5px);
            border-left-color: #ff69b4;
        }
        .admin-badge-corner {
            position: absolute;
            top: 0;
            right: 0;
            background: linear-gradient(135deg, #2f1d56 0%, #ff69b4 100%);
            color: white;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: bold;
            border-bottom-left-radius: 10px;
            border-left: 1px solid #ff69b4;
            border-bottom: 1px solid #ff69b4;
            z-index: 10;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.5);
        }

        .genre-tag {
            background-color: #5d3f9e;
            color: #e0e7ff;
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 4px 8px;
            border-radius: 6px;
            background-color: #2f1d56;
            color: #e0e7ff;
        }
        .genre-tag:hover {
            border-color: #00ffaa;
        }
        .genre-tag.selected {
            background-color: #ff69b4;
            color: #1a0f3d;
            font-weight: 700;
            border-color: #ff69b4;
        }
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-file-input::before {
            content: 'Chọn tệp (Max 700KB)';
            display: inline-block;
            background: #5d3f9e;
            border: 1px solid #00ffaa;
            border-radius: 5px;
            padding: 5px 8px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            color: #00ffaa;
        }
        .custom-file-input:hover::before {
            background: #00ffaa;
            color: #1a0f3d;
        }
        
        .form-input {
            @apply transition duration-150 ease-in-out shadow-sm appearance-none border border-[#5d3f9e] rounded w-full py-2 px-3 leading-tight focus:outline-none focus:ring-2 focus:ring-[#ff69b4];
            background-color: white; 
            color: #111827 !important;
        }

        textarea.form-input {
            background-color: white;
            color: #111827 !important;
        }
        
        .form-input option {
            color: #111827; 
        }
        
        .schedule-grid-container {
             display: grid; 
             grid-template-columns: 1fr;
             gap: 1.5rem;
             width: 100%;
        }
        @media (min-width: 700px) {
            .schedule-grid-container { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 1100px) {
            .schedule-grid-container { grid-template-columns: repeat(4, 1fr); }
        }
        
        .episode-list-scroll {
            max-height: 130px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .episode-list-scroll::-webkit-scrollbar { width: 5px; }
        .episode-list-scroll::-webkit-scrollbar-thumb { background: #5d3f9e; border-radius: 3px; }
        
        .filter-bar-container {
            background: #2f1d56;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #5d3f9e;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .pagination-btn {
            background: #1a0f3d;
            border: 1px solid #00ffaa;
            color: #00ffaa;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #00ffaa;
            color: #1a0f3d;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: gray;
            color: gray;
        }

        #cdn-failure-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a0f3d;
            color: #e0e7ff;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 10000;
            padding: 20px;
            font-family: 'Inter', sans-serif, Arial;
            margin: 0;
        }
        
        .error-container {
            width: 100%;
            max-width: 750px; 
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            background: #2f1d56;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(93, 63, 158, 0.5), 0 0 20px rgba(0, 255, 170, 0.1);
            border: 2px solid #5d3f9e;
        }
        
        .error-content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding-bottom: 20px;
        }
        @media (min-width: 600px) {
             .error-content-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        .error-header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #5d3f9e;
            margin-bottom: 20px;
            grid-column: 1 / -1; 
        }
        .error-header h1 {
            color: #ff69b4;
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            text-shadow: 0 0 5px #ff69b4, 0 0 10px rgba(255, 105, 180, 0.5);
        }
        .error-header p {
            font-size: 1rem;
            color: #e0e7ff;
            margin-top: 5px;
        }

        .error-card {
            background: #1a0f3d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: left; 
        }
        .error-card h3 {
            color: #00ffaa;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #00ffaa;
            padding-bottom: 5px;
        }
        .error-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .error-card ul li {
            font-size: 0.95rem;
            color: #e0e7ff;
            margin-bottom: 5px;
            position: relative;
            padding-left: 15px;
        }
        .error-card ul li::before {
            content: "•";
            color: #ff69b4;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        
        .action-link {
            display: inline-block;
            background-color: #00ffaa; 
            color: #111827;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
        }
        .action-link:hover {
            background-color: #00cc88;
        }
        
        .right-column {
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: flex-start;
             gap: 15px;
             padding: 10px;
             background: #1a0f3d;
             border-radius: 8px;
             border: 1px dashed #5d3f9e;
        }
        @media (max-width: 599px) {
            .right-column {
                display: none; 
            }
        }
        
        .komiko-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto;
            border: 3px solid #ff69b4;
        }
        
        .apology-text {
            color: #00ffaa;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 20px;
            grid-column: 1 / -1; 
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }
        .contact-info a {
            color: #ff69b4;
            text-decoration: none;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            transition: color 0.3s;
        }
        .contact-info a:hover {
            color: #ff0080;
            text-decoration: underline;
        }
        
        .custom-dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 10;
        }
        
        #filter-title-input, #filter-creator-input {
            color: #111827 !important;
            background-color: white !important;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div id="cdn-failure-overlay">
        <div class="error-container">
            <div class="error-header">
                <h1>Lỗi Hệ Thống FOXANIME 5xx!</h1>
                <p>Máy chủ đang gặp sự cố và không thể tải dữ liệu yêu cầu.</p>
            </div>
            
            <div class="error-content-grid">
                <div class="left-column">
                    <div class="error-card">
                        <h3>Chi tiết Sự cố</h3>
                        <p style="font-size:0.95rem; color:#e0e7ff; margin-bottom: 10px;">
                            **CDN/Network Failure**
                        </p>
                        <p style="font-size:0.9rem; color:#d1d5db; margin:0;">
                            Bảng Điều Khiển không thể tải các tài nguyên bên ngoài.
                        </p>
                    </div>

                    <div class="error-card" style="margin-bottom: 0;">
                        <h3>Nguyên nhân có thể</h3>
                        <ul>
                            <li>Lỗi mạng của Quý khách</li>
                            <li>Sự cố nhà cung cấp dịch vụ</li>
                            <li>Lỗi kết nối từ máy chủ FOXANIME</li>
                            <li>Vấn đề bảo trì không báo trước</li>
                        </ul>
                    </div>
                </div>

                <div class="right-column">
                    <img src="https://uploads.onecompiler.io/43u4wb3ft/4452bnsfd/KomikoAI.jpg" alt="KomikoAI Logo" class="komiko-logo" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/a3e635?text=KOMIKO'">
                    
                    <div class="error-card" style="margin-bottom: 0; width: 100%; text-align: center; background-color: #2f1d56;">
                        <h3>Khôi phục Tự động</h3>
                        <p style="font-size:0.95rem; color:#e0e7ff; margin-bottom: 10px;">
                            Hệ thống sẽ thử lại tự động sau 15 giây.
                        </p>
                        <a href="javascript:location.reload()" class="action-link" style="font-size: 0.9rem; padding: 8px 15px;">Tải lại trang ngay</a>
                    </div>
                    
                    <div class="contact-info" style="margin-top: 0;">
                         <a href="mailto:haistrem6792@gmail.com">
                            <i class="fas fa-envelope" style="font-size: 1.2rem; margin-right: 5px;"></i>
                            Liên hệ ngay
                        </a>
                    </div>
                </div>
            </div>
            <p class="apology-text">Thành thật xin lỗi vì sự bất tiện này!</p>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-300 hidden opacity-0">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-[#00ffaa] mb-4 neon-glow"></i>
            <p class="text-white text-lg">Đang kết nối Database... Xin chờ Senpai!
            </p>
        </div>
    </div>
    
    <div id="auth-page" class="min-h-screen flex items-center justify-center">
        <div class="bg-[#2f1d56] p-8 rounded-xl shadow-2xl w-full max-w-md panel-border">
            <h2 class="text-3xl font-bold text-[#00ffaa] text-center mb-6 neon-glow">ADMIN LOGIN</h2>
            <p class="text-center text-gray-400 text-sm mb-4">
                Đăng nhập bằng tài khoản Admin đã được tạo.
            </p>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-[#e0e7ff] text-sm font-bold mb-2" for="login-email">Email</label>
                    <input class="form-input" id="login-email" type="email" placeholder="admin@foxanime.com" required>
                </div>
                <div class="mb-6">
                    <label class="block text-[#e0e7ff] text-sm font-bold mb-2" for="login-password">Password</label>
                    <input class="form-input" id="login-password" type="password" placeholder="••••••••" required>
                </div>
                <p id="auth-error-message" class="text-[#ff69b4] text-sm text-center mb-4"></p>
                <button type="submit" class="anime-button w-full bg-[#00ffaa] hover:bg-[#00cc88] text-gray-900 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff69b4] mb-4">
                    LOGIN (Enter World)
                </button>
            </form>
        </div>
    </div>
    
    <div id="admin-main-view" class="max-w-7xl mx-auto hidden">
        <header class="mb-8 border-b border-gray-700 pb-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://uploads.onecompiler.io/43u4wb3ft/4452q4hvx/KomikoAIolog%20(1).jpg" 
                     alt="FoxAnime Logo" 
                     class="w-16 h-16 object-contain rounded-full border-2 border-[#ff69b4] shadow-lg"
                     onerror="this.onerror=null;this.src='https://placehold.co/64x64/ff69b4/ffffff?text=FX';" 
                />
                <div>
                    <h1 class="text-4xl font-extrabold text-[#00ffaa] neon-glow mb-2">BẢNG ĐIỀU KHIỂN - FOXANIME ADMIN</h1>
                    <p class="text-gray-400">Quản lý Phim và Tài khoản Admin .</p>
                    <div id="auth-status" class="mt-2 text-sm text-[#ff69b4]"></div>
                </div>
            </div>
            <div id="admin-profile-header" class="hidden items-center space-x-4 bg-[#2f1d56] p-3 rounded-lg panel-border">
                <img id="admin-avatar-header" src="https://placehold.co/40x40/ff69b4/ffffff?text=AD" alt="Admin Avatar" class="w-10 h-10 rounded-full border-2 border-[#00ffaa] object-cover">
                <div>
                    <span id="admin-display-name-header" class="font-bold text-[#00ffaa] block"></span>
                    <a href="#profile" class="text-xs text-[#ff69b4] hover:underline transition">Chỉnh sửa Profile</a>
                </div>
                <button onclick="handleLogout()" class="text-white hover:text-red-500 transition duration-300 ml-4">
                    <i class="fas fa-sign-out-alt text-lg" title="Đăng Xuất"></i>
                </button>
            </div>
        </header>
        
        <div class="flex space-x-4 mb-8 border-b border-gray-700">
            <button id="nav-dashboard" data-hash="#dashboard" class="py-2 px-4 font-semibold hover:text-[#ff69b4] transition border-b-4 border-transparent text-[#00ffaa]">DASHBOARD</button>
            <button id="nav-schedule" data-hash="#schedule" class="py-2 px-4 font-semibold hover:text-[#ff69b4] transition border-b-4 border-transparent">LỊCH CHIẾU</button>
            <button id="nav-profile" data-hash="#profile" class="py-2 px-4 font-semibold hover:text-[#ff69b4] transition border-b-4 border-transparent">TÀI KHOẢN ADMIN</button>
        </div>

        <main id="main-content" class="min-h-[70vh]">
        </main>
    </div>

    <!-- START: BULK IMPORT MODAL -->
    <div id="bulk-import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center z-50">
        <div class="bg-[#2f1d56] p-6 rounded-xl w-full max-w-4xl mx-4 shadow-2xl panel-border max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-[#bf94e4] border-b border-[#5d3f9e] pb-2">
                <i class="fas fa-file-import mr-2"></i>  SPMODE IMPORT MOVIES (Thêm hàng loạt)
            </h3>
            
            <div class="mb-4 bg-[#1a0f3d] p-4 rounded text-sm text-gray-300 border-l-4 border-[#bf94e4]">
                <p class="font-bold text-[#00ffaa] mb-2"><i class="fas fa-info-circle"></i> Hướng dẫn & Cơ chế Tự Sửa Lỗi:</p>
                <p>Chức năng này cho phép bạn thêm nhiều phim cùng lúc bằng dữ liệu JSON.</p>
                <ul class="list-disc ml-4 mt-2 text-xs text-gray-400">
                    <li>Nếu bạn dùng nút FETCH, hệ thống sẽ cố gắng **tự động ánh xạ** dữ liệu API về đúng định dạng của FOXANIME.</li>
                    <li>Nếu một trường bị thiếu (ví dụ: `totalEpisodes`), nó sẽ được đặt giá trị mặc định (ví dụ: 0).</li>
                    <li>Bạn **phải** cung cấp `title` hợp lệ.</li>
                </ul>
            </div>

            <div class="mb-4">
                <label class="block text-[#00ffaa] text-sm font-bold mb-2">Nhập URL API (Trả về JSON):</label>
                <div class="flex gap-2">
                    <input id="bulk-url-input" class="form-input" type="url" placeholder="https://api.example.com/movies.json (hoặc embed link nếu hỗ trợ)">
                    <button onclick="fetchBulkFromUrl()" class="anime-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        FETCH
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-[#00ffaa] text-sm font-bold mb-2">Hoặc Dán Dữ Liệu JSON (Mảng []):</label>
                <textarea id="bulk-json-input" class="form-input h-48 font-mono text-xs" placeholder='[
    {
        "title": "Tên Phim (*)",
        "titleOriginal": "Original Name",
        "genre": "Action, Comedy",
        "posterUrl": "https://...",
        "summary": "Nội dung...",
        "status": "dang-chieu",
        "totalEpisodes": 12,
        "formatType": "tv-series"
    },
    ...
]'></textarea>
            </div>

            <div id="bulk-status" class="mb-4 text-sm font-bold min-h-[20px]"></div>

            <div class="flex items-center justify-between">
                <button onclick="processBulkImport()" class="anime-button bg-[#bf94e4] hover:bg-[#a06ec4] text-gray-900 font-bold py-2 px-6 rounded-lg">
                    <i class="fas fa-magic mr-2"></i> BẮT ĐẦU IMPORT & SỬA LỖI
                </button>
                <button type="button" onclick="hideModal('bulk-import-modal')" class="anime-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                    Đóng
                </button>
            </div>
        </div>
    </div>
    <!-- END: BULK IMPORT MODAL -->

    <div id="add-movie-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-[#2f1d56] p-6 rounded-xl w-full max-w-3xl mx-4 shadow-2xl panel-border max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-[#ff69b4] border-b border-[#5d3f9e] pb-2">CREATE NEW MOVIE CARD</h3>
            <form id="add-movie-form">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-title">Tên Phim Tiếng Việt (*)</label>
                        <input class="form-input" id="movie-title" type="text" placeholder="Gundam Seed Freedom" required>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-title-original">Tên Gốc (JP/EN)</label>
                        <input class="form-input" id="movie-title-original" type="text" placeholder="機動戦士ガンダムSEED FREEDOM">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-formatType">Dạng Anime (*)</label>
                        <select id="movie-formatType" class="form-input">
                            <option value="tv-series">TV/Series</option>
                            <option value="movie-ova">Movie/OVA</option>
                            <option value="hh-trung-quoc">HH Trung Quốc</option>
                            <option value="anime-tron-bo">Anime Trọn Bộ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-season">Season (*)</label>
                        <select id="movie-season" class="form-input">
                            <option value="khac">--- KHÁC ---</option>
                            <optgroup label="Năm 2026">
                                <option value="mua-xuan-2026">Mùa Xuân 2026</option>
                                <option value="mua-he-2026">Mùa Hè 2026</option>
                                <option value="mua-thu-2026">Mùa Thu 2026</option>
                                <option value="mua-dong-2026">Mùa Đông 2026</option>
                            </optgroup>
                            <optgroup label="Năm 2025">
                                <option value="mua-xuan-2025">Mùa Xuân 2025</option>
                                <option value="mua-he-2025">Mùa Hè 2025</option>
                            </optgroup>
                            <optgroup label="Năm 2024">
                                <option value="mua-xuan-2024">Mùa Xuân 2024</option>
                                <option value="mua-he-2024">Mùa Hè 2024</option>
                                <option value="mua-thu-2024">Mùa Thu 2024</option>
                                <option value="mua-dong-2024">Mùa Đông 2024</option>
                            </optgroup>
                        </select>
                    </div>
                     <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-totalEpisodes">Tổng số tập</label>
                        <input class="form-input" id="movie-totalEpisodes" type="number" min="0" placeholder="0 = ??">
                        <p class="text-xs text-gray-400 mt-1">Nhập 0 nếu là '??' (Đang cập nhật)</p>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-status">Trạng thái (*)</label>
                        <select id="movie-status" class="form-input">
                            <option value="dang-chieu">Đang tiến hành (Đang Chiếu)</option>
                            <option value="tron-bo">Hoàn thành (Trọn Bộ)</option>
                            <option value="sap-chieu">Sắp chiếu</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-airingDay">Lịch chiếu</label>
                        <select id="movie-airingDay" class="form-input">
                            <option value="Không có">Không có</option>
                            <option value="Thứ 2">Thứ 2</option>
                            <option value="Thứ 3">Thứ 3</option>
                            <option value="Thứ 4">Thứ 4</option>
                            <option value="Thứ 5">Thứ 5</option>
                            <option value="Thứ 6">Thứ 6</option>
                            <option value="Thứ 7">Thứ 7</option>
                            <option value="Chủ Nhật">Chủ Nhật</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2">Thể loại (*) <span class="text-xs text-gray-400">(Chọn ít nhất 1)</span></label>
                    <div id="genre-tag-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-3 bg-[#1a0f3d] border border-[#5d3f9e] rounded-lg max-h-[200px] overflow-y-auto">
                        <!-- GENRE LIST WILL BE RENDERED BY JS -->
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2">URL Ảnh Poster (*)</label>
                    <input class="form-input" id="movie-poster" type="url" placeholder="https://example.com/poster.jpg">
                </div>
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-poster-file">HOẶC Tải tệp lên (*)</label>
                    <input class="custom-file-input text-gray-400" id="movie-poster-file" type="file" accept="image/png, image/jpeg, image/webp">
                    <p id="poster-upload-status" class="text-xs text-[#00ffaa] mt-2"></p>
                    <p class="text-xs text-[#ff69b4] italic">Lưu ý: File phải nhỏ hơn 700KB để tránh lỗi database.</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-banner">URL Ảnh Banner (Ngang, 1200x600)</label>
                    <input class="form-input" id="movie-banner" type="url" placeholder="https://example.com/banner.jpg">
                    <p class="text-xs text-gray-400 mt-1">Dùng cho Hero/Backdrop. Nếu bỏ trống, sẽ dùng ảnh Poster.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-banner-file">HOẶC Tải tệp Banner lên</label>
                    <input class="custom-file-input text-gray-400" id="movie-banner-file" type="file" accept="image/png, image/jpeg, image/webp">
                    <p id="banner-upload-status" class="text-xs text-[#00ffaa] mt-2"></p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="movie-summary">Tóm tắt Phim</label>
                    <textarea class="form-input h-24" id="movie-summary" placeholder="Mô tả tóm tắt nội dung phim..."></textarea>
                </div>
                
                <div id="movie-form-message" class="text-[#ff69b4] text-sm mb-4"></div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="anime-button bg-[#00ffaa] hover:bg-[#00cc88] text-gray-900 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff69b4]">
                        <i class="fas fa-save mr-2"></i> SAVE MOVIE (Quest Complete)
                    </button>
                    <button type="button" onclick="hideModal('add-movie-modal')" class="anime-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                        Hủy (Exit)
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-movie-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-[#2f1d56] p-6 rounded-xl w-full max-w-3xl mx-4 shadow-2xl panel-border max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-[#ff69b4] border-b border-[#5d3f9e] pb-2">EDIT MOVIE CARD</h3>
            <form id="edit-movie-form">
                <input type="hidden" id="edit-movie-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-title">Tên Phim Tiếng Việt (*)</label>
                        <input class="form-input" id="edit-movie-title" type="text" required>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-title-original">Tên Gốc (JP/EN)</label>
                        <input class="form-input" id="edit-movie-title-original" type="text">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-formatType">Dạng Anime (*)</label>
                        <select id="edit-movie-formatType" class="form-input">
                            <option value="tv-series">TV/Series</option>
                            <option value="movie-ova">Movie/OVA</option>
                            <option value="hh-trung-quoc">HH Trung Quốc</option>
                            <option value="anime-tron-bo">Anime Trọn Bộ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-season">Season (*)</label>
                        <select id="edit-movie-season" class="form-input">
                            <option value="khac">--- KHÁC ---</option>
                            <optgroup label="Năm 2026">
                                <option value="mua-xuan-2026">Mùa Xuân 2026</option>
                                <option value="mua-he-2026">Mùa Hè 2026</option>
                                <option value="mua-thu-2026">Mùa Thu 2026</option>
                                <option value="mua-dong-2026">Mùa Đông 2026</option>
                            </optgroup>
                            <optgroup label="Năm 2025">
                                <option value="mua-xuan-2025">Mùa Xuân 2025</option>
                                <option value="mua-he-2025">Mùa Hè 2025</option>
                            </optgroup>
                            <optgroup label="Năm 2024">
                                <option value="mua-xuan-2024">Mùa Xuân 2024</option>
                                <option value="mua-he-2024">Mùa Hè 2024</option>
                                <option value="mua-thu-2024">Mùa Thu 2024</option>
                                <option value="mua-dong-2024">Mùa Đông 2024</option>
                            </optgroup>
                        </select>
                    </div>
                     <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-totalEpisodes">Tổng số tập</label>
                        <input class="form-input" id="edit-movie-totalEpisodes" type="number" min="0" placeholder="0 = ??">
                        <p class="text-xs text-gray-400 mt-1">Nhập 0 nếu là '??' (Đang cập nhật)</p>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-status">Trạng thái (*)</label>
                        <select id="edit-movie-status" class="form-input">
                            <option value="dang-chieu">Đang tiến hành (Đang Chiếu)</option>
                            <option value="tron-bo">Hoàn thành (Trọn Bộ)</option>
                            <option value="sap-chieu">Sắp chiếu</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-airingDay">Lịch chiếu</label>
                        <select id="edit-movie-airingDay" class="form-input">
                            <option value="Không có">Không có</option>
                            <option value="Thứ 2">Thứ 2</option>
                            <option value="Thứ 3">Thứ 3</option>
                            <option value="Thứ 4">Thứ 4</option>
                            <option value="Thứ 5">Thứ 5</option>
                            <option value="Thứ 6">Thứ 6</option>
                            <option value="Thứ 7">Thứ 7</option>
                            <option value="Chủ Nhật">Chủ Nhật</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2">Thể loại (*)</label>
                    <div id="edit-genre-tag-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-3 bg-[#1a0f3d] border border-[#5d3f9e] rounded-lg max-h-[200px] overflow-y-auto">
                         <!-- GENRE LIST WILL BE RENDERED BY JS -->
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2">URL Ảnh Poster (*)</label>
                    <input class="form-input" id="edit-movie-poster" type="url" placeholder="https://example.com/poster.jpg">
                    <p class="text-xs text-gray-400 mt-2">Lưu ý: Nếu ảnh cũ là Base64, trường này sẽ trống. Tải tệp mới hoặc dán URL mới sẽ ghi đè ảnh cũ.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-poster-file">HOẶC Tải tệp mới để thay thế (*)</label>
                    <input class="custom-file-input text-gray-400" id="edit-movie-poster-file" type="file" accept="image/png, image/jpeg, image/webp">
                    <p id="edit-poster-upload-status" class="text-xs text-[#00ffaa] mt-2"></p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-banner">URL Ảnh Banner (Ngang, 1200x600)</label>
                    <input class="form-input" id="edit-movie-banner" type="url" placeholder="https://example.com/banner.jpg">
                    <p class="text-xs text-gray-400 mt-1">Dùng cho Hero/Backdrop. Nếu bỏ trống, sẽ dùng ảnh Poster.</p>
                </div>
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-banner-file">HOẶC Tải tệp Banner mới</label>
                    <input class="custom-file-input text-gray-400" id="edit-movie-banner-file" type="file" accept="image/png, image/jpeg, image/webp">
                    <p id="edit-banner-upload-status" class="text-xs text-[#00ffaa] mt-2"></p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-movie-summary">Tóm tắt Phim</label>
                    <textarea class="form-input h-24" id="edit-movie-summary"></textarea>
                </div>
                
                <div id="edit-movie-form-message" class="text-[#ff69b4] text-sm mb-4"></div>
                
                <!-- NEW: Thêm nút xóa tất cả tập phim -->
                <div class="mb-4 pt-4 border-t border-[#5d3f9e]">
                    <button type="button" id="delete-all-episodes-btn" class="anime-button bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm w-full">
                        <i class="fas fa-trash-alt mr-2"></i> DELETE ALL EPISODES
                    </button>
                    <p class="text-xs text-red-400 mt-1 text-center">CẢNH BÁO: Thao tác này sẽ xóa toàn bộ danh sách tập phim (episodes) của Movie này!</p>
                </div>
                
                <div class="flex items-center justify-between">
                    <button type="submit" id="edit-movie-submit-btn" class="anime-button bg-[#00ffaa] hover:bg-[#00cc88] text-gray-900 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff69b4]">
                        UPDATE MOVIE (Save Changes)
                    </button>
                    <button type="button" onclick="hideModal('edit-movie-modal')" class="anime-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                        Hủy (Abort)
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="add-episode-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-[#2f1d56] p-6 rounded-xl w-full max-w-lg mx-4 shadow-2xl panel-border">
            <h3 class="text-2xl font-bold mb-4 text-[#ff69b4] border-b border-[#5d3f9e] pb-2">ADD NEW EPISODE</h3>
            <h4 class="text-lg text-[#00ffaa] mb-4">Target: <span id="episode-movie-title" class="text-white"></span></h4>
            <form id="add-episode-form">
                <input type="hidden" id="episode-movie-id">
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="episode-number">Số Tập (*)</label>
                    <input class="form-input" id="episode-number" type="number" min="1" placeholder="Ví dụ: 1, 2, 3...">
                </div>
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="episode-title">Tên Tập (*)</label>
                    <input class="form-input" id="episode-title" type="text" placeholder="Ví dụ: Khởi đầu mới">
                </div>
                
                <div class="mb-6">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="episode-url">URL Video (*)</label>
                    <input class="form-input" id="episode-url" type="url" placeholder="https://example.com/video/tap-1.mp4">
                </div>
                
                <div id="episode-form-message" class="text-[#ff69b4] text-sm mb-4"></div>
                <div class="flex items-center justify-between">
                    <button type="submit" id="add-episode-submit-btn" class="anime-button bg-[#00ffaa] hover:bg-[#00cc88] text-gray-900 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff69b4]">
                        ADD EPISODE (Commit Data)
                    </button>
                    <button type="button" onclick="hideModal('add-episode-modal')" class="anime-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                        Hủy (Abort)
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- START: BULK ADD EPISODES MODAL (New Feature) -->
    <div id="bulk-add-episode-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-[#2f1d56] p-6 rounded-xl w-full max-w-lg mx-4 shadow-2xl panel-border max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-purple-400 border-b border-[#5d3f9e] pb-2">
                <i class="fas fa-stream mr-2"></i> BULK ADD EPISODES (Thêm hàng loạt)
            </h3>
            <h4 class="text-lg text-[#00ffaa] mb-4">Target: <span id="bulk-episode-movie-title" class="text-white font-semibold"></span></h4>
            
            <form id="bulk-add-episode-form">
                <input type="hidden" id="bulk-episode-movie-id">

                <div class="mb-4 bg-[#1a0f3d] p-3 rounded text-sm border-l-4 border-purple-500">
                    <p class="font-bold text-purple-300 mb-2"><i class="fas fa-info-circle"></i> Hướng dẫn:</p>
                    <p>Dán danh sách link video (URL) vào ô bên dưới. **Mỗi link một dòng.**</p>
                    <p>Tên tập mặc định sẽ là **Tập [Số]** (Ví dụ: Tập 1, Tập 2).</p>
                </div>

                <div class="mb-4">
                    <label class="block text-purple-300 text-sm font-bold mb-2" for="bulk-episode-start-number">Bắt đầu từ tập số (*)</label>
                    <input class="form-input" id="bulk-episode-start-number" type="number" min="1" placeholder="Ví dụ: 1 hoặc tập cuối + 1">
                </div>
                
                <div class="mb-6">
                    <label class="block text-purple-300 text-sm font-bold mb-2" for="bulk-episode-urls">Danh sách Link Video (1 link/dòng)</label>
                    <textarea class="form-input h-32 font-mono text-xs" id="bulk-episode-urls" placeholder="https://link-tap-1.com/video.mp4&#10;https://link-tap-2.com/video.mp4&#10;..."></textarea>
                    <p id="bulk-episode-warning" class="text-xs text-yellow-400 mt-1"></p> <!-- Thêm cảnh báo ở đây -->
                </div>
                
                <div id="bulk-episode-form-message" class="text-[#ff69b4] text-sm mb-4"></div>
                <div class="flex items-center justify-between">
                    <button type="submit" id="bulk-add-episode-submit-btn" class="anime-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <i class="fas fa-magic mr-2"></i> XỬ LÝ VÀ THÊM NGAY
                    </button>
                    <button type="button" onclick="hideModal('bulk-add-episode-modal')" class="anime-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                        Đóng
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- END: BULK ADD EPISODES MODAL -->
    
    <div id="edit-episode-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-[#2f1d56] p-6 rounded-xl w-full max-w-lg mx-4 shadow-2xl panel-border">
            <h3 class="text-2xl font-bold mb-4 text-[#ff69b4] border-b border-[#5d3f9e] pb-2">EDIT EPISODE</h3>
            <h4 class="text-lg text-[#00ffaa] mb-4">Target: <span id="edit-episode-movie-title" class="text-white"></span></h4>
            <form id="edit-episode-form">
                <input type="hidden" id="edit-episode-movie-id">
                <input type="hidden" id="edit-episode-number-original"> 
                
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-episode-number">Số Tập (*)</label>
                    <input class="form-input" id="edit-episode-number" type="number" min="1" placeholder="Ví dụ: 1">
                </div>
                <div class="mb-4">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-episode-title">Tên Tập (*)</label>
                    <input class="form-input" id="edit-episode-title" type="text" placeholder="Ví dụ: Khởi đầu mới">
                </div>
                
                <div class="mb-6">
                    <label class="block text-[#00ffaa] text-sm font-bold mb-2" for="edit-episode-url">URL Video (*)</label>
                    <input class="form-input" id="edit-episode-url" type="url" placeholder="https://example.com/video/tap-1.mp4">
                </div>
                
                <div id="edit-episode-form-message" class="text-[#ff69b4] text-sm mb-4"></div>
                <div class="flex items-center justify-between">
                    <button type="submit" id="edit-episode-submit-btn" class="anime-button bg-[#00ffaa] hover:bg-[#00cc88] text-gray-900 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff69b4]">
                        UPDATE EPISODE (Save Changes)
                    </button>
                    <button type="button" onclick="hideModal('edit-episode-modal')" class="anime-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                        Hủy (Abort)
                    </button>
                </div>
            </form>
        </div>
    </div>

    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-[#2f1d56] p-8 rounded-xl w-full max-w-sm mx-4 shadow-2xl panel-border text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h3 class="text-2xl font-bold text-white mb-4">XÁC NHẬN HÀNH ĐỘNG</h3>
            <p id="confirm-modal-text" class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa mục này?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-modal-yes" class="anime-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    Xác nhận
                </button>
                <button id="confirm-modal-no" class="anime-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
                    Hủy
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signOut,
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            updatePassword,
            setPersistence,
            browserSessionPersistence, 
            reload
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, getDocs, 
            serverTimestamp, setLogLevel, writeBatch, increment 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('error'); 

        const $ = (id) => document.getElementById(id); 
        
        const COLORS = {
            SUCCESS: '#00ffaa',
            ERROR: '#ff69b4',
        };
        
        const MAX_AVATAR_SIZE_BYTES = 0.5 * 1024 * 1024;
        const MAX_POSTER_SIZE_BYTES = 0.8 * 1024 * 1024;
        
        const FIREBASE_DEFAULT_CONFIG = {
            "apiKey": "AIzaSyDvI4bfJXh08biyFORz6X2xwBc19TERWEc", 
            "authDomain": "foxanime-e77d4.firebaseapp.com",
            "projectId": "foxanime-e77d4", 
            "storageBucket": "foxanime-e77d4.firebasestorage.app",
            "messagingSenderId": "1025177423292", 
            "appId": "1:1025177423292:web:14c200fbc905e79b3c6fb9"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const finalConfig = firebaseConfigFromCanvas?.projectId ? firebaseConfigFromCanvas : FIREBASE_DEFAULT_CONFIG;

        let app, db, auth;
        let userId = null;
        let userEmail = null;
        
        let moviesCollectionRef = null; 
        
        let adminProfilesCollectionRef = null; 
        let userProfileDocRef = null;
        
        let currentUserProfile = {};
        let globalAdminMoviesCache = [];
        let unsubscribeMoviesListener = null;
        let adminProfileMap = {}; 
        
        let currentPage = 1;
        const itemsPerPage = 10;
        let filterState = {
            title: '',
            genre: '',
            creator: ''
        };
        
        const ALL_GENRES = ["Action", "Adventure", "Boys Love", "Cartoon", "Comedy", "Dementia", "Demons", "Drama", "Ecchi", "Fantasy", "Game", "Harem", "Historical", "Horror", "Josei", "Kids", "Live Action", "Magic", "Martial Arts", "Mecha", "Military", "Music", "Mystery", "Parody", "Police", "Psychological", "Romance", "Samurai", "School", "Sci-Fi", "Seinen", "Shoujo", "Shoujo Ai", "Shounen", "Shounen Ai", "Slice of Life", "Space", "Sports", "Super Power", "Supernatural", "Suspense", "Thriller", "Tokusatsu", "Vampire", "Yaoi", "Yuri"];

        const GENRE_TRANSLATIONS = {
            "Action": "Hành động",
            "Adventure": "Phiêu lưu",
            "Boys Love": "Đam mỹ",
            "Cartoon": "Hoạt hình",
            "Comedy": "Hài hước",
            "Dementia": "Điên loạn",
            "Demons": "Ác quỷ",
            "Drama": "Kịch tính",
            "Ecchi": "Ecchi",
            "Fantasy": "Giả tưởng",
            "Game": "Trò chơi",
            "Harem": "Harem",
            "Historical": "Lịch sử",
            "Horror": "Kinh dị",
            "Josei": "Josei",
            "Kids": "Trẻ em",
            "Live Action": "Người đóng",
            "Magic": "Ma thuật",
            "Martial Arts": "Võ thuật",
            "Mecha": "Robot",
            "Military": "Quân sự",
            "Music": "Âm nhạc",
            "Mystery": "Bí ẩn",
            "Parody": "Hài nhái",
            "Police": "Cảnh sát",
            "Psychological": "Tâm lý",
            "Romance": "Lãng mạn",
            "Samurai": "Samurai",
            "School": "Học đường",
            "Sci-Fi": "Viễn tưởng",
            "Seinen": "Seinen",
            "Shoujo": "Thiếu nữ",
            "Shoujo Ai": "Bách hợp (Nhẹ)",
            "Shounen": "Thiếu niên",
            "Shounen Ai": "Đam mỹ (Nhẹ)",
            "Slice of Life": "Đời thường",
            "Space": "Vũ trụ",
            "Sports": "Thể thao",
            "Super Power": "Siêu năng lực",
            "Supernatural": "Siêu nhiên",
            "Suspense": "Hồi hộp",
            "Thriller": "Giật gân",
            "Tokusatsu": "Tokusatsu",
            "Vampire": "Ma cà rồng",
            "Yaoi": "Đam mỹ (Mạnh)",
            "Yuri": "Bách hợp (Mạnh)"
        };


        let resolveConfirm;

        window.showConfirmModal = (text) => {
            $('confirm-modal-text').textContent = text;
            showModal('confirm-modal');
            return new Promise(resolve => {
                resolveConfirm = resolve;
            });
        };

        $('confirm-modal-yes').addEventListener('click', () => {
            hideModal('confirm-modal');
            resolveConfirm(true);
        });

        $('confirm-modal-no').addEventListener('click', () => {
            hideModal('confirm-modal');
            resolveConfirm(false);
        });

        window.showModal = (id) => { $(id).classList.remove('hidden'); $(id).classList.add('flex'); };
        window.hideModal = (id) => { $(id).classList.add('hidden'); $(id).classList.remove('flex'); };
        
        const showLoading = (isLoading) => {
            const overlay = $('loading-overlay');
            overlay.classList.toggle('hidden', !isLoading);
            overlay.classList.toggle('flex', isLoading);
            overlay.classList.toggle('opacity-0', !isLoading);
            overlay.classList.toggle('opacity-100', isLoading);
        };

        const updateAuthStatusHeader = (message, isError = false) => {
             const authStatusEl = $('auth-status');
             if (authStatusEl) {
                 authStatusEl.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-triangle text-[#ff69b4]' : 'fa-check-circle text-[#00ffaa]'} mr-1"></i> ${message}`;
             }
        };

        const updateProfileHeader = () => {
            const headerEl = $('admin-profile-header');
            const displayNameEl = $('admin-display-name-header');
            const avatarEl = $('admin-avatar-header');

            const displayName = currentUserProfile.displayName || (userEmail ? userEmail.split('@')[0] : 'Admin-san');
            displayNameEl.textContent = displayName;
            
            const avatarSrc = currentUserProfile.avatarBase64 || currentUserProfile.avatarUrl || 
                `https://placehold.co/40x40/ff69b4/ffffff?text=${displayName.charAt(0).toUpperCase()}`;
            avatarEl.src = avatarSrc;

            headerEl.classList.toggle('hidden', !userId);
            headerEl.classList.toggle('flex', !!userId);
            $('auth-page').classList.toggle('hidden', !!userId);
            $('admin-main-view').classList.toggle('hidden', !userId);
        };
        
        
        const readFileAsBase64 = (file, maxSizeInBytes) => {
            return new Promise((resolve, reject) => {
                if (file.size > maxSizeInBytes) {
                    const limitMB = (maxSizeInBytes / 1024 / 1024).toFixed(1);
                    reject(new Error(`Kích thước file quá lớn (File của bạn: ${(file.size/1024/1024).toFixed(2)}MB). Tối đa cho phép là ${limitMB}MB do giới hạn Firestore.`));
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };
        
        const getAdminPreviewUrl = (videoUrl) => {
            try {
                const urlObj = new URL(videoUrl);
                const hostname = urlObj.hostname;
                if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
                    const videoId = urlObj.searchParams.get('v') || (hostname === 'youtu.be' ? urlObj.pathname.substring(1) : null);
                    return videoId ? `https://www.youtube.com/embed/${videoId}?rel=0` : videoUrl;
                }
                if (hostname.includes('drive.google.com')) {
                    let fileId = '';
                    if (urlObj.pathname.startsWith('/file/d/')) {
                        fileId = urlObj.pathname.split('/')[3];
                    } else if (urlObj.pathname.startsWith('/uc')) {
                        fileId = urlObj.searchParams.get('id');
                    }
                    return fileId ? `https://drive.google.com/file/d/${fileId}/preview` : videoUrl;
                }
            } catch (e) {
            }
            return videoUrl;
        };
        
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = e.target['login-email'].value;
            const password = e.target['login-password'].value;
            const errorEl = $('auth-error-message');
            errorEl.textContent = '';
            
            try {
                showLoading(true);
                await setPersistence(auth, browserSessionPersistence);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const adminDocRef = doc(adminProfilesCollectionRef, user.uid);
                let adminDoc = await getDoc(adminDocRef);
                
                let role = 'user';
                
                if (adminDoc.exists()) {
                    role = adminDoc.data().role;
                } else {
                    const newProfileData = {
                        email: user.email,
                        role: 'admin', 
                        displayName: user.email.split('@')[0],
                        createdAt: serverTimestamp()
                    };
                    await setDoc(adminDocRef, newProfileData); 
                    adminDoc = await getDoc(adminDocRef);
                    role = 'admin'; 
                }
                
                if (role !== "admin") {
                    errorEl.textContent = `LỖI PHÂN QUYỀN: Role hiện tại là '${role}'. Bạn phải có role 'admin' để truy cập. Vui lòng kiểm tra Collection adminProfiles.`;
                    await signOut(auth);
                    return;
                }

            } catch (error) {
                console.error("Login attempt failed:", error.code, error.message);
                let errorMessage = 'Login Error: Sai email hoặc mật khẩu hoặc tài khoản chưa được cấp quyền Admin.';
                 if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Lỗi đăng nhập: Sai email hoặc mật khẩu.';
                }
                errorEl.textContent = errorMessage;
            } finally {
                showLoading(false);
            }
        };

        window.handleLogout = async () => {
            const confirmed = await window.showConfirmModal("Bạn có chắc chắn muốn đăng xuất khỏi Bảng Điều Khiển Admin?");
            if (confirmed) {
                 await signOut(auth);
                 window.location.hash = '#dashboard';
            }
        };
        
        
        const handleSaveProfile = async (e) => {
            e.preventDefault();
            const displayName = $('profile-display-name').value.trim();
            const avatarFile = $('profile-avatar-file').files[0];
            const messageEl = $('profile-message');
            messageEl.textContent = '';

            if (!userProfileDocRef || !userId) { messageEl.textContent = 'Lỗi hệ thống: User ID không hợp lệ.'; return; }

            try {
                let avatarBase64 = currentUserProfile.avatarBase64 || null;

                if (avatarFile) {
                    messageEl.textContent = 'Đang xử lý và tải ảnh lên...';
                    messageEl.style.color = COLORS.SUCCESS;
                    avatarBase64 = await readFileAsBase64(avatarFile, MAX_AVATAR_SIZE_BYTES);
                }
                
                const profileData = {
                    displayName: displayName || userEmail.split('@')[0],
                    avatarBase64: avatarBase64, 
                    updatedAt: serverTimestamp()
                };
                
                await setDoc(userProfileDocRef, profileData, { merge: true });
                // Cập nhật tên hiển thị trong adminProfiles để dùng cho việc hiển thị người tạo
                await setDoc(doc(adminProfilesCollectionRef, userId), { displayName: profileData.displayName }, { merge: true });

                messageEl.textContent = 'SUCCESS! Đã lưu profile Admin.';
                messageEl.className = 'text-sm mb-4 text-[#00ffaa]'; 
                
            } catch (error) {
                console.error("Lỗi khi lưu profile:", error);
                messageEl.textContent = 'FATAL ERROR: Lỗi khi lưu profile: ' + error.message;
                messageEl.className = 'text-sm mb-4 text-[#ff69b4]'; 
            }
        };

        const handleCreateAdmin = async (e) => {
            e.preventDefault();
            const email = $('newAdminEmail').value;
            const password = $('newAdminPass').value;
            const msgEl = $('create-admin-msg');
            
            if (password.length < 6) { msgEl.textContent = 'Lỗi: Mật khẩu phải có ít nhất 6 ký tự.'; msgEl.style.color = COLORS.ERROR; return; }
            
            msgEl.textContent = 'Đang tạo...';
            msgEl.style.color = COLORS.SUCCESS;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                
                await setDoc(doc(adminProfilesCollectionRef, newUser.uid), {
                    email: newUser.email,
                    role: 'admin', 
                    displayName: newUser.email.split('@')[0],
                    createdAt: serverTimestamp()
                });

                msgEl.textContent = `Tạo thành công admin: ${email}. Hãy lưu mật khẩu!`;
                msgEl.style.color = COLORS.SUCCESS;
                
                $('create-admin-form').reset();
                
            } catch (error) {
                console.error("Lỗi khi tạo Admin mới:", error);
                if (error.code === 'auth/email-already-in-use') {
                     msgEl.textContent = `Lỗi: Email ${email} đã được sử dụng.`;
                } else {
                     msgEl.textContent = `Lỗi: ${error.message}`;
                }
                msgEl.style.color = COLORS.ERROR;
            }
        };

        const handleChangePassword = async (e) => {
            e.preventDefault();
            const newPass = $('newPass').value;
            const confirmNewPass = $('confirmNewPass').value;
            const msgEl = $('change-pass-msg');

            if (newPass !== confirmNewPass) { msgEl.innerText = "Mật khẩu xác nhận không khớp!"; msgEl.style.color = COLORS.ERROR; return; }
            if (newPass.length < 6) { msgEl.innerText = "Mật khẩu phải có ít nhất 6 ký tự."; msgEl.style.color = COLORS.ERROR; return; }
            
            msgEl.innerText = 'Đang đổi mật khẩu...';
            msgEl.style.color = COLORS.SUCCESS;

            try {
                await updatePassword(auth.currentUser, newPass);
                
                msgEl.innerText = "Đổi mật khẩu thành công! Vui lòng đăng nhập lại.";
                msgEl.style.color = COLORS.SUCCESS;
                await signOut(auth); 
                
            } catch (error) {
                console.error("Lỗi đổi mật khẩu:", error);
                msgEl.innerText = `Lỗi: ${error.message}`;
                if (error.code === 'auth/requires-recent-login') {
                    msgEl.innerText = "Lỗi: Phiên đăng nhập quá cũ. Vui lòng đăng xuất, đăng nhập lại trước khi đổi mật khẩu.";
                }
                msgEl.style.color = COLORS.ERROR;
            }
        };

        // Hàm Tự Sửa Lỗi và Chuẩn hóa Dữ liệu Phim
        const sanitizeMovieData = (movie, userId) => {
            // 1. Basic required validation
            if (!movie.title || typeof movie.title !== 'string' || movie.title.trim() === '') {
                throw new Error("Movie object is missing a valid 'title'.");
            }
            
            // 2. Chuyển đổi và chuẩn hóa các trường Status và Type
            const validFormats = ['tv-series', 'movie-ova', 'hh-trung-quoc', 'anime-tron-bo'];
            const validStatuses = ['dang-chieu', 'tron-bo', 'sap-chieu'];

            const sanitized = {
                // Core mandatory/string fields
                title: movie.title.trim(),
                titleOriginal: (movie.titleOriginal || '').toString().trim(),
                summary: (movie.summary || '').toString().trim(),
                posterUrl: (movie.posterUrl || '').toString().trim(),
                bannerUrl: (movie.bannerUrl || '').toString().trim(),
                airingDay: movie.airingDay || 'Không có',

                // Status/Type fields with sanitization and defaults
                formatType: validFormats.includes(movie.formatType) ? movie.formatType : 'tv-series',
                season: movie.season || 'khac',
                status: validStatuses.includes(movie.status) ? movie.status : 'dang-chieu',

                // Genre processing (ensure it's a comma-separated string)
                genre: Array.isArray(movie.genre) ? movie.genre.join(', ') : (movie.genre || '').toString().trim(),

                // Numeric fields (ensure integer, default to 0)
                totalEpisodes: parseInt(movie.totalEpisodes) || 0,
                viewCount: parseInt(movie.viewCount) || 0,
                likeCount: parseInt(movie.likeCount) || 0,
                reviewCount: parseInt(movie.reviewCount) || 0,
                reviewTotal: parseInt(movie.reviewTotal) || 0,

                // Metadata and Episode Array (episodes array phải là mảng rỗng cho lần import này)
                episodes: [],
                createdAt: serverTimestamp(),
                updatedBy: userId,
                lastEpisodeUpdate: serverTimestamp()
            };

            return sanitized;
        };

        // START: LOGIC MAPPING TỪ API NGOÀI VÀO SCHEMA CHUẨN (Quan trọng)
        const mapApiToSchema = (rawMovie) => {
            // Chú ý: Dữ liệu API mẫu của Nii-chan là cho MỘT phim và được bọc trong field 'movie'
            const data = rawMovie.movie || rawMovie;

            if (!data || !data.name) {
                // Trả về dữ liệu thô nếu không thể xác định cấu trúc
                return rawMovie; 
            }
            
            // 1. Ánh xạ trạng thái dựa vào text
            const currentEpisodeText = data.current_episode || '';
            let status = 'dang-chieu';
            if (currentEpisodeText.includes('Hoàn tất') || currentEpisodeText.includes('Trọn bộ')) {
                status = 'tron-bo';
            } else if (data.status === 'Sắp chiếu') { // Giả định có field status riêng
                status = 'sap-chieu';
            }
            
            // 2. Ánh xạ Thể loại (Category List)
            let genres = [];
            // Kiểm tra category[2].list (dạng API phim.nguonc.com)
            if (data.category && data.category['2'] && data.category['2'].list) {
                genres = data.category['2'].list.map(g => (g.name || g.title).trim());
            } else if (data.category && Array.isArray(data.category)) {
                // Trường hợp category là mảng các chuỗi/objects
                 genres = data.category.map(g => (typeof g === 'string' ? g : g.name || g.title)).filter(Boolean);
            }
            
            // 3. Ánh xạ chính
            let movieData = {
                title: data.name || data.original_name || 'Unknown Title',
                titleOriginal: data.original_name || '',
                summary: data.description || data.content || '',
                
                posterUrl: data.thumb_url || data.poster_url || '',
                bannerUrl: data.cover_url || data.banner_url || data.thumb_url || '',
                
                status: status,
                
                // Chuyển đổi thể loại đã ánh xạ thành chuỗi
                genre: genres.join(', '),
                
                // Trích xuất tổng số tập
                totalEpisodes: parseInt(data.total_episodes) || 0,

                // Các trường khác (được sanitize tiếp bởi hàm sanitizeMovieData)
                formatType: 'tv-series',
                season: 'khac',
                airingDay: 'Không có', 
                episodes: [], // Luôn là mảng rỗng khi import movie
            };
            
            // Hàm sanitizeMovieData sẽ chuẩn hóa kiểu dữ liệu và điền các trường mặc định còn thiếu
            return movieData;
        };
        // END: LOGIC MAPPING TỪ API NGOÀI VÀO SCHEMA CHUẨN


        window.fetchBulkFromUrl = async () => {
            const url = $('bulk-url-input').value.trim();
            const statusEl = $('bulk-status');
            
            if (!url) {
                statusEl.textContent = 'Vui lòng nhập URL!';
                statusEl.style.color = COLORS.ERROR;
                return;
            }
            
            statusEl.textContent = 'Đang tải dữ liệu từ URL...';
            statusEl.style.color = COLORS.SUCCESS;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok, status: ' + response.status);
                
                const data = await response.json();
                
                let moviesToConvert = [];
                if (Array.isArray(data)) {
                    // 1. API trả về mảng phim
                    moviesToConvert = data;
                } else if (data && data.movie && typeof data.movie === 'object') {
                    // 2. API trả về một phim bọc trong field "movie" (như API mẫu của Nii-chan)
                    moviesToConvert = [data]; 
                } else if (data && data.data && Array.isArray(data.data)) {
                    // 3. API trả về cấu trúc wrapper {data: []}
                    moviesToConvert = data.data;
                } else if (data && typeof data === 'object') {
                    // 4. API trả về MỘT phim (object thuần)
                    moviesToConvert = [data]; 
                } else {
                    throw new Error("Không thể nhận dạng cấu trúc JSON API trả về.");
                }
                
                // Bước 2: Tự động ánh xạ từng phim về schema chuẩn
                const convertedMovies = moviesToConvert.map(rawMovie => mapApiToSchema(rawMovie));
                
                // Bước 3: Dán JSON đã được ánh xạ vào textarea để người dùng xem và kiểm tra
                $('bulk-json-input').value = JSON.stringify(convertedMovies, null, 4);
                
                statusEl.textContent = `Đã tải thành công và tự động ánh xạ! Tìm thấy ${convertedMovies.length} mục. Vui lòng kiểm tra JSON bên dưới trước khi IMPORT.`;
                statusEl.style.color = COLORS.SUCCESS;
            } catch (error) {
                console.error('Fetch error:', error);
                statusEl.textContent = `Lỗi khi tải hoặc ánh xạ từ URL: ${error.message}`;
                statusEl.style.color = COLORS.ERROR;
            }
        };

        window.processBulkImport = async () => {
            const jsonText = $('bulk-json-input').value.trim();
            const statusEl = $('bulk-status');
            
            if (!jsonText) {
                statusEl.textContent = 'Vui lòng nhập JSON!';
                statusEl.style.color = COLORS.ERROR;
                return;
            }
            
            try {
                const rawData = JSON.parse(jsonText);
                const moviesToProcess = Array.isArray(rawData) ? rawData : [rawData];
                
                statusEl.textContent = `Đang xử lý và sửa lỗi ${moviesToProcess.length} phim...`;
                statusEl.style.color = COLORS.SUCCESS;
                
                const batch = writeBatch(db);
                let successCount = 0;
                let failCount = 0;
                
                for (const rawMovie of moviesToProcess) {
                    try {
                        // Gọi sanitizeMovieData để đảm bảo dữ liệu đúng mẫu lần cuối trước khi ghi
                        const sanitizedMovie = sanitizeMovieData(rawMovie, userId);
                        
                        const newDocRef = doc(moviesCollectionRef);
                        batch.set(newDocRef, sanitizedMovie);
                        successCount++;
                    } catch (error) {
                        console.error("Lỗi Sanitization cho 1 mục:", rawMovie, error.message);
                        failCount++;
                    }
                }
                
                await batch.commit();
                
                statusEl.textContent = `SUCCESS! Đã thêm thành công ${successCount} phim (có ${failCount} mục bị lỗi không thể thêm).`;
                statusEl.style.color = failCount > 0 ? COLORS.ERROR : COLORS.SUCCESS;
                
                $('bulk-json-input').value = '';
                setTimeout(() => hideModal('bulk-import-modal'), 3000);
                
            } catch (error) {
                console.error("Lỗi Import:", error);
                statusEl.textContent = `Lỗi JSON hoặc Database: ${error.message}`;
                statusEl.style.color = COLORS.ERROR;
            }
        };
        // END: BULK IMPORT LOGIC

        const extractMovieData = (prefix = '') => {
            const containerId = prefix === 'edit-' ? 'edit-genre-tag-container' : 'genre-tag-container';
            const selectedTags = document.querySelectorAll(`#${containerId} .genre-tag.selected`);
            
            return {
                title: $(`${prefix}movie-title`).value.trim(),
                titleOriginal: $(`${prefix}movie-title-original`).value.trim(),
                summary: $(`${prefix}movie-summary`).value.trim(),
                genres: Array.from(selectedTags).map(tag => tag.dataset.genre),
                formatType: $(`${prefix}movie-formatType`).value,
                season: $(`${prefix}movie-season`).value,
                totalEpisodes: parseInt($(`${prefix}movie-totalEpisodes`).value) || 0,
                status: $(`${prefix}movie-status`).value,
                airingDay: $(`${prefix}movie-airingDay`).value,
                posterUrlInput: $(`${prefix}movie-poster`).value.trim(),
                posterFileInput: $(`${prefix}movie-poster-file`).files?.[0],
                bannerUrlInput: $(`${prefix}movie-banner`).value.trim(),
                bannerFileInput: $(`${prefix}movie-banner-file`).files?.[0]
            };
        };

        const handleAddMovie = async (e) => {
            e.preventDefault();
            const data = extractMovieData();
            const messageEl = $('movie-form-message');
            const posterStatusEl = $('poster-upload-status');
            const bannerStatusEl = $('banner-upload-status');

            messageEl.textContent = posterStatusEl.textContent = bannerStatusEl.textContent = '';
            
            if (!data.title || data.genres.length === 0 || (!data.posterUrlInput && !data.posterFileInput)) {
                messageEl.textContent = 'WARNING! Vui lòng điền Tên Phim, chọn ít nhất 1 Thể Loại, và cung cấp URL hoặc Tệp Poster.';
                return;
            }
            if (!moviesCollectionRef || !userId) {
                messageEl.textContent = 'SYSTEM STATUS: Bạn không có quyền Admin.';
                return;
            }
            
            try {
                let finalPosterUrl = data.posterUrlInput;
                let finalBannerUrl = data.bannerUrlInput;
                
                if (data.posterFileInput) {
                    posterStatusEl.textContent = 'Đang xử lý ảnh (Base64)...';
                    posterStatusEl.style.color = COLORS.SUCCESS;
                    finalPosterUrl = await readFileAsBase64(data.posterFileInput, MAX_POSTER_SIZE_BYTES); 
                    posterStatusEl.textContent = 'Tệp Base64 đã sẵn sàng!';
                }
                
                if (data.bannerFileInput) {
                    bannerStatusEl.textContent = 'Đang xử lý banner (Base64)...';
                    bannerStatusEl.style.color = COLORS.SUCCESS;
                    finalBannerUrl = await readFileAsBase64(data.bannerFileInput, MAX_POSTER_SIZE_BYTES); 
                    bannerStatusEl.textContent = 'Banner Base64 đã sẵn sàng!';
                }

                // Dữ liệu tạo phim mới đã được đảm bảo đúng mẫu
                const newDocRef = doc(moviesCollectionRef); 
                await setDoc(newDocRef, {
                    title: data.title,
                    titleOriginal: data.titleOriginal || '', 
                    genre: data.genres.join(', '), 
                    posterUrl: finalPosterUrl, 
                    bannerUrl: finalBannerUrl, 
                    summary: data.summary,
                    viewCount: 0,
                    likeCount: 0,
                    reviewCount: 0, 
                    reviewTotal: 0, 
                    episodes: [], 
                    createdAt: serverTimestamp(),
                    updatedBy: userId,
                    formatType: data.formatType,
                    season: data.season,
                    totalEpisodes: data.totalEpisodes,
                    status: data.status,
                    airingDay: data.airingDay,
                    lastEpisodeUpdate: serverTimestamp() 
                });

                $('add-movie-form').reset();
                posterStatusEl.textContent = bannerStatusEl.textContent = '';
                document.querySelectorAll('#genre-tag-container .genre-tag.selected').forEach(tag => tag.classList.remove('selected'));
                hideModal('add-movie-modal');

            } catch (error) {
                console.error("Lỗi khi thêm phim mới:", error);
                messageEl.textContent = 'FATAL ERROR: ' + error.message;
                posterStatusEl.textContent = 'Lỗi xử lý ảnh.';
                posterStatusEl.style.color = COLORS.ERROR;
            }
        };

        const handleEditMovie = async (e) => {
            e.preventDefault();
            const movieId = $('edit-movie-id').value;
            const data = extractMovieData('edit-');
            const messageEl = $('edit-movie-form-message');
            const posterStatusEl = $('edit-poster-upload-status');
            const bannerStatusEl = $('edit-banner-upload-status');

            messageEl.textContent = posterStatusEl.textContent = bannerStatusEl.textContent = '';
            
            if (!movieId) { messageEl.textContent = 'FATAL ERROR: Không tìm thấy Movie ID.'; return; }
            if (!data.title || data.genres.length === 0) { messageEl.textContent = 'WARNING! Vui lòng điền Tên Phim và chọn ít nhất 1 Thể Loại.'; return; }
            
            let isPosterUpdated = false;
            let finalPosterUrl = data.posterUrlInput;
            let isBannerUpdated = false;
            let finalBannerUrl = data.bannerUrlInput;

            try {
                if (data.posterFileInput) {
                    isPosterUpdated = true;
                    posterStatusEl.textContent = 'Đang xử lý ảnh mới (Base64)...';
                    posterStatusEl.style.color = COLORS.SUCCESS;
                    finalPosterUrl = await readFileAsBase64(data.posterFileInput, MAX_POSTER_SIZE_BYTES);
                    posterStatusEl.textContent = 'Tệp Base64 mới đã sẵn sàng!';
                } else if (data.posterUrlInput) {
                     isPosterUpdated = true;
                }

                if (data.bannerFileInput) {
                    isBannerUpdated = true;
                    bannerStatusEl.textContent = 'Đang xử lý banner mới (Base64)...';
                    bannerStatusEl.style.color = COLORS.SUCCESS;
                    finalBannerUrl = await readFileAsBase64(data.bannerFileInput, MAX_POSTER_SIZE_BYTES);
                    bannerStatusEl.textContent = 'Banner Base64 mới đã sẵn sàng!';
                } else if (data.bannerUrlInput) {
                    isBannerUpdated = true;
                }
                
                const movieDocRef = doc(moviesCollectionRef, movieId);
                
                const oldDoc = await getDoc(movieDocRef);
                const oldData = oldDoc.data();

                const updateData = {
                    title: data.title,
                    titleOriginal: data.titleOriginal || '',
                    genre: data.genres.join(', '),
                    summary: data.summary,
                    updatedBy: userId,
                    formatType: data.formatType,
                    season: data.season,
                    totalEpisodes: data.totalEpisodes,
                    status: data.status,
                    airingDay: data.airingDay
                };
                
                if (oldData && oldData.reviewCount === undefined) {
                    updateData.reviewCount = 0;
                    updateData.reviewTotal = 0;
                }
                
                if (isPosterUpdated) { updateData.posterUrl = finalPosterUrl; }
                if (isBannerUpdated) { updateData.bannerUrl = finalBannerUrl; }

                await updateDoc(movieDocRef, updateData);

                $('edit-movie-form').reset();
                posterStatusEl.textContent = bannerStatusEl.textContent = ''; 
                document.querySelectorAll('#edit-genre-tag-container .genre-tag.selected').forEach(tag => tag.classList.remove('selected'));
                
                hideModal('edit-movie-modal');

            } catch (error) {
                console.error("Lỗi khi cập nhật phim:", error);
                messageEl.textContent = 'FATAL ERROR: ' + error.message;
                posterStatusEl.textContent = 'Lỗi xử lý ảnh.';
                posterStatusEl.style.color = COLORS.ERROR;
            }
        };

        window.handleFixLegacyData = async () => {
            const confirmed = await window.showConfirmModal("Bạn có chắc muốn quét và sửa dữ liệu Review cho TẤT CẢ phim không? (Chỉ cần chạy 1 lần)");
            if (!confirmed) return;
            
            const msgEl = $('fix-legacy-status');
            if (msgEl) msgEl.textContent = "Đang quét dữ liệu... Vui lòng đợi...";
            
            try {
                const q = query(moviesCollectionRef);
                const querySnapshot = await getDocs(q);
                const batch = writeBatch(db);
                let updateCount = 0;
                
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.reviewCount === undefined || data.reviewTotal === undefined) {
                        const docRef = doc(moviesCollectionRef, docSnap.id);
                        batch.update(docRef, {
                            reviewCount: data.reviewCount || 0,
                            reviewTotal: data.reviewTotal || 0
                        });
                        updateCount++;
                    }
                });
                
                if (updateCount > 0) {
                    alert(`Đã sửa dữ liệu cho ${updateCount} phim cũ thành công!`);
                } else {
                    alert("Dữ liệu tất cả phim đều đã chuẩn. Không cần sửa gì thêm.");
                }
                if (msgEl) msgEl.textContent = "";
                
            } catch (error) {
                console.error("Lỗi khi sửa dữ liệu cũ:", error);
                alert("Lỗi: " + error.message);
            }
        };
        
        // NEW: Thêm hàm xóa tất cả tập phim
        window.handleDeleteAllEpisodes = async (movieId, movieTitle) => {
            const confirmed = await window.showConfirmModal(`CẢNH BÁO: Bạn có chắc chắn muốn XÓA TOÀN BỘ ${movieTitle}'s Episodes không?`);
            if (!confirmed) return;

            try {
                const movieDocRef = doc(moviesCollectionRef, movieId);
                
                await updateDoc(movieDocRef, { 
                    episodes: [], // Đặt mảng episodes về rỗng
                    lastEpisodeUpdate: serverTimestamp() 
                });
                
                window.showConfirmModal(`SUCCESS: Đã xóa toàn bộ tập phim của "${movieTitle}".`);
                hideModal('edit-movie-modal');
                
            } catch (error) {
                console.error("Lỗi khi xóa tất cả tập phim:", error);
                window.showConfirmModal('LỖI: Không thể xóa toàn bộ tập phim. Vui lòng kiểm tra lại quyền truy cập.');
            }
        };


        const handleAddEpisode = async (e) => {
            e.preventDefault();
            const movieId = $('episode-movie-id').value;
            const episodeNumber = parseInt($('episode-number').value);
            const title = $('episode-title').value.trim();
            const videoUrl = $('episode-url').value.trim();
            const messageEl = $('episode-form-message');

            if (isNaN(episodeNumber) || !title || !videoUrl || episodeNumber < 1) {
                messageEl.textContent = 'INVALID INPUT! Vui lòng điền thông tin tập phim hợp lệ.';
                return;
            }
            messageEl.textContent = '';
            
            if (!moviesCollectionRef || !userId) { messageEl.textContent = 'SYSTEM STATUS: Bạn không có quyền Admin.'; return; }

            try {
                const movieDocRef = doc(moviesCollectionRef, movieId);
                const movieSnap = await getDoc(movieDocRef);
                const existingEpisodes = movieSnap.data()?.episodes || [];
                
                if (existingEpisodes.some(ep => ep.episodeNumber === episodeNumber)) {
                    messageEl.textContent = `LỖI: Số tập ${episodeNumber} đã tồn tại trong phim này.`;
                    return;
                }
                
                const newEpisode = { episodeNumber, title, videoUrl, addedAt: new Date().toISOString() }; 
                
                existingEpisodes.push(newEpisode);
                existingEpisodes.sort((a, b) => a.episodeNumber - b.episodeNumber);

                await updateDoc(movieDocRef, { 
                    episodes: existingEpisodes,
                    lastEpisodeUpdate: serverTimestamp() 
                });
                
                $('add-episode-form').reset();
                hideModal('add-episode-modal');
            } catch (error) {
                console.error("Lỗi khi thêm tập phim mới:", error);
                messageEl.textContent = 'EPISODE ADD ERROR: Lỗi hệ thống khi lưu tập phim: ' + error.message;
            }
        };

        // START: NEW BULK ADD EPISODES LOGIC
        // Định nghĩa số lượng tối đa cho mỗi lần ghi vào Firestore để tránh Timeout/Lỗi
        const MAX_EPISODES_PER_COMMIT = 500; 

        const handleBulkAddEpisodes = async (e) => {
            e.preventDefault();
            const movieId = $('bulk-episode-movie-id').value;
            const startNumber = parseInt($('bulk-episode-start-number').value);
            const urlsText = $('bulk-episode-urls').value.trim();
            const messageEl = $('bulk-episode-form-message');

            messageEl.textContent = '';
            messageEl.style.color = COLORS.ERROR; // Mặc định lỗi

            const urls = urlsText.split('\n').map(url => url.trim()).filter(url => url.length > 0);
            const urlCount = urls.length;

            if (isNaN(startNumber) || startNumber < 1 || urlCount === 0) {
                messageEl.textContent = 'INVALID INPUT! Vui lòng điền Số tập bắt đầu hợp lệ (>= 1) và cung cấp danh sách link.';
                return;
            }
            if (!moviesCollectionRef || !userId) { 
                messageEl.textContent = 'SYSTEM STATUS: Bạn không có quyền Admin.'; 
                return; 
            }
            
            if (urlCount > 1000) { // Cảnh báo nhưng vẫn cho phép chạy
                 const confirmed = await window.showConfirmModal(`WARNING: Bạn đang cố gắng thêm ${urlCount} tập. Điều này có thể gây ra lỗi Timeout hoặc Lỗi Kích thước Document. Bạn có muốn tiếp tục không? (Khuyến nghị: < 500 tập/lần)`);
                 if (!confirmed) {
                    messageEl.textContent = 'Đã hủy thao tác Bulk Add.';
                    messageEl.style.color = COLORS.SUCCESS;
                    return;
                 }
            }


            try {
                const movieDocRef = doc(moviesCollectionRef, movieId);
                const movieSnap = await getDoc(movieDocRef);
                let existingEpisodes = movieSnap.data()?.episodes || [];
                
                let episodeNumber = startNumber;
                const newEpisodes = [];
                let conflictingUrls = 0;
                let conflictingNumbers = 0;
                
                const existingNumbers = new Set(existingEpisodes.map(ep => ep.episodeNumber));
                const existingUrls = new Set(existingEpisodes.map(ep => ep.videoUrl));

                messageEl.textContent = `Đang xử lý ${urlCount} link...`;
                messageEl.style.color = COLORS.SUCCESS;
                
                for (const url of urls) {
                    if (existingUrls.has(url)) {
                        conflictingUrls++;
                        continue; 
                    }
                    if (existingNumbers.has(episodeNumber)) {
                        conflictingNumbers++;
                        // Tăng số tập lên cho đến khi tìm được số chưa tồn tại
                        while(existingNumbers.has(episodeNumber)) {
                            episodeNumber++;
                        }
                    }
                    
                    const newEpisode = { 
                        episodeNumber: episodeNumber, 
                        title: `Tập ${episodeNumber}`, // Đã sửa: Tên tập chỉ là "Tập N"
                        videoUrl: url, 
                        addedAt: new Date().toISOString() 
                    }; 
                    
                    newEpisodes.push(newEpisode);
                    episodeNumber++;
                }

                if (newEpisodes.length === 0) {
                     messageEl.textContent = 'LỖI: Không có tập phim hợp lệ nào để thêm. Có thể tất cả đều bị trùng URL hoặc số tập bị xung đột.';
                     messageEl.style.color = COLORS.ERROR;
                     return;
                }

                // Cập nhật mảng episode và sort
                existingEpisodes = [...existingEpisodes, ...newEpisodes];
                existingEpisodes.sort((a, b) => a.episodeNumber - b.episodeNumber);

                await updateDoc(movieDocRef, { 
                    episodes: existingEpisodes,
                    lastEpisodeUpdate: serverTimestamp() 
                });
                
                let warning = '';
                if (conflictingUrls > 0) {
                    warning += `Lưu ý: Đã bỏ qua ${conflictingUrls} link bị trùng URL. `;
                }
                if (conflictingNumbers > 0) {
                    warning += `Lưu ý: Đã tự động điều chỉnh số tập bắt đầu (tăng lên) để tránh ${conflictingNumbers} tập bị trùng số.`;
                }
                
                messageEl.textContent = `SUCCESS! Đã thêm thành công ${newEpisodes.length} tập phim. ${warning}`;
                messageEl.style.color = COLORS.SUCCESS;

                $('bulk-add-episode-form').reset();
                setTimeout(() => hideModal('bulk-add-episode-modal'), 1500);

            } catch (error) {
                console.error("Lỗi khi thêm tập phim hàng loạt:", error);
                messageEl.textContent = 'BULK ADD ERROR: Lỗi hệ thống khi lưu tập phim: ' + error.message;
                messageEl.style.color = COLORS.ERROR;
            }
        };

        window.showBulkAddEpisodeModal = (movieId, movieTitle) => {
            const movie = globalAdminMoviesCache.find(m => m.id === movieId);
            const lastEpisodeNumber = movie?.episodes?.length || 0;

            $('bulk-episode-movie-id').value = movieId;
            $('bulk-episode-movie-title').textContent = movieTitle || '[Không có tên]';
            $('bulk-episode-form-message').textContent = '';
            $('bulk-episode-urls').value = '';
            $('bulk-episode-warning').textContent = 'Khuyến nghị: Mỗi lần thêm tối đa 500 link để đảm bảo ổn định.';

            
            // Đặt mặc định là tập cuối + 1
            $('bulk-episode-start-number').value = lastEpisodeNumber + 1;
            
            // Thêm listener oninput để tính toán số lượng link và đưa ra cảnh báo
            const urlsTextarea = $('bulk-episode-urls');
            const warningEl = $('bulk-episode-warning');

            const updateWarning = () => {
                const urls = urlsTextarea.value.trim().split('\n').map(url => url.trim()).filter(url => url.length > 0);
                const count = urls.length;
                
                if (count === 0) {
                    warningEl.textContent = 'Khuyến nghị: Mỗi lần thêm tối đa 500 link để đảm bảo ổn định.';
                    warningEl.classList.remove('text-red-500');
                    warningEl.classList.add('text-yellow-400');
                } else if (count > MAX_EPISODES_PER_COMMIT) {
                    warningEl.textContent = `⚠️ CẢNH BÁO: Bạn đang nhập ${count} link. Số lượng lớn có thể gây lỗi Timeout. Khuyến nghị: < 500.`;
                    warningEl.classList.add('text-red-500');
                    warningEl.classList.remove('text-yellow-400');
                } else {
                    warningEl.textContent = `Đã nhập ${count} link. Sẵn sàng xử lý.`;
                    warningEl.classList.remove('text-red-500');
                    warningEl.classList.add('text-yellow-400');
                }
            };
            
            urlsTextarea.oninput = updateWarning;
            
            showModal('bulk-add-episode-modal');
        };
        // END: NEW BULK ADD EPISODES LOGIC


        const handleEditEpisode = async (e) => {
            e.preventDefault();
            const movieId = $('edit-episode-movie-id').value;
            const originalEpisodeNumber = parseInt($('edit-episode-number-original').value);
            
            const newEpisodeNumber = parseInt($('edit-episode-number').value);
            const newTitle = $('edit-episode-title').value.trim();
            const newVideoUrl = $('edit-episode-url').value.trim();
            const messageEl = $('edit-episode-form-message');

            if (isNaN(newEpisodeNumber) || !newTitle || !newVideoUrl || newEpisodeNumber < 1) {
                messageEl.textContent = 'INVALID INPUT! Vui lòng điền thông tin hợp lệ.';
                return;
            }
            messageEl.textContent = '';
            
            try {
                const movieDocRef = doc(moviesCollectionRef, movieId);
                const movieSnap = await getDoc(movieDocRef);
                const movieData = movieSnap.data();
                let episodes = movieData.episodes || [];
                
                if (newEpisodeNumber !== originalEpisodeNumber && episodes.some(ep => ep.episodeNumber === newEpisodeNumber)) {
                    messageEl.textContent = `LỖI: Số tập ${newEpisodeNumber} đã tồn tại.`;
                    return;
                }

                const episodeIndex = episodes.findIndex(ep => ep.episodeNumber === originalEpisodeNumber);
                if (episodeIndex === -1) {
                    messageEl.textContent = 'LỖI HỆ THỐNG: Không tìm thấy tập gốc để cập nhật.';
                    return;
                }
                
                episodes[episodeIndex] = { 
                    ...(episodes[episodeIndex] || {}), 
                    episodeNumber: newEpisodeNumber, 
                    title: newTitle, 
                    videoUrl: newVideoUrl,
                    updatedAt: new Date().toISOString() 
                };
                
                episodes.sort((a, b) => a.episodeNumber - b.episodeNumber);

                await updateDoc(movieDocRef, { 
                    episodes: episodes,
                    lastEpisodeUpdate: serverTimestamp() 
                });
                
                $('edit-episode-form').reset();
                hideModal('edit-episode-modal');

            } catch (error) {
                console.error("Lỗi khi cập nhật tập phim:", error);
                messageEl.textContent = 'EPISODE UPDATE ERROR: ' + error.message;
            }
        };

        window.handleDeleteMovie = async (movieId, movieTitle) => {
            const confirmed = await window.showConfirmModal(`Bạn có chắc chắn muốn xóa TOÀN BỘ phim "${movieTitle}"?`);
            if (confirmed) {
                try {
                    await deleteDoc(doc(moviesCollectionRef, movieId));
                } catch (error) { console.error("Lỗi khi xóa phim:", error); }
            }
        };
        window.handleDeleteEpisode = async (movieId, episodeNumber, episodeTitle) => {
            const confirmed = await window.showConfirmModal(`Bạn có chắc muốn xóa TẬP ${episodeNumber} ("${episodeTitle}")?`);
            if (!confirmed) return;
            
            try {
                const movieDocRef = doc(moviesCollectionRef, movieId);
                const movieSnap = await getDoc(movieDocRef);
                const episodes = movieSnap.data()?.episodes || [];
                
                const updatedEpisodes = episodes.filter(ep => ep.episodeNumber !== episodeNumber);
                
                await updateDoc(movieDocRef, { episodes: updatedEpisodes });
                
            } catch (error) {
                console.error("Lỗi khi xóa tập phim:", error);
            }
        };

        
        const router = () => {
            const hash = window.location.hash.substring(1) || 'dashboard';
            
            document.querySelectorAll('#admin-main-view button[data-hash]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.hash === `#${hash}`);
                btn.style.borderBottomColor = btn.dataset.hash === `#${hash}` ? '#00ffaa' : 'transparent';
                btn.style.color = btn.dataset.hash === `#${hash}` ? '#00ffaa' : '#e0e7ff';
            });
            
            if (!userId) {
                if (hash !== 'login') window.location.hash = '#login';
                $('main-content').innerHTML = ''; 
                return;
            }

            switch (hash) {
                case 'dashboard':
                    renderAdminDashboard();
                    break;
                case 'profile':
                    renderProfilePage();
                    break;
                case 'schedule':
                    renderSchedulePage();
                    break;
                case 'login':
                    window.location.hash = '#dashboard'; 
                    break;
                default:
                    window.location.hash = '#dashboard';
            }
        };

        const initFirebase = async () => {
            try {
                if (!getApps().length) {
                    app = initializeApp(finalConfig);
                } else {
                    app = getApps()[0];
                }
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserSessionPersistence);

                adminProfilesCollectionRef = collection(db, 'artifacts', appId, 'adminProfiles');

                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        
                        try {
                            const adminDocRef = doc(adminProfilesCollectionRef, user.uid);
                            const adminDocSnap = await getDoc(adminDocRef);
                            const role = adminDocSnap.exists() ? adminDocSnap.data().role : 'user';
                            
                            if (role !== 'admin') {
                                await signOut(auth);
                                updateAuthStatusHeader('QUYỀN BỊ THU HỒI: Bạn không có quyền Admin.', true);
                                return;
                            }
                        } catch (error) {
                             console.error("Lỗi khi kiểm tra role trong onAuthStateChanged:", error);
                             await signOut(auth);
                             updateAuthStatusHeader('Lỗi hệ thống: Không thể xác minh quyền Admin.', true);
                             return;
                        }


                        userId = user.uid;
                        userEmail = user.email;
                        
                        moviesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'movies');
                        
                        userProfileDocRef = doc(adminProfilesCollectionRef, userId); 
                        
                        try {
                            onSnapshot(userProfileDocRef, (docSnap) => {
                                currentUserProfile = docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : {};
                                updateProfileHeader();
                            }, (error) => { 
                                console.error("Lỗi tải profile:", error.message); 
                                currentUserProfile = {}; 
                                updateProfileHeader(); 
                            });
                            
                            // Lắng nghe thay đổi của tất cả admin để cập nhật adminProfileMap
                            onSnapshot(adminProfilesCollectionRef, (snapshot) => {
                                adminProfileMap = {};
                                snapshot.forEach(doc => {
                                    adminProfileMap[doc.id] = doc.data().displayName || doc.data().email;
                                });
                                renderDashboardDynamicContent(); // Cập nhật danh sách phim để hiển thị tên Admin mới
                            });
                            
                        } catch (e) {
                             console.error("Lỗi nghiêm trọng khi gắn listener profile:", e);
                        }
                        
                        updateAuthStatusHeader(`Đã đăng nhập: ${userEmail}`, false);
                        loadMovies(); 
                        router(); 

                    } else {
                        userId = userEmail = moviesCollectionRef = null;
                        currentUserProfile = {};
                        globalAdminMoviesCache = [];
                        updateProfileHeader();
                        updateAuthStatusHeader('Vui lòng Đăng nhập Admin.');
                        if (unsubscribeMoviesListener) {
                            unsubscribeMoviesListener();
                            unsubscribeMoviesListener = null;
                        }
                        router();
                    }
                    showLoading(false);
                });

            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                updateAuthStatusHeader(`Cấu hình Firebase không hợp lệ. Chi tiết: ${error.message}`, true); 
                showLoading(false);
            }
        };

        const loadMovies = () => {
            if (!moviesCollectionRef || unsubscribeMoviesListener) return;
            
            try {
                const q = query(moviesCollectionRef);
                
                unsubscribeMoviesListener = onSnapshot(q, (snapshot) => {
                    const movies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sắp xếp theo thời gian tạo mới nhất
                    movies.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    
                    globalAdminMoviesCache = movies;
                    
                    const hash = window.location.hash.substring(1) || 'dashboard';
                    if (hash === 'dashboard') {
                         renderAdminDashboard(); 
                         renderDashboardDynamicContent(); 
                    } else if (hash === 'schedule') {
                         renderSchedulePage();
                    }
                    
                }, (error) => {
                    console.error("Lỗi khi tải danh sách phim (onSnapshot):", error);
                    if (window.location.hash.substring(1) === 'dashboard') {
                        $('main-content').innerHTML = '<p class="text-[#ff69b4] font-bold text-center py-8">Lỗi tải dữ liệu. Vui lòng kiểm tra Quy tắc Bảo mật Firestore và quyền truy cập vào Movies.</p>';
                    }
                });
            } catch (e) {
                 console.error("Lỗi thiết lập listener phim:", e);
            }
        };

        const getFilteredAndPaginatedMovies = () => {
            let result = globalAdminMoviesCache.filter(movie => {
                const matchTitle = (movie.title || '').toLowerCase().includes(filterState.title.toLowerCase());
                const matchGenre = filterState.genre === '' || (movie.genre || '').includes(filterState.genre);
                
                const creatorName = adminProfileMap[movie.updatedBy] || '';
                const matchCreator = (creatorName.toLowerCase().includes(filterState.creator.toLowerCase())) || 
                                     ((movie.updatedBy || '').includes(filterState.creator));
                                     
                return matchTitle && matchGenre && matchCreator;
            });

            const totalPages = Math.ceil(result.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = totalPages > 0 ? totalPages : 1; 
            
            const start = (currentPage - 1) * itemsPerPage;
            const paginated = result.slice(start, start + itemsPerPage);

            return { data: paginated, total: result.length, totalPages };
        };
        
        window.handleFilterChange = (key, value) => {
            filterState[key] = value;
            currentPage = 1; 
            renderDashboardDynamicContent(); 
        };

        window.changePage = (delta) => {
            currentPage += delta;
            renderDashboardDynamicContent(); 
        };

        window.toggleGenreDropdown = (targetId, event) => {
             const dropdown = $(targetId);
             const isHidden = dropdown.classList.contains('hidden');
             document.querySelectorAll('.custom-dropdown-menu').forEach(d => {
                 if (d.id !== targetId) d.classList.add('hidden');
             });
             
             if (isHidden) {
                dropdown.classList.remove('hidden');
             } else {
                 dropdown.classList.add('hidden');
             }
        };
        
        const renderDashboardDynamicContent = () => {
            const container = $('dynamic-dashboard-content'); 
            if (!container) return; 

            const { data, total, totalPages } = getFilteredAndPaginatedMovies();
            const movieListHtml = renderMovieListContent(data);
            
            container.innerHTML = `
                
                <div id="movie-list" class="space-y-4">${movieListHtml}</div>
                
                <div class="mt-6 flex justify-center items-center space-x-4">
                    <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">
                        <i class="fas fa-chevron-left"></i> Prev
                    </button>
                    <span class="text-[#00ffaa] font-bold">Page ${currentPage} / ${totalPages || 1}</span>
                    <button class="pagination-btn" ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(1)">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
            
            const totalMoviesDisplay = $('stat-total-movies-display');
            if (totalMoviesDisplay) totalMoviesDisplay.textContent = total;
            
            // Thêm listeners cho nút thêm tập đơn
            container.querySelectorAll('.add-episode-btn').forEach(button => {
                button.addEventListener('click', function() {
                    window.showAddEpisodeModal(this.getAttribute('data-movie-id'), this.getAttribute('data-movie-title'));
                });
            });

            // Thêm listeners cho nút thêm tập hàng loạt
             container.querySelectorAll('.bulk-add-episode-btn').forEach(button => {
                button.addEventListener('click', function() {
                    window.showBulkAddEpisodeModal(this.getAttribute('data-movie-id'), this.getAttribute('data-movie-title'));
                });
            });

            // Thêm listeners cho nút sửa phim
            container.querySelectorAll('.edit-movie-btn').forEach(button => {
                button.addEventListener('click', function() {
                    window.showEditMovieModal(this.getAttribute('data-movie-id'));
                });
            });
            
        };

        const renderAdminDashboard = () => {
            const selectedGenreName = filterState.genre === '' ? '-- Tất cả thể loại --' : (GENRE_TRANSLATIONS[filterState.genre] ? `${filterState.genre} (${GENRE_TRANSLATIONS[filterState.genre]})` : filterState.genre);
            
            const genreTagListHtml = ALL_GENRES.map(g => {
                const vietnameseName = GENRE_TRANSLATIONS[g] || g;
                return `
                <button type="button" 
                        onclick="handleFilterChange('genre', '${g}')" 
                        class="genre-tag ${filterState.genre === g ? 'selected' : ''}">
                    ${g} <span class="text-xs text-gray-400 ml-1">(${vietnameseName})</span>
                </button>
            `}).join('');
            
            const totalMoviesCache = globalAdminMoviesCache.length;
            const totalEpisodes = globalAdminMoviesCache.reduce((acc, movie) => acc + (movie.episodes?.length || 0), 0);
            
            $('main-content').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-[#2f1d56] p-6 rounded-xl shadow-lg panel-border">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold text-[#00ffaa]">DANH SÁCH MOVIE (<span id="stat-total-movies-display">${getFilteredAndPaginatedMovies().total}</span>)</h2>
                            <div class="flex flex-wrap gap-2">
                                <a href="#schedule" class="anime-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center text-sm">
                                    <i class="fas fa-calendar-alt mr-2"></i> Lịch Chiếu
                                </a>
                                <button onclick="showModal('add-movie-modal')" class="anime-button bg-[#ff69b4] hover:bg-[#ff0080] text-gray-900 font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                                    <i class="fas fa-plus mr-2"></i> Thêm Phim
                                </button>
                                <!-- Nút Import Phim (Bulk Import Movies) đã được thêm lại -->
                                <button onclick="showModal('bulk-import-modal')" class="anime-button bg-[#bf94e4] hover:bg-[#a06ec4] text-gray-900 font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                                    <i class="fas fa-file-import mr-2"></i> Import Phim
                                </button>
                                
                                <button onclick="handleFixLegacyData()" class="anime-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg shadow-md flex items-center text-xs">
                                    <i class="fas fa-wrench mr-2"></i> FIX DATA
                                </button>
                            </div>
                        </div>
                        
                        <div id="fix-legacy-status" class="text-[#00ffaa] font-bold mb-2"></div>
                        
                        <div class="filter-bar-container">
                            <div class="flex-grow">
                                <input type="text" id="filter-title-input" placeholder="🔍 Tìm tên phim..." class="form-input h-10 text-sm" 
                                       value="${filterState.title}" oninput="handleFilterChange('title', this.value)">
                            </div>
                            
                            <div class="relative w-full sm:w-auto">
                                <button type="button" id="genre-filter-button"
                                        onclick="window.toggleGenreDropdown('genre-filter-dropdown', event)" 
                                        class="anime-button bg-[#1a0f3d] hover:bg-[#2f1d56] border border-[#00ffaa] text-[#00ffaa] text-sm font-semibold py-2 px-3 rounded-lg w-full sm:w-64 flex items-center justify-between text-left">
                                    <span class="truncate">${selectedGenreName}</span>
                                    <i class="fas fa-chevron-down ml-2"></i>
                                </button>
                                
                                <div id="genre-filter-dropdown" 
                                     class="custom-dropdown-menu absolute bg-[#2f1d56] p-2 rounded-lg shadow-xl hidden w-full sm:w-96">
                                    <button type="button" 
                                            onclick="handleFilterChange('genre', '')" 
                                            class="genre-tag w-full mb-2 ${filterState.genre === '' ? 'selected' : ''}">
                                        -- Tất cả thể loại --
                                    </button>
                                    <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
                                        ${genreTagListHtml}
                                    </div>
                                </div>
                            </div>
                            
                             <div class="flex-grow sm:flex-grow-0">
                                <input type="text" id="filter-creator-input" placeholder="👤 Tên Admin..." class="form-input h-10 text-sm" 
                                       value="${filterState.creator}" oninput="handleFilterChange('creator', this.value)">
                            </div>
                        </div>
                        
                        <div id="dynamic-dashboard-content">
                            <p class="text-center text-gray-400 py-8">Đang tải danh sách phim...</p>
                        </div>
                        
                    </div>

                    <div class="lg:col-span-1">
                        <div id="admin-info" class="bg-[#2f1d56] p-6 rounded-xl shadow-lg panel-border sticky top-8">
                            <h2 class="text-xl font-semibold text-[#00ffaa] mb-4">THỐNG KÊ (STATS)</h2>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-[#1e1346] p-4 rounded-lg border border-[#5d3f9e]">
                                    <p class="text-sm text-gray-400">TỔNG SỐ PHIM (Cache)</p>
                                    <p class="text-3xl font-bold text-[#00ffaa]">${totalMoviesCache}</p>
                                </div>
                                <div class="bg-[#1e1346] p-4 rounded-lg border border-[#5d3f9e]">
                                    <p class="text-sm text-gray-400">TỔNG SỐ TẬP</p>
                                    <p id="stat-total-episodes" class="text-3xl font-bold text-[#ff69b4]">${totalEpisodes}</p>
                                </div>
                            </div>
                            
                            <h2 class="text-xl font-semibold text-[#00ffaa] mb-4">HỆ THỐNG INFO</h2>
                            <div class="space-y-3 text-sm text-[#e0e7ff]">
                                <p><strong>App ID:</strong> <span id="display-app-id" class="break-all text-blue-300">${appId}</span></p>
                                <p><strong>User ID:</strong> <span id="display-user-id" class="break-all text-[#00ffaa]">${userId || 'CHƯA ĐĂNG NHẬP'}</span></p>
                                <p class="pt-2 border-t border-gray-600 text-xs">Database Location: <code class="bg-gray-800 p-1 rounded text-yellow-300 break-all">/artifacts/{appId}/public/data/movies</code></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.addEventListener('click', function(event) {
                 const dropdown = $('genre-filter-dropdown');
                 const dropdownButton = $('genre-filter-button');
                 
                 if (dropdown && !dropdown.classList.contains('hidden')) {
                     const isClickInsideButton = event.target.closest('#genre-filter-button');
                     const isClickInsideDropdown = event.target.closest('#genre-filter-dropdown');
                     
                     if (!isClickInsideButton && !isClickInsideDropdown) {
                         dropdown.classList.add('hidden');
                     }
                 }
            });
            
            renderDashboardDynamicContent();
        };
        
        const renderProfilePage = () => {
            const profile = currentUserProfile;
             $('main-content').innerHTML = `
                <div class="max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card bg-[#2f1d56] p-8 rounded-xl shadow-2xl panel-border">
                        <h2 class="text-3xl font-bold text-[#ff69b4] mb-6 border-b border-[#5d3f9e] pb-2">CHỈNH SỬA PROFILE</h2>
                        <div class="flex items-center space-x-4 mb-8">
                            <img id="profile-avatar-preview" src="${profile.avatarBase64 || `https://placehold.co/80x80/ff69b4/ffffff?text=${(profile.displayName || (userEmail ? userEmail.charAt(0) : 'AD')).toUpperCase()}`}" alt="Admin Avatar" class="w-20 h-20 rounded-full border-4 border-[#00ffaa] object-cover">
                            <div>
                                <p class="text-2xl font-bold text-[#00ffaa]">${profile.displayName || userEmail}</p>
                                <p class="text-sm text-gray-400">Email: ${userEmail}</p>
                            </div>
                        </div>

                        <form id="profile-form">
                            <div class="mb-4">
                                <label class="block text-[#e0e7ff] text-sm font-bold mb-2" for="profile-display-name">Tên Hiển Thị</label>
                                <input class="form-input" id="profile-display-name" type="text" placeholder="Ví dụ: Sensei, Dev-chan" value="${profile.displayName || ''}">
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-[#e0e7ff] text-sm font-bold mb-2" for="profile-avatar-file">Ảnh Đại Diện (Max 0.5MB)</label>
                                <input class="shadow border border-[#5d3f9e] rounded w-full py-2 px-3 bg-[#1a0f3d] text-white leading-tight focus:outline-none focus:ring-2 focus:ring-[#ff69b4] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#ff69b4]/20 file:text-[#ff69b4]" 
                                       id="profile-avatar-file" type="file" accept="image/png, image/jpeg">
                                <p class="text-xs text-gray-500 mt-2">Ảnh được lưu dưới dạng Base64 trong Firestore.</p>
                            </div>
                            
                            <p id="profile-message" class="text-[#00ffaa] text-sm mb-4"></p>

                            <button type="submit" class="anime-button bg-[#00ffaa] hover:bg-[#00cc88] text-gray-900 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#ff69b4] w-full">
                                <i class="fas fa-save mr-2"></i> LƯU PROFILE
                            </button>
                        </form>
                    </div>
                    
                    <div class="card bg-[#2f1d56] p-8 rounded-xl shadow-2xl panel-border">
                        <h2 class="text-3xl font-bold text-[#00ffaa] mb-6 border-b border-[#5d3f9e] pb-2">QUẢN LÝ TÀI KHOẢN</h2>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-[#e0e7ff] mb-3">Đổi Mật khẩu Của Bạn</h3>
                            <form id="changePasswordForm">
                                <label class="block text-[#e0e7ff] text-sm font-bold mb-2">Mật khẩu mới:</label>
                                <input class="form-input" type="password" id="newPass" required placeholder="Nhập mật khẩu mới (min 6 ký tự)">
                                <label class="block text-[#e0e7ff] text-sm font-bold mb-2">Xác nhận mật khẩu mới:</label>
                                <input class="form-input" type="password" id="confirmNewPass" required placeholder="Xác nhận mật khẩu">
                                <p id="change-pass-msg" class="text-sm mt-2 mb-4"></p>
                                <button type="submit" class="anime-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg w-full">
                                    <i class="fas fa-key mr-2"></i> ĐỔI MẬT KHẨU
                                </button>
                            </form>
                        </div>
                        
                        <hr class="border-t border-gray-700 my-6">
                        <div class="pt-2">
                            <h3 class="text-xl font-bold text-[#e0e7ff] mb-3">Tạo Tài Khoản Admin Mới</h3>
                            <form id="create-admin-form">
                                <label class="block text-[#e0e7ff] text-sm font-bold mb-2">Email Admin Mới:</label>
                                <input class="form-input" type="email" id="newAdminEmail" placeholder="ví dụ: sub@admin.com" required>
                                <label class="block text-[#e0e7ff] text-sm font-bold mb-2">Mật khẩu:</label>
                                <input class="form-input" type="password" id="newAdminPass" placeholder="Ít nhất 6 ký tự" required>
                                <p id="create-admin-msg" class="text-sm mt-2 mb-4"></p>
                                <button type="submit" class="anime-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full">
                                    <i class="fas fa-user-plus mr-2"></i> TẠO TÀI KHOẢN
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            $('profile-avatar-file')?.addEventListener('change', (e) => {
                 const file = e.target.files[0];
                 if (file) {
                     const reader = new FileReader();
                     reader.onload = (e) => {
                         $('profile-avatar-preview').src = e.target.result;
                     };
                     reader.readAsDataURL(file);
                 }
            });
            $('profile-form')?.addEventListener('submit', handleSaveProfile);
            $('create-admin-form')?.addEventListener('submit', handleCreateAdmin);
            $('changePasswordForm')?.addEventListener('submit', handleChangePassword);
        };

        const renderSchedulePage = () => {
            const slots = ["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7", "Chủ Nhật", "Không có"];
            
            const scheduleMap = {};
            slots.forEach(s => scheduleMap[s] = []);

            globalAdminMoviesCache.filter(m => m.status !== 'tron-bo').forEach(m => {
                let day = m.airingDay || "Không có";
                if (!slots.includes(day)) day = "Không có";
                scheduleMap[day].push(m);
            });

            const gridHtml = slots.map(day => {
                const movies = scheduleMap[day];
                const hasMovies = movies.length > 0;
                
                return `
                    <div class="bg-[#1a0f3d] rounded-xl border border-[#5d3f9e] overflow-hidden flex flex-col h-full min-h-[200px] shadow-lg hover:shadow-[#ff69b4]/20 transition duration-300">
                        <div class="bg-[#2f1d56] py-3 text-center border-b border-[#5d3f9e]">
                            <h3 class="text-[#ff69b4] font-bold text-lg uppercase">${day}</h3>
                        </div>
                        <div class="p-3 flex-grow flex flex-col ${hasMovies ? 'justify-start' : 'justify-center'} custom-scrollbar overflow-y-auto max-h-[350px]">
                            ${hasMovies ? movies.map(m => `
                                <div class="flex gap-3 items-center bg-[#1e1346] p-2 rounded mb-2 hover:bg-[#2f1d56] border border-transparent hover:border-[#00ffaa] cursor-pointer group transition" onclick="window.showEditMovieModal('${m.id}')">
                                    <img src="${m.posterUrl}" class="w-12 h-16 object-cover rounded border border-[#5d3f9e] group-hover:border-[#00ffaa]" onerror="this.src='https://placehold.co/48x64'">
                                    <div class="min-w-0 overflow-hidden">
                                        <p class="text-sm font-bold text-gray-200 truncate group-hover:text-[#00ffaa] transition">${m.title}</p>
                                        <p class="text-xs text-gray-500">Tập ${(m.episodes||[]).length}</p>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500 text-sm italic text-center">Chưa có phim nào.</p>'}
                        </div>
                    </div>
                `;
            }).join('');

            $('main-content').innerHTML = `
                <div class="bg-[#2f1d56] p-6 rounded-xl shadow-lg panel-border min-h-[85vh]">
                    <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
                        <h2 class="text-2xl font-bold text-[#00ffaa] neon-glow">LỊCH CHIẾU PHIM TRONG TUẦN</h2>
                        <button onclick="location.hash='#dashboard'" class="bg-[#4b5563] hover:bg-[#374151] text-white text-sm font-bold py-2 px-6 rounded-lg flex items-center transition shadow-lg">
                            <i class="fas fa-arrow-left mr-2"></i> Quay lại Dashboard
                        </button>
                    </div>
                    
                    <div class="schedule-grid-container">
                        ${gridHtml}
                    </div>
                </div>
            `;
        };
        
        const renderEpisodeList = (episodes, movieId) => {
            if (!episodes || episodes.length === 0) {
                return '<p class="text-gray-500 italic text-sm">Chưa có tập phim nào. (No Data)</p>';
            }
            episodes.sort((a, b) => (a.episodeNumber || 0) - (b.episodeNumber || 0));
            
            const listItems = episodes.map(ep => {
                const title = ep.title || 'Không có tên';
                const safeTitle = title.replace(/'/g, "\\'"); 
                const previewUrl = getAdminPreviewUrl(ep.videoUrl); 
                return `
                <li class="flex items-center justify-between p-2 border-b border-[#5d3f9e] last:border-b-0 text-sm">
                    <div class="flex-grow truncate">
                        <!-- Hiển thị chỉ số tập và tên tập -->
                        <span class="font-medium text-[#00ffaa]">EP ${ep.episodeNumber || 'N/A'}:</span>
                        <span class="mx-2 text-white">${title}</span>
                    </div>
                    <div class="flex-shrink-0 flex items-center">
                        <a href="${previewUrl}" target="_blank" class="text-xs text-[#ff69b4] hover:text-[#f8d4e4] transition duration-150" title="Link Video (Mở Preview)">
                            <i class="fas fa-external-link-alt"></i> LINK
                        </a>
                        <button onclick="window.showEditEpisodeModal('${movieId}', ${ep.episodeNumber})" class="text-yellow-400 hover:text-yellow-300 ml-3" title="Sửa tập">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="window.handleDeleteEpisode('${movieId}', ${ep.episodeNumber}, '${safeTitle}')" class="text-red-500 hover:text-red-700 ml-2" title="Xóa tập">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
            `}).join('');

            return `<ul class="divide-y divide-[#1e1346] episode-list-scroll">${listItems}</ul>`;
        };
        
        const renderMovieListContent = (movies) => {
            if (movies.length === 0) {
                return '<p class="text-center text-[#ff69b4] font-bold py-8" id="no-movies-message">Chưa có phim nào (hoặc không khớp bộ lọc).</p>';
            }
            
            return movies.map(movie => {
                const titleHtml = movie.titleOriginal 
                    ? `<h3 class="text-xl font-bold text-[#e0e7ff] mb-1">${movie.title}</h3><h4 class="text-sm font-normal text-gray-400 -mt-1 mb-1">${movie.titleOriginal}</h4>`
                    : `<h3 class="text-xl font-bold text-[#e0e7ff] mb-1">${movie.title}</h3>`;
                const posterSrc = movie.posterUrl || 'https://placehold.co/100x150/1f2937/d1d5db?text=POSTER';
                const episodeCount = movie.episodes ? movie.episodes.length : 0;
                const totalEpisodes = movie.totalEpisodes || 0;
                const episodeText = totalEpisodes > 0 ? `${episodeCount} / ${totalEpisodes} tập` : `Tập ${episodeCount}`;

                // Tạo badge Admin ở góc phải trên cùng
                const creatorName = adminProfileMap[movie.updatedBy] ? 
                    `<div class="admin-badge-corner">Admin: ${adminProfileMap[movie.updatedBy]}</div>` : '';

                return `
                    <div class="movie-card-anime bg-[#1e1346] p-4 rounded-xl shadow-md border border-[#5d3f9e] transition duration-300 hover:border-[#ff69b4]">
                        ${creatorName} <!-- Đặt Admin Badge ở đây -->
                        
                        <div class="flex items-start space-x-4">
                            <img src="${posterSrc}" onerror="this.onerror=null;this.src='https://placehold.co/100x150/1f2937/d1d5db?text=POSTER';" 
                                 class="w-20 h-30 object-cover rounded-lg shadow-lg flex-shrink-0 border-2 border-[#ff69b4]" alt="Poster ${movie.title}">
                            
                            <div class="flex-grow">
                                ${titleHtml}
                                <p class="text-sm text-[#00ffaa] mb-2 italic">Genre: ${movie.genre || 'N/A'}</p>
                                <p class="text-gray-300 text-sm line-clamp-2">${movie.summary || 'Không có tóm tắt.'}</p>
                                
                                <div class="mt-3 flex flex-wrap gap-2 items-center">
                                    ${getStatusBadge(movie.status)}
                                    <span class="bg-[#2f1d56] text-[#00ffaa] text-xs font-semibold py-1 px-3 rounded-full border border-[#00ffaa]">Views: ${movie.viewCount || 0}</span>
                                    
                                    <div class="ml-auto flex space-x-2">
                                        <!-- Nút Thêm Tập Đơn -->
                                        <button data-movie-id="${movie.id}" data-movie-title="${movie.title}" class="add-episode-btn anime-button bg-[#ff69b4] hover:bg-[#ff0080] text-gray-900 text-xs font-semibold py-1 px-3 rounded-full transition duration-300">
                                            <i class="fas fa-bolt mr-1"></i> EP SINGLE
                                        </button>
                                        <!-- Nút Thêm Tập Hàng Loạt -->
                                        <button data-movie-id="${movie.id}" data-movie-title="${movie.title}" class="bulk-add-episode-btn anime-button bg-purple-600 hover:bg-purple-700 text-white text-xs font-semibold py-1 px-3 rounded-full transition duration-300">
                                            <i class="fas fa-stream mr-1"></i> EP BULK
                                        </button>
                                        
                                        <button data-movie-id="${movie.id}" class="edit-movie-btn anime-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 text-xs font-semibold py-1 px-3 rounded-full transition duration-300">
                                            <i class="fas fa-edit mr-1"></i> EDIT
                                        </button>
                                        
                                        <button onclick="window.handleDeleteMovie('${movie.id}', '${movie.title.replace(/'/g, "\\'")}')" class="anime-button bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded-full transition duration-300">
                                            <i class="fas fa-skull-crossbones mr-1"></i> DELETE
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-[#5d3f9e]">
                            <h4 class="text-lg font-semibold text-[#00ffaa] mb-2">EPISODE LIST (${episodeText})</h4>
                            ${renderEpisodeList(movie.episodes, movie.id)} 
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        const getStatusBadge = (statusKey) => {
            switch(statusKey) {
                case 'dang-chieu': return '<span class="bg-[#5d3f9e] text-white text-xs font-semibold py-1 px-3 rounded-full shadow-lg">Đang Chiếu</span>';
                case 'tron-bo': return '<span class="bg-green-500 text-gray-900 text-xs font-semibold py-1 px-3 rounded-full shadow-lg">Hoàn Thành</span>';
                case 'sap-chieu': return '<span class="bg-yellow-500 text-gray-900 text-xs font-semibold py-1 px-3 rounded-full shadow-lg">Sắp Chiếu</span>';
                default: return `<span class="bg-gray-700 text-white text-xs font-semibold py-1 px-3 rounded-full shadow-lg">${statusKey || 'N/A'}</span>`;
            }
        };

        window.showAddEpisodeModal = (movieId, movieTitle) => {
            $('episode-movie-id').value = movieId;
            $('episode-movie-title').textContent = movieTitle || '[Không có tên]';
            $('episode-form-message').textContent = '';
            $('add-episode-form').reset();
            $('episode-movie-id').value = movieId;

            showModal('add-episode-modal');
        };

        window.showEditMovieModal = async (movieId) => {
            if (!moviesCollectionRef) return;
            const movie = globalAdminMoviesCache.find(m => m.id === movieId);
            if (!movie) {
                 window.showConfirmModal("Lỗi: Không tìm thấy phim trong cache. Vui lòng tải lại trang.");
                 return;
            }
            
            $('edit-movie-id').value = movieId;
            $('edit-movie-title').value = movie.title || '';
            $('edit-movie-title-original').value = movie.titleOriginal || '';
            $('edit-movie-summary').value = movie.summary || '';
            
            $('edit-movie-formatType').value = movie.formatType || 'tv-series';
            $('edit-movie-season').value = movie.season || 'khac';
            $('edit-movie-totalEpisodes').value = movie.totalEpisodes || 0;
            $('edit-movie-status').value = movie.status || 'dang-chieu';
            $('edit-movie-airingDay').value = movie.airingDay || 'Không có';

            const isPosterBase64 = movie.posterUrl && movie.posterUrl.startsWith('data:image');
            $('edit-poster-upload-status').textContent = isPosterBase64 ? 'Phim đang dùng ảnh Base64. Tải tệp mới hoặc dán URL sẽ ghi đè.' : '';
            $('edit-movie-poster').value = isPosterBase64 ? '' : movie.posterUrl || '';
            
            const isBannerBase64 = movie.bannerUrl && movie.bannerUrl.startsWith('data:image');
            $('edit-banner-upload-status').textContent = isBannerBase64 ? 'Phim đang dùng banner Base64. Tải tệp mới/dán URL sẽ ghi đè.' : '';
            $('edit-movie-banner').value = isBannerBase64 ? '' : movie.bannerUrl || '';
            
            const savedGenres = (movie.genre || '').split(',').map(g => g.trim());
            document.querySelectorAll('#edit-genre-tag-container .genre-tag').forEach(tag => {
                tag.classList.toggle('selected', savedGenres.includes(tag.dataset.genre));
            });
            
            // NEW: Cập nhật nút xóa tất cả tập phim
            const deleteAllBtn = $('delete-all-episodes-btn');
            if (deleteAllBtn) {
                deleteAllBtn.onclick = () => window.handleDeleteAllEpisodes(movieId, movie.title);
            }
            
            showModal('edit-movie-modal');
        };

        window.showEditEpisodeModal = (movieId, episodeNumber) => {
            const movie = globalAdminMoviesCache.find(m => m.id === movieId);
            const episodeToEdit = (movie?.episodes || []).find(ep => ep.episodeNumber === episodeNumber);

            if (!episodeToEdit) {
                 window.showConfirmModal("Lỗi: Không tìm thấy tập phim để sửa.");
                 return;
            }
            
            $('edit-episode-movie-id').value = movieId;
            $('edit-episode-movie-title').textContent = movie.title;
            $('edit-episode-number-original').value = episodeToEdit.episodeNumber; 
            $('edit-episode-number').value = episodeToEdit.episodeNumber;
            $('edit-episode-title').value = episodeToEdit.title;
            $('edit-episode-url').value = episodeToEdit.videoUrl;
            $('edit-episode-form-message').textContent = '';
            
            showModal('edit-episode-modal');
        };

        const setupModalFormListeners = () => {
             // Render các nút chọn thể loại trong Modal (có dịch tiếng Việt)
            const genreContainers = document.querySelectorAll('#genre-tag-container, #edit-genre-tag-container');
            
            const genreButtonsHtml = ALL_GENRES.map(g => {
                const vietnameseName = GENRE_TRANSLATIONS[g] || g;
                return `<button type="button" class="genre-tag" data-genre="${g}">${g} <br><span class="text-[10px] text-gray-400 font-normal ml-1">(${vietnameseName})</span></button>`;
            }).join('');
            
            genreContainers.forEach(container => {
                container.innerHTML = genreButtonsHtml;
                container.addEventListener('click', function(e) {
                    const btn = e.target.closest('.genre-tag');
                    if (btn) {
                        btn.classList.toggle('selected');
                    }
                });
            });

            $('add-movie-form')?.addEventListener('submit', handleAddMovie);
            $('edit-movie-form')?.addEventListener('submit', handleEditMovie);
            $('add-episode-form')?.addEventListener('submit', handleAddEpisode);
            $('edit-episode-form')?.addEventListener('submit', handleEditEpisode);
            // Thêm listener cho form Bulk Add Episodes
            $('bulk-add-episode-form')?.addEventListener('submit', handleBulkAddEpisodes);
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            $('nav-dashboard')?.addEventListener('click', () => window.location.hash = '#dashboard');
            $('nav-schedule')?.addEventListener('click', () => window.location.hash = '#schedule');
            $('nav-profile')?.addEventListener('click', () => window.location.hash = '#profile');
            
            $('login-form')?.addEventListener('submit', handleLogin);
            
            setupModalFormListeners(); 
            
            window.addEventListener('hashchange', router);
        });
        
    </script>
</body>
</html>